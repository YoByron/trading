name: Health Monitor

# Continuous health monitoring for the trading system
# Runs every 15 minutes during market hours to catch issues early
# Created: Dec 11, 2025 (after zero-trade incident)

on:
  schedule:
    # Every 15 minutes during market hours (9:30 AM - 4:00 PM ET = 14:30 - 21:00 UTC)
    - cron: '*/15 14-21 * * 1-5'  # Mon-Fri, 2:30 PM - 9:00 PM UTC
  workflow_dispatch:  # Allow manual trigger

jobs:
  health-check:
    name: Trading System Health Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run Health Monitor
        id: health
        run: |
          echo "=== TRADING SYSTEM HEALTH CHECK ==="
          echo "Time: $(date -u)"
          echo ""

          python3 -m src.monitoring.health_monitor > health_result.json 2>&1 || true
          cat health_result.json

          # Check if healthy
          if python3 -c "import json; d=json.load(open('health_result.json')); exit(0 if d.get('healthy') else 1)" 2>/dev/null; then
            echo "âœ… System is healthy"
            echo "healthy=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ System has issues!"
            echo "healthy=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for No Trades Alert
        if: steps.health.outputs.healthy == 'false'
        run: |
          echo "ðŸš¨ HEALTH CHECK FAILED"
          echo ""
          echo "Possible issues:"
          echo "1. No trades executed today"
          echo "2. Syntax error in critical files"
          echo "3. Trading workflow failed"
          echo ""
          echo "See: rag_knowledge/lessons_learned/ll_009_ci_syntax_failure_dec11.md"

          # Don't fail the workflow, just alert
          # exit 1

      - name: Run Continuous Verifier
        if: steps.health.outputs.healthy == 'false'
        continue-on-error: true
        run: |
          pip install numpy -q
          python3 -m src.verification.continuous_verifier || true

      - name: Create Alert Issue (if critical)
        if: steps.health.outputs.healthy == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let healthData = {};
            try {
              healthData = JSON.parse(fs.readFileSync('health_result.json', 'utf8'));
            } catch (e) {
              healthData = {issues: [{type: 'unknown', message: 'Could not parse health data'}]};
            }

            // Check for critical issues
            const criticalIssues = (healthData.issues || []).filter(i => i.severity === 'critical');

            if (criticalIssues.length === 0) {
              console.log('No critical issues, skipping issue creation');
              return;
            }

            // Check if similar issue already exists today
            const today = new Date().toISOString().split('T')[0];
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'health-alert',
              state: 'open',
              per_page: 10,
            });

            const todayIssue = existingIssues.data.find(i =>
              i.title.includes(today) && i.title.includes('Health Alert')
            );

            if (todayIssue) {
              console.log(`Issue already exists for today: #${todayIssue.number}`);

              // Add comment instead
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: todayIssue.number,
                body: '## Health Check Update\n\n' +
                      'Time: ' + new Date().toISOString() + '\n\n' +
                      'Issues:\n' + criticalIssues.map(i => '- ' + i.type + ': ' + i.message).join('\n') +
                      '\n\n---\n*Automated health check*',
              });
              return;
            }

            // Create new issue
            const issueBody = '## Trading System Health Alert\n\n' +
              'Date: ' + today + '\n' +
              'Time: ' + new Date().toISOString() + '\n\n' +
              '### Critical Issues Detected\n\n' +
              criticalIssues.map(i => '- ' + i.type + ': ' + i.message).join('\n') + '\n\n' +
              '### Health Check Data\n\n' +
              '```json\n' + JSON.stringify(healthData, null, 2) + '\n```\n\n' +
              '### Recommended Actions\n\n' +
              '1. Check GitHub Actions workflow logs\n' +
              '2. Run `python3 -m src.verification.pre_merge_verifier`\n' +
              '3. Check `data/trades_' + today + '.json` exists\n' +
              '4. See: `rag_knowledge/lessons_learned/ll_009_ci_syntax_failure_dec11.md`\n\n' +
              '---\n*This issue was created automatically by the Health Monitor workflow.*';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Health Alert: ' + today + ' - ' + criticalIssues[0].type,
              body: issueBody,
              labels: ['health-alert', 'automated', 'critical'],
            });

            console.log('Created health alert issue');

  # Scheduled daemon run (less frequent, more thorough)
  daemon-check:
    name: Full Daemon Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: pip install numpy -q

      - name: Run Trading Daemon (Single Check)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== RUNNING FULL DAEMON CHECK ==="
          python3 -m src.monitoring.trading_daemon --once || true
