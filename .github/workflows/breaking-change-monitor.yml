name: Breaking Change Monitor

on:
  push:
    branches: [main]
  schedule:
    # Check every hour during trading hours (9 AM - 5 PM ET)
    - cron: '0 13-21 * * 1-5'
  workflow_dispatch:

# Monitor main branch for breaking changes
# Alert immediately if detected

jobs:
  detect-breaking-changes:
    name: üö® Detect Breaking Changes
    runs-on: ubuntu-22.04
    timeout-minutes: 5

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 10

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt

      - name: üîç Run breaking change detection
        id: detect
        continue-on-error: true
        run: |
          python3 scripts/detect_breaking_changes.py

      - name: üö® Create issue on breaking change
        if: steps.detect.outcome == 'failure'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "üö® BREAKING CHANGE DETECTED ON MAIN" \
            --body "**Breaking changes detected on main branch!**

          **Impact:** Trading operations may be broken

          **Action Required:**
          1. Review recent commits
          2. Identify breaking commit
          3. Either fix or revert immediately

          **Recent Commits:**
          \`\`\`
          $(git log -5 --oneline)
          \`\`\`

          **Detection Time:** $(date -u)

          **Assigned:** @${{ github.actor }}" \
            --label "critical,bug,trading-blocker" \
            --assignee "${{ github.actor }}"

          echo "::error::üö® Breaking change detected - Issue created"

      - name: ‚úÖ All clear
        if: steps.detect.outcome == 'success'
        run: |
          echo "‚úÖ No breaking changes detected"
          echo "Trading operations are functional"

  verify-trading-health:
    name: üè• Verify Trading Health
    runs-on: ubuntu-22.04
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python3 -m pip install -r requirements.txt

      - name: Test critical imports
        run: |
          python3 << 'EOF'
          import sys

          critical_imports = [
              "src.orchestrator.main",
              "src.safety.circuit_breaker",
              "src.safety.risk_manager",
              "src.strategies.base",
          ]

          failed = []
          for module in critical_imports:
              try:
                  __import__(module)
                  print(f"‚úÖ {module}")
              except Exception as e:
                  print(f"‚ùå {module}: {e}")
                  failed.append(module)

          if failed:
              print(f"\n‚ùå {len(failed)} critical imports FAILED")
              sys.exit(1)
          else:
              print(f"\n‚úÖ All {len(critical_imports)} critical imports OK")
          EOF
