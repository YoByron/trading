name: Strategy Validation

on:
  pull_request:
    paths:
      - 'src/strategies/**'
      - 'src/backtesting/**'
      - 'src/signals/**'
      - 'src/risk/**'
  push:
    branches:
      - main
    paths:
      - 'src/strategies/**'
      - 'src/backtesting/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-strategy:
    name: Validate Strategy Metrics
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy pandas yfinance alpaca-py pydantic

      - name: Initialize Strategy Registry
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          from src.strategies.registry import initialize_registry
          initialize_registry()
          print('‚úÖ Strategy registry initialized')
          "

      - name: Inspect Strategies
        run: |
          python scripts/inspect_strategies.py

      - name: Run Core Backtest
        id: backtest
        run: |
          # Run backtest and capture output
          python scripts/run_core_backtest.py --period 30 --ci 2>&1 | tee backtest_output.txt
          
          # Extract key metrics for PR comment
          if [ -f data/backtest_results/core_momentum_latest.json ]; then
            echo "metrics<<EOF" >> $GITHUB_OUTPUT
            cat data/backtest_results/core_momentum_latest.json >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Compare to Reference Backtest
        if: success()
        run: |
          if [ -f data/backtest_results/core_momentum_reference.json ]; then
            python scripts/run_core_backtest.py --compare
          else
            echo "No reference backtest found. Run with --save-reference to create one."
          fi
        continue-on-error: true

      - name: Check $100/Day Progress
        id: target_check
        run: |
          python -c "
          import json
          from pathlib import Path
          
          eval_file = Path('data/backtest_results/core_momentum_target_eval.json')
          if not eval_file.exists():
            print('No target evaluation found')
            exit(0)
          
          with open(eval_file) as f:
            data = json.load(f)
          
          metrics = data.get('evaluation', {}).get('target_metrics', {})
          avg_daily = metrics.get('average_daily_pnl', 0)
          target = metrics.get('target_daily_pnl', 100)
          progress = metrics.get('progress_to_target_pct', 0)
          hit_rate = metrics.get('pct_days_hit_target', 0)
          
          print('## \$100/Day Target Progress')
          print('')
          print(f'| Metric | Value |')
          print(f'|--------|-------|')
          print(f'| Average Daily P&L | \${avg_daily:.2f} |')
          print(f'| Target | \${target:.2f} |')
          print(f'| Progress | {progress:.1f}% |')
          print(f'| Days Above Target | {hit_rate:.1f}% |')
          "

      - name: Post PR Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let comment = '## üìä Strategy Validation Results\n\n';
            
            // Read backtest output
            try {
              const output = fs.readFileSync('backtest_output.txt', 'utf8');
              const lines = output.split('\n');
              
              // Extract key sections
              const inTargetSection = false;
              let targetSection = '';
              
              for (const line of lines) {
                if (line.includes('HOW CLOSE TO $100/DAY')) {
                  comment += '### üéØ $100/Day Target Analysis\n\n```\n';
                }
                if (line.includes('CI VALIDATION')) {
                  comment += '```\n\n### ‚úÖ CI Validation\n\n';
                }
                if (line.includes('PASSED') || line.includes('FAILED')) {
                  comment += `**${line.trim()}**\n\n`;
                }
              }
            } catch (e) {
              comment += '*Could not read backtest output*\n\n';
            }
            
            // Add metrics summary
            try {
              const metricsFile = 'data/backtest_results/core_momentum_latest.json';
              if (fs.existsSync(metricsFile)) {
                const metrics = JSON.parse(fs.readFileSync(metricsFile, 'utf8'));
                const r = metrics.results || {};
                const t = metrics.target_evaluation?.target_metrics || {};
                
                comment += '### üìà Key Metrics\n\n';
                comment += '| Metric | Value |\n';
                comment += '|--------|-------|\n';
                comment += `| Sharpe Ratio | ${(r.sharpe_ratio || 0).toFixed(2)} |\n`;
                comment += `| Win Rate | ${(r.win_rate || 0).toFixed(1)}% |\n`;
                comment += `| Max Drawdown | ${(r.max_drawdown_pct || 0).toFixed(1)}% |\n`;
                comment += `| Avg Daily P&L | $${(t.average_daily_pnl || 0).toFixed(2)} |\n`;
                comment += `| $100/Day Progress | ${(t.progress_to_target_pct || 0).toFixed(1)}% |\n`;
              }
            } catch (e) {
              comment += '*Could not read metrics file*\n\n';
            }
            
            comment += '\n---\n*Generated by Strategy Validation workflow*';
            
            // Post comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: backtest-results
          path: data/backtest_results/
          retention-days: 30

      - name: Final Status
        run: |
          if [ -f data/backtest_results/core_momentum_latest.json ]; then
            echo "‚úÖ Strategy validation complete"
            cat data/backtest_results/core_momentum_latest.json | python -c "import sys,json; d=json.load(sys.stdin); print(f\"Validation: {'PASSED' if d.get('validation',{}).get('passed') else 'FAILED'}\")"
          else
            echo "‚ö†Ô∏è No backtest results generated"
          fi
