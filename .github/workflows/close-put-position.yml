name: Close Short Put Position

# CEO DIRECTIVE: "We are not allowed to lose money!!!!!"
# CLOSE the losing put position IMMEDIATELY

on:
  workflow_dispatch:
    inputs:
      symbol:
        description: "Option symbol to close"
        required: true
        default: "SOFI260206P00024000"
      quantity:
        description: "Contracts to close"
        required: true
        default: "2"

permissions:
  contents: write

jobs:
  close-put:
    name: Buy-to-Close Short Put
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install alpaca-py

      - name: Close Position
        id: close
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_SECRET }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          from datetime import datetime
          from alpaca.trading.client import TradingClient
          from alpaca.trading.requests import MarketOrderRequest
          from alpaca.trading.enums import OrderSide, TimeInForce

          api_key = os.environ['ALPACA_API_KEY']
          secret_key = os.environ['ALPACA_SECRET_KEY']
          symbol = "${{ github.event.inputs.symbol }}"
          qty = int("${{ github.event.inputs.quantity }}")

          print("=" * 60)
          print("RULE #1 PROTECTION: CLOSING LOSING PUT POSITION")
          print("=" * 60)
          print(f"   Symbol: {symbol}")
          print(f"   Quantity: {qty} contracts")
          print(f"   Action: BUY TO CLOSE")
          print(f"   Timestamp: {datetime.now().isoformat()}")
          print("=" * 60)

          client = TradingClient(api_key, secret_key, paper=True)

          # Get account status
          account = client.get_account()
          print(f"\n   Account Equity: ${float(account.equity):,.2f}")
          print(f"   Account Cash: ${float(account.cash):,.2f}")

          # Get current positions
          positions = client.get_all_positions()
          put_found = False
          for pos in positions:
              if symbol in pos.symbol:
                  put_found = True
                  print(f"\n   Current Put Position:")
                  print(f"   - Symbol: {pos.symbol}")
                  print(f"   - Qty: {pos.qty}")
                  print(f"   - Current Price: ${float(pos.current_price):.2f}")
                  print(f"   - Unrealized P/L: ${float(pos.unrealized_pl):.2f}")
                  break

          if not put_found:
              print(f"\n   No position found for {symbol}")
              print("   Position may have already been closed")
              exit(0)

          # Check market
          clock = client.get_clock()
          print(f"\n   Market Open: {clock.is_open}")

          # Submit buy-to-close order
          print(f"\n   Submitting BUY TO CLOSE order...")
          order_request = MarketOrderRequest(
              symbol=symbol,
              qty=qty,
              side=OrderSide.BUY,  # BUY to close short position
              time_in_force=TimeInForce.DAY
          )

          order = client.submit_order(order_request)

          print(f"\n   ORDER SUBMITTED!")
          print(f"   Order ID: {order.id}")
          print(f"   Status: {order.status}")
          print(f"   Side: {order.side}")
          print("=" * 60)
          print("   RULE #1 PROTECTION EXECUTED!")
          print("   Losing put position is being closed")
          print("=" * 60)

          # Output for GitHub Actions
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"order_id={order.id}\n")
              f.write(f"status={order.status}\n")
          PYTHON_SCRIPT

      - name: Update State
        if: success()
        run: |
          echo "Put position closed successfully!"
          echo "Order ID: ${{ steps.close.outputs.order_id }}"

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "CLOSE PUT POSITION SUMMARY"
          echo "=========================================="
          echo "Symbol: ${{ github.event.inputs.symbol }}"
          echo "Quantity: ${{ github.event.inputs.quantity }}"
          echo "Order ID: ${{ steps.close.outputs.order_id }}"
          echo "Status: ${{ steps.close.outputs.status }}"
          echo "=========================================="
