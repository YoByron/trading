name: Close Short Put Position

# CEO DIRECTIVE: "We are not allowed to lose money!!!!!"
# CLOSE the losing put position IMMEDIATELY

on:
  workflow_dispatch:
    inputs:
      symbol:
        description: "Option symbol to close (EXACT match required)"
        required: true
        default: "SPY260220P00653000"
      quantity:
        description: "Contracts to close"
        required: true
        default: "1"
      action:
        description: "Order action (BUY to close short, SELL to close long)"
        required: true
        default: "SELL"
        type: choice
        options:
          - "BUY"
          - "SELL"

permissions:
  contents: write

jobs:
  close-put:
    name: Close Option Position
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install alpaca-py

      - name: Close Position
        id: close
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_SECRET }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          from datetime import datetime
          from alpaca.trading.client import TradingClient
          from alpaca.trading.requests import MarketOrderRequest
          from alpaca.trading.enums import OrderSide, TimeInForce

          api_key = os.environ['ALPACA_API_KEY']
          secret_key = os.environ['ALPACA_SECRET_KEY']
          symbol = "${{ github.event.inputs.symbol }}"
          qty = int("${{ github.event.inputs.quantity }}")
          action = "${{ github.event.inputs.action }}"

          print("=" * 60)
          print("RULE #1 PROTECTION: CLOSING OPTION POSITION")
          print("=" * 60)
          print(f"   Symbol: {symbol}")
          print(f"   Quantity: {qty}")
          print(f"   Action: {action}")
          print(f"   Timestamp: {datetime.now().isoformat()}")
          print("=" * 60)

          client = TradingClient(api_key, secret_key, paper=True)

          # Get account status
          account = client.get_account()
          print(f"\n   Account Equity: ${float(account.equity):,.2f}")
          print(f"   Buying Power: ${float(account.buying_power):,.2f}")

          # Get current positions - EXACT MATCH ONLY
          positions = client.get_all_positions()
          target_position = None
          print(f"\n   Current Positions:")
          for pos in positions:
              print(f"   - {pos.symbol} qty={pos.qty}")
              # FIX: Use EXACT match, not substring
              if pos.symbol == symbol:
                  target_position = pos
                  print(f"\n   ✅ TARGET FOUND: {pos.symbol}")
                  print(f"      Qty: {pos.qty}")
                  print(f"      Current Price: ${float(pos.current_price):.2f}")
                  print(f"      Unrealized P/L: ${float(pos.unrealized_pl):.2f}")

          if not target_position:
              print(f"\n   ❌ ERROR: No position with EXACT symbol '{symbol}'")
              print("   Available option positions:")
              for pos in positions:
                  if len(pos.symbol) > 10:  # Options have long symbols
                      print(f"      {pos.symbol}")
              exit(1)

          # Check market
          clock = client.get_clock()
          print(f"\n   Market Open: {clock.is_open}")

          if not clock.is_open:
              print("   ❌ ERROR: Market is closed")
              exit(1)

          # Submit order with user-specified action
          print(f"\n   Submitting {action} order for {qty} contracts...")
          
          order_side = OrderSide.BUY if action == "BUY" else OrderSide.SELL
          
          order_request = MarketOrderRequest(
              symbol=symbol,
              qty=qty,
              side=order_side,
              time_in_force=TimeInForce.DAY
          )

          try:
              order = client.submit_order(order_request)
              print(f"\n   ✅ ORDER SUBMITTED!")
              print(f"   Order ID: {order.id}")
              print(f"   Status: {order.status}")
              print("=" * 60)
              
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"order_id={order.id}\n")
                  f.write(f"status={order.status}\n")
          except Exception as e:
              print(f"\n   ❌ ERROR: {e}")
              exit(1)
          PYTHON_SCRIPT

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "CLOSE POSITION SUMMARY"
          echo "=========================================="
          echo "Symbol: ${{ github.event.inputs.symbol }}"
          echo "Quantity: ${{ github.event.inputs.quantity }}"
          echo "Action: ${{ github.event.inputs.action }}"
          echo "Order ID: ${{ steps.close.outputs.order_id }}"
          echo "Status: ${{ steps.close.outputs.status }}"
          echo "=========================================="
