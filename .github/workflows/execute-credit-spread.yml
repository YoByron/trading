name: Execute Credit Spread

on:
  schedule:
    # Run at 9:35 AM ET on weekdays (covers EST/EDT)
    - cron: '35 13,14 * * 1-5'
  workflow_dispatch:
    inputs:
      symbol:
        description: "Underlying symbol (F, SOFI, T)"
        required: true
        default: "SOFI"
        type: choice
        options:
          - F
          - SOFI
          - T
      spread_width:
        description: "Spread width in dollars"
        required: true
        default: "5"
      quantity:
        description: "Number of spreads"
        required: true
        default: "1"

env:
  ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_KEY }}
  ALPACA_API_SECRET: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_SECRET }}
  ALPACA_BASE_URL: "https://paper-api.alpaca.markets"

jobs:
  execute-spread:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install alpaca-py requests

      - name: Execute Bull Put Credit Spread
        env:
          INPUT_SYMBOL: ${{ inputs.symbol || 'SOFI' }}
          INPUT_SPREAD_WIDTH: ${{ inputs.spread_width || '5' }}
          INPUT_QUANTITY: ${{ inputs.quantity || '1' }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import json
          from datetime import datetime, timedelta
          from alpaca.trading.client import TradingClient
          from alpaca.trading.enums import OrderSide, TimeInForce, OrderType
          from alpaca.data.historical import StockHistoricalDataClient
          from alpaca.data.requests import StockLatestQuoteRequest

          # Config from environment
          symbol = os.environ.get("INPUT_SYMBOL", "SOFI")
          spread_width = int(os.environ.get("INPUT_SPREAD_WIDTH", "5"))
          quantity = int(os.environ.get("INPUT_QUANTITY", "1"))

          print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
          print("ðŸ“Š CREDIT SPREAD EXECUTION")
          print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
          print(f"Symbol: {symbol}")
          print(f"Spread Width: ${spread_width}")
          print(f"Quantity: {quantity}")
          print()

          # Initialize clients
          api_key = os.environ["ALPACA_API_KEY"]
          api_secret = os.environ["ALPACA_API_SECRET"]

          trading_client = TradingClient(api_key, api_secret, paper=True)
          data_client = StockHistoricalDataClient(api_key, api_secret)

          # Get account info
          account = trading_client.get_account()
          print(f"Account Equity: ${float(account.equity):,.2f}")
          print(f"Buying Power: ${float(account.buying_power):,.2f}")
          print()

          # Calculate collateral needed
          collateral_needed = spread_width * 100 * quantity
          print(f"Collateral Needed: ${collateral_needed}")

          if float(account.buying_power) < collateral_needed:
              print(f"âŒ Insufficient buying power!")
              print(f"   Need: ${collateral_needed}, Have: ${float(account.buying_power):,.2f}")
              exit(1)

          # Step 1: Get current stock price
          print()
          print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
          print("ðŸ“ˆ GETTING CURRENT PRICE")
          print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")

          try:
              quote_request = StockLatestQuoteRequest(symbol_or_symbols=symbol)
              quote = data_client.get_stock_latest_quote(quote_request)
              current_price = float(quote[symbol].ask_price)
              print(f"Current {symbol} price: ${current_price:.2f}")
          except Exception as e:
              print(f"Error getting quote: {e}")
              # Fallback prices
              fallback = {"F": 10.0, "SOFI": 15.0, "T": 22.0}
              current_price = fallback.get(symbol, 15.0)
              print(f"Using fallback price: ${current_price:.2f}")

          # Step 2: Query available options
          print()
          print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
          print("ðŸ” DISCOVERING AVAILABLE OPTIONS")
          print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")

          from alpaca.trading.requests import GetOptionContractsRequest
          from alpaca.trading.enums import AssetStatus, ContractType

          # Find expiration 7-14 days out
          today = datetime.now()
          min_expiry = (today + timedelta(days=3)).strftime("%Y-%m-%d")
          max_expiry = (today + timedelta(days=21)).strftime("%Y-%m-%d")

          try:
              req = GetOptionContractsRequest(
                  underlying_symbols=[symbol],
                  status=AssetStatus.ACTIVE,
                  expiration_date_gte=min_expiry,
                  expiration_date_lte=max_expiry,
                  type=ContractType.PUT,
              )
              contracts = trading_client.get_option_contracts(req)

              if not contracts.option_contracts:
                  print(f"âŒ No put options found for {symbol}")
                  print(f"   Date range: {min_expiry} to {max_expiry}")
                  exit(1)

              puts = contracts.option_contracts
              print(f"Found {len(puts)} put options")

              # Group by expiration
              by_expiry = {}
              for p in puts:
                  exp = str(p.expiration_date)
                  if exp not in by_expiry:
                      by_expiry[exp] = []
                  by_expiry[exp].append(p)

              # Pick nearest expiration with enough strikes
              sorted_expiries = sorted(by_expiry.keys())
              target_expiry = None
              for exp in sorted_expiries:
                  if len(by_expiry[exp]) >= 4:  # Need at least 4 strikes for spread
                      target_expiry = exp
                      break

              if not target_expiry:
                  target_expiry = sorted_expiries[0]

              available_puts = by_expiry[target_expiry]
              strikes = sorted(set(float(p.strike_price) for p in available_puts))

              print(f"Using expiration: {target_expiry}")
              print(f"Available strikes: {strikes}")

              # Step 3: Find ATM short strike (closest to current price, at or below)
              atm_strikes = [s for s in strikes if s <= current_price]
              if not atm_strikes:
                  atm_strikes = strikes  # Use all if none below

              short_strike = max(atm_strikes)  # Highest strike at or below current price

              # Step 4: Find long strike (spread_width below short)
              target_long = short_strike - spread_width
              long_strike = min(strikes, key=lambda x: abs(x - target_long))

              # Ensure long is below short
              if long_strike >= short_strike:
                  available_longs = [s for s in strikes if s < short_strike]
                  if available_longs:
                      long_strike = max(available_longs)
                  else:
                      print(f"âŒ Cannot find valid long strike below {short_strike}")
                      exit(1)

              actual_width = short_strike - long_strike

              # Get contract symbols
              short_contract = next((p for p in available_puts if float(p.strike_price) == short_strike), None)
              long_contract = next((p for p in available_puts if float(p.strike_price) == long_strike), None)

              if not short_contract or not long_contract:
                  print(f"âŒ Could not find contracts for strikes {short_strike}/{long_strike}")
                  exit(1)

              short_symbol = short_contract.symbol
              long_symbol = long_contract.symbol

              print()
              print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
              print("ðŸ“‹ SPREAD DETAILS")
              print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
              print(f"Current Price: ${current_price:.2f}")
              print(f"Expiration: {target_expiry}")
              print(f"Short Put (SELL): {short_symbol} @ ${short_strike}")
              print(f"Long Put (BUY): {long_symbol} @ ${long_strike}")
              print(f"Spread Width: ${actual_width}")
              print(f"Max Loss: ${actual_width * 100 * quantity}")

          except Exception as e:
              print(f"âŒ Error discovering options: {e}")
              import traceback
              traceback.print_exc()
              exit(1)

          # Step 5: Execute the spread
          print()
          print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
          print("ðŸš€ EXECUTING ORDERS")
          print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")

          try:
              # Sell the short put (collect premium)
              print(f"Selling {quantity} x {short_symbol}...")
              short_order = trading_client.submit_order(
                  symbol=short_symbol,
                  qty=quantity,
                  side=OrderSide.SELL,
                  type=OrderType.MARKET,
                  time_in_force=TimeInForce.DAY
              )
              print(f"âœ… Short put order submitted: {short_order.id}")
              print(f"   Status: {short_order.status}")

              # Buy the long put (protection)
              print(f"Buying {quantity} x {long_symbol}...")
              long_order = trading_client.submit_order(
                  symbol=long_symbol,
                  qty=quantity,
                  side=OrderSide.BUY,
                  type=OrderType.MARKET,
                  time_in_force=TimeInForce.DAY
              )
              print(f"âœ… Long put order submitted: {long_order.id}")
              print(f"   Status: {long_order.status}")

              print()
              print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
              print("âœ… CREDIT SPREAD EXECUTED SUCCESSFULLY!")
              print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
              print(f"Strategy: Bull Put Spread on {symbol}")
              print(f"Expiration: {target_expiry}")
              print(f"Short: ${short_strike} | Long: ${long_strike}")
              print(f"Width: ${actual_width} | Qty: {quantity}")

          except Exception as e:
              print(f"âŒ Error executing spread: {e}")
              import traceback
              traceback.print_exc()
              exit(1)

          PYTHON_SCRIPT

      - name: Record trade in system state
        if: success()
        run: |
          echo "Credit spread executed at $(date)"
