name: Execute Credit Spread

on:
  schedule:
    # Run at 9:35 AM ET on weekdays (covers EST/EDT)
    - cron: '35 13,14 * * 1-5'
  workflow_dispatch:
    inputs:
      symbol:
        description: "Underlying symbol (SPY/IWM per $100K success)"
        required: true
        default: "SPY"
        type: choice
        options:
          - SPY
          - IWM
      spread_width:
        description: "Spread width in dollars (CLAUDE.md: $3)"
        required: true
        default: "3"
      quantity:
        description: "Number of spreads"
        required: true
        default: "1"

env:
  ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_KEY }}
  ALPACA_API_SECRET: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_SECRET }}
  ALPACA_BASE_URL: "https://paper-api.alpaca.markets"

jobs:
  execute-spread:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install alpaca-py requests

      # ===== NEW: CALENDAR VALIDATION (LL-240 fix) =====
      - name: Validate Trading Day
        id: calendar_check
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_KEY }}
          ALPACA_API_SECRET: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_SECRET }}
        run: |
          python3 << 'CALENDAR_EOF'
          import os
          from datetime import date
          from alpaca.trading.client import TradingClient
          from alpaca.trading.requests import GetCalendarRequest

          client = TradingClient(
              os.environ['ALPACA_API_KEY'],
              os.environ['ALPACA_API_SECRET'],
              paper=True
          )

          today = date.today()
          calendar_request = GetCalendarRequest(start=today, end=today)
          calendar = client.get_calendar(calendar_request)

          if not calendar:
              print(f"::notice::{today} is NOT a trading day (holiday/weekend)")
              print("skip=true >> $GITHUB_OUTPUT")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("skip=true\n")
          else:
              print(f"âœ… {today} is a valid trading day")
              print(f"   Market opens: {calendar[0].open}")
              print(f"   Market closes: {calendar[0].close}")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("skip=false\n")
          CALENDAR_EOF

      # ===== NEW: POSITION COMPLIANCE CHECK (LL-240 fix) =====
      - name: Check Position Compliance
        id: compliance_check
        if: steps.calendar_check.outputs.skip != 'true'
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_KEY }}
          ALPACA_API_SECRET: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_SECRET }}
        run: |
          python3 << 'COMPLIANCE_EOF'
          import os
          from alpaca.trading.client import TradingClient

          client = TradingClient(
              os.environ['ALPACA_API_KEY'],
              os.environ['ALPACA_API_SECRET'],
              paper=True
          )

          account = client.get_account()
          equity = float(account.equity)
          positions = client.get_all_positions()

          # Calculate current exposure
          total_risk = 0
          option_positions = [p for p in positions if len(p.symbol) > 10]  # Options have longer symbols

          print(f"Account Equity: ${equity:.2f}")
          print(f"5% Position Limit: ${equity * 0.05:.2f}")
          print(f"15% Total Limit: ${equity * 0.15:.2f}")
          print(f"Current option positions: {len(option_positions)}")

          # Estimate risk (simplified: count spreads * $500 max)
          spread_count = len(option_positions) // 2
          estimated_risk = spread_count * 500
          risk_pct = (estimated_risk / equity) * 100

          print(f"Estimated current risk: ${estimated_risk} ({risk_pct:.1f}%)")

          # CLAUDE.md rule: max 15% total exposure
          MAX_EXPOSURE_PCT = 15
          if risk_pct > MAX_EXPOSURE_PCT:
              print(f"::error::COMPLIANCE VIOLATION: {risk_pct:.1f}% exposure exceeds {MAX_EXPOSURE_PCT}% limit")
              print(f"::error::Cannot open new positions until exposure is reduced")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("compliant=false\n")
              exit(1)
          else:
              print(f"âœ… Position compliance OK ({risk_pct:.1f}% < {MAX_EXPOSURE_PCT}%)")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("compliant=true\n")
          COMPLIANCE_EOF

      - name: Execute Bull Put Credit Spread
        if: steps.calendar_check.outputs.skip != 'true' && steps.compliance_check.outputs.compliant == 'true'
        env:
          SYMBOL: ${{ inputs.symbol || 'SPY' }}
          SPREAD_WIDTH: ${{ inputs.spread_width || '3' }}
          QUANTITY: ${{ inputs.quantity || '1' }}
        run: |
          python3 << 'TRADE_EOF'
          import os
          import json
          from datetime import datetime, timedelta
          from alpaca.trading.client import TradingClient
          from alpaca.trading.requests import LimitOrderRequest
          from alpaca.trading.enums import OrderSide, TimeInForce, OrderClass

          # Get parameters
          symbol = os.environ.get('SYMBOL', 'SPY')
          spread_width = int(os.environ.get('SPREAD_WIDTH', '3'))
          quantity = int(os.environ.get('QUANTITY', '1'))

          print(f"=== Executing {symbol} Bull Put Credit Spread ===")
          print(f"Spread width: ${spread_width}")
          print(f"Quantity: {quantity}")

          client = TradingClient(
              os.environ['ALPACA_API_KEY'],
              os.environ['ALPACA_API_SECRET'],
              paper=True
          )

          # Get account info
          account = client.get_account()
          print(f"Account equity: ${account.equity}")
          print(f"Buying power: ${account.buying_power}")

          # TODO: Implement actual spread execution
          # This is a placeholder - need to:
          # 1. Get current price of underlying
          # 2. Calculate 30-delta strike
          # 3. Find appropriate expiration (30-45 DTE)
          # 4. Submit multi-leg order

          print("::warning::Trade execution not yet implemented - placeholder only")
          TRADE_EOF

      # ===== FAILURE NOTIFICATION VIA GITHUB ISSUE =====
      - name: Create Alert on Failure
        if: failure()
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = 'ðŸš¨ ALERT: Credit Spread Execution Failed';
            const body = `## CRITICAL Alert - Trade Failure

            **Timestamp**: ${new Date().toISOString()}
            **Symbol**: ${{ inputs.symbol || 'SPY' }}
            **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ---

            The credit spread execution workflow failed. Check the logs for details.

            **Possible causes:**
            - Position compliance violation (>15% exposure)
            - Market closed / not a trading day
            - API connection issues
            - Insufficient buying power

            ---

            *Automated alert from execute-credit-spread.yml*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['alert', 'critical', 'trade-failure', 'automated']
            });
            console.log('Alert issue created');
