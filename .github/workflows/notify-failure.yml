name: Notify on Critical Failure

# Reusable workflow for failure notifications
# Supports GitHub Issues (always) and Slack (if configured)

on:
  workflow_call:
    inputs:
      title:
        description: "Alert title"
        required: true
        type: string
      body:
        description: "Alert body/description"
        required: true
        type: string
      severity:
        description: "Severity level (critical/high/medium)"
        required: false
        default: "high"
        type: string
      labels:
        description: "Comma-separated labels"
        required: false
        default: "alert,automated"
        type: string
    secrets:
      SLACK_WEBHOOK_URL:
        required: false

permissions:
  contents: read
  issues: write

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `${{ inputs.title }}`;
            const body = `${{ inputs.body }}`;
            const severity = '${{ inputs.severity }}';
            const labelStr = '${{ inputs.labels }}';
            const labels = labelStr.split(',').map(l => l.trim());

            // Add severity emoji to title
            const severityEmoji = {
              'critical': 'üö®',
              'high': '‚ö†Ô∏è',
              'medium': 'üì¢'
            };
            const emoji = severityEmoji[severity] || 'üì¢';
            const fullTitle = `${emoji} ${title}`;

            // Check for existing open issue with same title
            const { data: existingIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: labels.join(','),
              per_page: 10
            });

            const existingIssue = existingIssues.find(i => i.title.includes(title));

            if (existingIssue) {
              // Comment on existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `### New occurrence at ${new Date().toISOString()}\n\n${body}`
              });
              console.log(`Commented on existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const { data: newIssue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: fullTitle,
                body: `## Alert Details\n\n${body}\n\n---\n**Severity:** ${severity}\n**Generated:** ${new Date().toISOString()}\n**Workflow:** ${{ github.workflow }}\n**Run ID:** ${{ github.run_id }}`,
                labels: labels
              });
              console.log(`Created new issue #${newIssue.number}`);
            }

      - name: Send Slack Notification
        if: ${{ env.SLACK_URL != '' }}
        env:
          SLACK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_URL" ]; then
            SEVERITY="${{ inputs.severity }}"
            EMOJI="‚ö†Ô∏è"
            COLOR="warning"

            if [ "$SEVERITY" = "critical" ]; then
              EMOJI="üö®"
              COLOR="danger"
            elif [ "$SEVERITY" = "medium" ]; then
              EMOJI="üì¢"
              COLOR="good"
            fi

            curl -s -X POST "$SLACK_URL" \
              -H "Content-Type: application/json" \
              -d "{
                \"attachments\": [{
                  \"color\": \"$COLOR\",
                  \"title\": \"$EMOJI ${{ inputs.title }}\",
                  \"text\": \"${{ inputs.body }}\",
                  \"footer\": \"GitHub Actions | Run: ${{ github.run_id }}\",
                  \"ts\": $(date +%s)
                }]
              }"
            echo "Slack notification sent"
          else
            echo "SLACK_WEBHOOK_URL not configured, skipping Slack notification"
          fi
