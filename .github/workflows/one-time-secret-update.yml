name: One-Time Secret Update

# ONE-TIME FIX: Update Alpaca secrets to $30K account
# This workflow reads credentials from UPDATE_SECRETS.json and updates GitHub secrets
# After running, the trigger file is deleted for security

on:
  push:
    paths:
      - 'UPDATE_SECRETS.json'

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests pynacl alpaca-py

      - name: Read and verify credentials
        id: creds
        run: |
          python3 << 'EOF'
          import json
          import os
          from alpaca.trading.client import TradingClient

          with open('UPDATE_SECRETS.json', 'r') as f:
              creds = json.load(f)

          api_key = creds['api_key']
          api_secret = creds['api_secret']

          # Verify credentials work
          client = TradingClient(api_key, api_secret, paper=True)
          account = client.get_account()
          print(f"✅ Verified! Account equity: ${float(account.equity):,.2f}")

          # Set outputs for next step
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"api_key={api_key}\n")
              f.write(f"api_secret={api_secret}\n")
          EOF

      - name: Update GitHub secrets
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          NEW_API_KEY: ${{ steps.creds.outputs.api_key }}
          NEW_API_SECRET: ${{ steps.creds.outputs.api_secret }}
        run: |
          python3 << 'EOF'
          import os
          import requests
          from base64 import b64decode, b64encode
          from nacl import public

          def encrypt_secret(public_key: str, secret_value: str) -> str:
              public_key_bytes = b64decode(public_key)
              sealed_box = public.SealedBox(public.PublicKey(public_key_bytes))
              encrypted = sealed_box.encrypt(secret_value.encode("utf-8"))
              return b64encode(encrypted).decode("utf-8")

          def update_secret(secret_name: str, secret_value: str):
              token = os.environ["GH_PAT"]
              repo = "IgorGanapolsky/trading"
              headers = {
                  "Authorization": f"token {token}",
                  "Accept": "application/vnd.github+json",
              }
              key_resp = requests.get(
                  f"https://api.github.com/repos/{repo}/actions/secrets/public-key",
                  headers=headers
              )
              key_data = key_resp.json()
              encrypted = encrypt_secret(key_data["key"], secret_value)
              resp = requests.put(
                  f"https://api.github.com/repos/{repo}/actions/secrets/{secret_name}",
                  headers=headers,
                  json={"encrypted_value": encrypted, "key_id": key_data["key_id"]}
              )
              print(f"Updated {secret_name}: {resp.status_code}")

          update_secret("ALPACA_PAPER_TRADING_30K_API_KEY", os.environ["NEW_API_KEY"])
          update_secret("ALPACA_PAPER_TRADING_30K_API_SECRET", os.environ["NEW_API_SECRET"])
          print("✅ All secrets updated to $30K account!")
          EOF

      - name: Delete credentials file and trigger trading
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          # Delete the credentials file for security
          rm -f UPDATE_SECRETS.json
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: Remove temporary credentials file [auto]" || true
          git push

          # Trigger daily trading workflow
          curl -X POST \
            -H "Authorization: token $GH_PAT" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/IgorGanapolsky/trading/actions/workflows/daily-trading.yml/dispatches" \
            -d '{"ref":"main","inputs":{"trading_mode":"paper","force_trade":"true"}}'
          echo "✅ Triggered daily trading!"
