name: Code Hygiene Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  hygiene-check:
    runs-on: ubuntu-latest
    name: Verify Code Hygiene

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ruff
        run: pip install ruff

      - name: Check for forbidden temporary files
        run: |
          echo "Checking for temporary/proof files..."
          FOUND=0

          # Check for .ai_proof* files
          if ls .ai_proof*.md 2>/dev/null; then
            echo "ERROR: Found .ai_proof*.md files - these should not be committed"
            FOUND=1
          fi

          # Check for *_summary* hidden files
          if ls .*_summary*.md 2>/dev/null; then
            echo "ERROR: Found hidden summary files - these should not be committed"
            FOUND=1
          fi

          # Check for debug scripts in root
          if ls debug_*.py 2>/dev/null; then
            echo "ERROR: Found debug scripts - these should not be committed"
            FOUND=1
          fi

          if [ $FOUND -eq 1 ]; then
            exit 1
          fi
          echo "No forbidden files found"

      - name: Check for archive directories
        run: |
          if [ -d "docs/_archive" ]; then
            echo "ERROR: docs/_archive directory exists - should be deleted"
            exit 1
          fi
          if [ -d "test_logs" ]; then
            echo "ERROR: test_logs directory exists - should be deleted"
            exit 1
          fi
          echo "No forbidden directories found"

      - name: Check for __pycache__ directories
        run: |
          PYCACHE_COUNT=$(find . -name "__pycache__" -type d | grep -v ".git" | wc -l)
          if [ $PYCACHE_COUNT -gt 0 ]; then
            echo "ERROR: Found $PYCACHE_COUNT __pycache__ directories"
            find . -name "__pycache__" -type d | grep -v ".git"
            echo "Add __pycache__ to .gitignore and remove these directories"
            exit 1
          fi
          echo "No __pycache__ directories found"

      - name: Check for unused imports (ruff F401)
        run: |
          echo "Checking for unused imports..."
          ruff check --select F401 src/ scripts/ --output-format=concise || {
            echo ""
            echo "Fix with: ruff check --select F401 --fix src/ scripts/"
            exit 1
          }

      - name: Check for unused variables (ruff F841)
        run: |
          echo "Checking for unused variables..."
          # Only fail on fixable issues
          ruff check --select F841 src/ scripts/ --output-format=concise 2>&1 | grep -c "\[\*\]" > /tmp/fixable || true
          FIXABLE=$(cat /tmp/fixable)
          if [ "$FIXABLE" -gt 0 ]; then
            echo "Found $FIXABLE auto-fixable unused variable issues"
            ruff check --select F841 src/ scripts/ --output-format=concise | grep "\[\*\]"
            echo ""
            echo "Fix with: ruff check --select F841 --fix src/ scripts/"
            exit 1
          fi
          echo "No auto-fixable unused variable issues"

      - name: Hygiene check passed
        run: echo "All code hygiene checks passed!"
