# Vertex AI RAG Pre-Trade Query Workflow
#
# CEO Directive (Jan 7, 2026): "We need to LEARN from Vertex AI RAG BEFORE trades!"
#
# This workflow implements BIDIRECTIONAL learning:
# - WRITE: sync_trades_to_rag.py (post-trade sync)
# - READ: query_vertex_rag.py (pre-trade learning) <- THIS WORKFLOW
#
# Architecture based on 2026 best practices:
# - Gemini 2.0 Flash for grounded generation
# - Hybrid search (semantic + keyword)
# - Query-first decision making pattern
# - Check Grounding API for validation
#
# Reference: https://docs.cloud.google.com/vertex-ai/generative-ai/docs/rag-engine/rag-overview

name: Vertex AI RAG Pre-Trade Query

on:
  # Trigger before daily trading
  workflow_call:
    inputs:
      symbols:
        description: 'Comma-separated symbols to query advice for'
        required: false
        type: string
        default: 'SPY,SOFI,PLTR,AMD'
    outputs:
      advice_file:
        description: 'Path to the generated advice file'
        value: ${{ jobs.query-rag.outputs.advice_file }}
      has_warnings:
        description: 'Whether critical warnings were found'
        value: ${{ jobs.query-rag.outputs.has_warnings }}

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      symbols:
        description: 'Comma-separated symbols to query advice for'
        required: false
        default: 'SPY,SOFI,PLTR,AMD'
      custom_query:
        description: 'Custom query (optional)'
        required: false
        default: ''

  # Trigger on push to RAG-related files (for testing)
  push:
    paths:
      - 'scripts/query_vertex_rag.py'
      - 'src/rag/vertex_rag.py'
      - '.github/workflows/vertex-rag-pretrade.yml'

env:
  PYTHON_VERSION: '3.11'

jobs:
  query-rag:
    name: Query Vertex AI RAG for Pre-Trade Advice
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      advice_file: ${{ steps.query.outputs.advice_file }}
      has_warnings: ${{ steps.analyze.outputs.has_warnings }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-cloud-aiplatform vertexai
          pip install -r requirements-minimal.txt

      - name: Authenticate with GCP
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          echo "Setting up GCP authentication..."
          if [ -n "$GCP_SA_KEY" ]; then
            echo "$GCP_SA_KEY" > /tmp/gcp_sa_key.json
            export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp_sa_key.json
            echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp_sa_key.json" >> $GITHUB_ENV

            # Extract project ID from SA key
            PROJECT_ID=$(python3 -c "import json; print(json.loads('''$GCP_SA_KEY''').get('project_id', 'igor-trading-2025-v2'))")
            echo "GOOGLE_CLOUD_PROJECT=$PROJECT_ID" >> $GITHUB_ENV
            echo "Authenticated with project: $PROJECT_ID"
          else
            echo "::warning::GCP_SA_KEY not set - RAG query may fail"
          fi

      - name: Query Vertex AI RAG
        id: query
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          echo "=" * 70
          echo "VERTEX AI RAG PRE-TRADE QUERY"
          echo "=" * 70
          echo ""
          echo "Symbols: ${{ inputs.symbols || 'SPY,SOFI,PLTR,AMD' }}"
          echo ""

          # Parse symbols into arguments
          SYMBOL_ARGS=""
          IFS=',' read -ra SYMBOLS <<< "${{ inputs.symbols || 'SPY,SOFI,PLTR,AMD' }}"
          for symbol in "${SYMBOLS[@]}"; do
            SYMBOL_ARGS="$SYMBOL_ARGS --symbol $symbol"
          done

          # Run query script
          python3 scripts/query_vertex_rag.py $SYMBOL_ARGS --json --output data/rag_pretrade_advice.json || {
            echo "::warning::RAG query failed - creating empty advice file"
            echo '{"error": "RAG query failed", "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' > data/rag_pretrade_advice.json
          }

          # Custom query if provided
          if [ -n "${{ inputs.custom_query }}" ]; then
            echo ""
            echo "Running custom query: ${{ inputs.custom_query }}"
            python3 scripts/query_vertex_rag.py --query "${{ inputs.custom_query }}" || true
          fi

          echo "advice_file=data/rag_pretrade_advice.json" >> $GITHUB_OUTPUT

      - name: Analyze advice for critical warnings
        id: analyze
        run: |
          echo "Analyzing RAG advice for critical warnings..."

          python3 -c "
          import json
          import sys

          try:
              with open('data/rag_pretrade_advice.json', 'r') as f:
                  advice = json.load(f)

              # Check for critical warnings
              has_warnings = False
              warnings = advice.get('risk_warnings', [])

              critical_keywords = ['critical', 'loss', 'failure', 'error', 'stop', 'avoid', 'never', 'danger']

              for warning in warnings:
                  text = warning.get('text', '').lower()
                  if any(keyword in text for keyword in critical_keywords):
                      has_warnings = True
                      print(f'âš ï¸  CRITICAL WARNING FOUND: {text[:200]}...')

              if has_warnings:
                  print('')
                  print('ðŸš¨ CRITICAL WARNINGS DETECTED - Review before trading!')
              else:
                  print('âœ… No critical warnings found - Clear to proceed')

              # Output for workflow
              print(f'has_warnings={str(has_warnings).lower()}')

          except Exception as e:
              print(f'Error analyzing advice: {e}')
              print('has_warnings=false')
          " | tee /tmp/analysis.txt

          # Extract output
          HAS_WARNINGS=$(grep "has_warnings=" /tmp/analysis.txt | cut -d= -f2)
          echo "has_warnings=$HAS_WARNINGS" >> $GITHUB_OUTPUT

      - name: Display advice summary
        run: |
          echo ""
          echo "=" * 70
          echo "PRE-TRADE RAG ADVICE SUMMARY"
          echo "=" * 70

          python3 -c "
          import json

          try:
              with open('data/rag_pretrade_advice.json', 'r') as f:
                  advice = json.load(f)

              print(f'Timestamp: {advice.get(\"timestamp\", \"unknown\")}')
              print(f'Symbols: {advice.get(\"symbols\", [])}')
              print('')

              # General advice count
              general = advice.get('general_advice', [])
              print(f'General Advice Items: {len(general)}')

              # Symbol-specific advice
              symbol_specific = advice.get('symbol_specific', {})
              print(f'Symbol-Specific Advice: {len(symbol_specific)} symbols')
              for symbol, items in symbol_specific.items():
                  print(f'  - {symbol}: {len(items)} items')

              # Risk warnings
              warnings = advice.get('risk_warnings', [])
              print(f'Risk Warnings: {len(warnings)}')

              # Recent lessons
              recent = advice.get('recent_lessons', [])
              print(f'Recent Lessons: {len(recent)}')

          except Exception as e:
              print(f'Could not display summary: {e}')
          "

      - name: Upload advice artifact
        uses: actions/upload-artifact@v4
        with:
          name: rag-pretrade-advice-${{ github.run_id }}
          path: data/rag_pretrade_advice.json
          retention-days: 7

      - name: Commit advice file
        continue-on-error: true
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add data/rag_pretrade_advice.json
          if ! git diff --cached --quiet; then
            git commit -m "chore: Update pre-trade RAG advice [$(date -u +%Y-%m-%d)]"
            git push || echo "Push failed - advice saved as artifact"
          fi

      - name: Summary
        run: |
          echo "## Vertex AI RAG Pre-Trade Query Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Symbols**: ${{ inputs.symbols || 'SPY,SOFI,PLTR,AMD' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Has Warnings**: ${{ steps.analyze.outputs.has_warnings }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the advice before executing trades!" >> $GITHUB_STEP_SUMMARY
