name: Strategy Sanity Gate

# Triggered on any strategy-related changes
on:
  pull_request:
    paths:
      - 'src/strategies/**'
      - 'src/utils/fear_greed_index.py'
      - 'src/risk/**'
      - '.claude/hooks/**'
      - 'config/backtest_scenarios.yaml'
  push:
    branches:
      - main
    paths:
      - 'src/strategies/**'
      - 'src/utils/fear_greed_index.py'
      - 'src/risk/**'

jobs:
  sanity-checks:
    name: Strategy Sanity Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pytest

      - name: Run sanity tests
        run: |
          pytest tests/test_strategy_sanity.py -v --tb=short

      - name: Check for hardcoded metrics
        run: |
          echo "Checking for hardcoded metrics..."

          # Check for fabricated 2.18 Sharpe
          if grep -r "2.18 Sharpe" .claude/hooks/ 2>/dev/null; then
            echo "::error::CRITICAL: Hardcoded '2.18 Sharpe' found in hooks. This metric never existed."
            exit 1
          fi

          # Check for cherry-picked 62.2% win rate
          if grep -r "62.2% win rate" .claude/hooks/ 2>/dev/null; then
            echo "::error::CRITICAL: Cherry-picked win rate found. Use actual data."
            exit 1
          fi

          echo "No hardcoded metrics found."

      - name: Check fear multiplier sanity
        run: |
          echo "Checking fear multiplier logic..."

          # Ensure fear doesn't increase position size
          if grep -E "size_multiplier = 1\.[5-9]" src/utils/fear_greed_index.py 2>/dev/null | grep -i "fear"; then
            echo "::error::CRITICAL: Fear conditions still increase position size. This destroyed $96 in Dec 2025."
            exit 1
          fi

          # Ensure buy-the-dip doesn't use 2x multiplier
          if grep -E "min\(2\.0.*btc_change" src/strategies/crypto_strategy.py 2>/dev/null; then
            echo "::error::CRITICAL: Buy-the-dip 2x multiplier still present. Never increase position during dips."
            exit 1
          fi

          echo "Fear multiplier checks passed."

      - name: Validate backtest metrics
        run: |
          echo "Validating backtest metrics..."

          if [ -f "data/backtests/latest_summary.json" ]; then
            # Check that passes count is honest
            passes=$(python3 -c "import json; print(json.load(open('data/backtests/latest_summary.json')).get('aggregate_metrics', {}).get('passes', 'N/A'))")
            echo "Backtest scenarios passing: $passes"

            # If 0 pass, ensure hooks reflect this
            if [ "$passes" = "0" ]; then
              echo "Warning: 0/13 scenarios pass. Ensure hooks show honest metrics."
            fi
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Strategy Sanity Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Lessons Applied" >> $GITHUB_STEP_SUMMARY
          echo "- ll_020: No pyramid buying during fear" >> $GITHUB_STEP_SUMMARY
          echo "- No hardcoded performance metrics" >> $GITHUB_STEP_SUMMARY
          echo "- Fear multiplier <= 1.0" >> $GITHUB_STEP_SUMMARY
          echo "- Honest backtest reporting" >> $GITHUB_STEP_SUMMARY

  backtest-validation:
    name: Backtest Validation
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'needs-backtest') || github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt || pip install pandas numpy

      - name: Verify backtest data integrity
        run: |
          python3 << 'EOF'
          import json
          from pathlib import Path

          summary_path = Path("data/backtests/latest_summary.json")
          if summary_path.exists():
              data = json.load(open(summary_path))

              print("Backtest Summary Validation")
              print("=" * 50)

              scenarios = data.get("scenarios", [])
              print(f"Total scenarios: {len(scenarios)}")

              passing = sum(1 for s in scenarios if s.get("status") == "pass")
              print(f"Passing: {passing}/{len(scenarios)}")

              sharpe_values = [s.get("sharpe_ratio", 0) for s in scenarios]
              print(f"Sharpe range: {min(sharpe_values):.2f} to {max(sharpe_values):.2f}")

              # Flag if any scenario claims 2.18 Sharpe
              suspicious = [s for s in scenarios if abs(s.get("sharpe_ratio", 0) - 2.18) < 0.1]
              if suspicious:
                  print("WARNING: Suspicious 2.18 Sharpe found - this was fabricated")
                  exit(1)

              print("\nBacktest data validated successfully.")
          else:
              print("No backtest summary found - skipping validation")
          EOF
