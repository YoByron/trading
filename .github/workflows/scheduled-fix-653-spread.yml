name: Scheduled - Fix 653 Spread Tuesday

on:
  schedule:
    # Run at 9:35 AM ET on Tuesday Jan 20, 2026 (next trading day)
    - cron: '35 14 20 1 *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fix-spread:
    name: Sell Extra 653 Put
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install alpaca-py

      - name: Sell 1 SPY260220P00653000
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_SECRET }}
        run: |
          python3 << 'PYTHON'
          import os
          from datetime import datetime
          from alpaca.trading.client import TradingClient
          from alpaca.trading.requests import MarketOrderRequest
          from alpaca.trading.enums import OrderSide, TimeInForce

          print("=" * 60)
          print("FIX 653/658 SPREAD - Selling extra long put")
          print(f"Time: {datetime.now().isoformat()}")
          print("=" * 60)

          client = TradingClient(
              os.environ['ALPACA_API_KEY'],
              os.environ['ALPACA_SECRET_KEY'],
              paper=True
          )

          positions = client.get_all_positions()
          target = None
          for pos in positions:
              if pos.symbol == "SPY260220P00653000":
                  target = pos
                  print(f"Found: {pos.symbol} qty={pos.qty}")
                  break

          if not target:
              print("Position not found")
              exit(0)

          if float(target.qty) <= 1:
              print(f"Position qty is {target.qty} - already fixed")
              exit(0)

          clock = client.get_clock()
          if not clock.is_open:
              print("Market closed")
              exit(1)

          order = client.submit_order(MarketOrderRequest(
              symbol="SPY260220P00653000",
              qty=1,
              side=OrderSide.SELL,
              time_in_force=TimeInForce.DAY
          ))

          print(f"âœ… ORDER SUBMITTED: {order.id}")
          PYTHON
