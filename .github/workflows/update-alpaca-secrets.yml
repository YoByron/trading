name: Update Alpaca Secrets

on:
  workflow_dispatch:
    inputs:
      api_key:
        description: 'Alpaca Paper Trading API Key'
        required: true
        type: string
      api_secret:
        description: 'Alpaca Paper Trading API Secret'
        required: true
        type: string

jobs:
  update-secrets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests pynacl alpaca-py

      - name: Verify credentials first
        env:
          ALPACA_API_KEY: ${{ github.event.inputs.api_key }}
          ALPACA_SECRET_KEY: ${{ github.event.inputs.api_secret }}
        run: |
          python3 -c "
          import os
          from alpaca.trading.client import TradingClient

          client = TradingClient(
              os.environ['ALPACA_API_KEY'],
              os.environ['ALPACA_SECRET_KEY'],
              paper=True
          )
          account = client.get_account()
          print(f'Connected! Equity: \${float(account.equity):,.2f}')
          print(f'Account Status: {account.status}')
          "

      - name: Update GitHub secrets
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          NEW_API_KEY: ${{ github.event.inputs.api_key }}
          NEW_API_SECRET: ${{ github.event.inputs.api_secret }}
        run: |
          python3 << 'EOF'
          import os
          import requests
          from base64 import b64decode, b64encode
          from nacl import public

          def encrypt_secret(public_key: str, secret_value: str) -> str:
              public_key_bytes = b64decode(public_key)
              sealed_box = public.SealedBox(public.PublicKey(public_key_bytes))
              encrypted = sealed_box.encrypt(secret_value.encode("utf-8"))
              return b64encode(encrypted).decode("utf-8")

          def update_secret(secret_name: str, secret_value: str):
              token = os.environ["GH_PAT"]
              repo = "IgorGanapolsky/trading"
              headers = {
                  "Authorization": f"token {token}",
                  "Accept": "application/vnd.github+json",
              }

              # Get public key
              key_resp = requests.get(
                  f"https://api.github.com/repos/{repo}/actions/secrets/public-key",
                  headers=headers
              )
              key_data = key_resp.json()

              # Encrypt and update
              encrypted = encrypt_secret(key_data["key"], secret_value)
              requests.put(
                  f"https://api.github.com/repos/{repo}/actions/secrets/{secret_name}",
                  headers=headers,
                  json={"encrypted_value": encrypted, "key_id": key_data["key_id"]}
              )
              print(f"Updated: {secret_name}")

          update_secret("ALPACA_PAPER_TRADING_5K_API_KEY", os.environ["NEW_API_KEY"])
          update_secret("ALPACA_PAPER_TRADING_5K_API_SECRET", os.environ["NEW_API_SECRET"])
          print("All secrets updated!")
          EOF

      - name: Trigger daily trading test
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          curl -X POST \
            -H "Authorization: token $GH_PAT" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/IgorGanapolsky/trading/actions/workflows/daily-trading.yml/dispatches" \
            -d '{"ref":"main","inputs":{"trading_mode":"paper"}}'
          echo "Triggered daily trading workflow"
