name: Fix Broken 653 Spread

on:
  workflow_dispatch:

jobs:
  fix-spread:
    runs-on: ubuntu-latest
    steps:
      - name: Sell Extra Long Put
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_SECRET }}
        run: |
          pip install alpaca-py
          python3 << 'PYTHON'
import os
from alpaca.trading.client import TradingClient
from alpaca.trading.requests import MarketOrderRequest
from alpaca.trading.enums import OrderSide, TimeInForce

api_key = os.environ['ALPACA_API_KEY']
secret_key = os.environ['ALPACA_SECRET_KEY']

client = TradingClient(api_key, secret_key, paper=True)

# Get current positions
positions = client.get_all_positions()
print("Current positions:")
for pos in positions:
    print(f"  {pos.symbol}: qty={pos.qty}")

# Find the 653 put
target = None
for pos in positions:
    if pos.symbol == "SPY260220P00653000":
        target = pos
        break

if not target:
    print("ERROR: SPY260220P00653000 not found")
    exit(1)

current_qty = int(float(target.qty))
print(f"\nTarget: {target.symbol} qty={current_qty}")

if current_qty <= 1:
    print("Already at 1 or less - no action needed")
    exit(0)

# SELL 1 contract to reduce from 2 to 1
print("\nSubmitting SELL order for 1 contract...")
order = MarketOrderRequest(
    symbol="SPY260220P00653000",
    qty=1,
    side=OrderSide.SELL,  # SELL to reduce long position
    time_in_force=TimeInForce.DAY
)

result = client.submit_order(order)
print(f"Order submitted: {result.id}")
print(f"Status: {result.status}")
PYTHON
