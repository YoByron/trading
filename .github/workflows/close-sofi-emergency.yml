name: Emergency Close SOFI Position

# Trigger SOFI close - Jan 20, 2026 crisis
on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - '.github/workflows/close-sofi-emergency.yml'

jobs:
  close-sofi:
    name: Close SOFI260213P00032000 Position
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Close SOFI Short Put
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_SECRET }}
        run: |
          pip install alpaca-py
          python3 << 'PYTHON_SCRIPT'
          import os
          from alpaca.trading.client import TradingClient
          from alpaca.trading.requests import MarketOrderRequest
          from alpaca.trading.enums import OrderSide, TimeInForce

          target_symbol = "SOFI260213P00032000"

          print(f"=== EMERGENCY CLOSE SOFI POSITION ===")
          print(f"Target: {target_symbol}")
          print(f"Reason: Violates SPY-only mandate in CLAUDE.md")

          client = TradingClient(
              os.environ['ALPACA_API_KEY'],
              os.environ['ALPACA_SECRET_KEY'],
              paper=True
          )

          # Get all positions
          positions = client.get_all_positions()
          print(f"Total positions: {len(positions)}")

          # Find SOFI position
          target_position = None
          for pos in positions:
              if pos.symbol == target_symbol:
                  target_position = pos
                  break

          if not target_position:
              print(f"Position {target_symbol} NOT FOUND - may already be closed")
              print("Available positions:")
              for pos in positions:
                  print(f"  - {pos.symbol} (qty: {pos.qty})")
              exit(0)  # Success - position doesn't exist

          print(f"Found position: {target_position.symbol}")
          print(f"  Quantity: {target_position.qty}")
          print(f"  Side: {target_position.side}")
          print(f"  Unrealized P/L: ${target_position.unrealized_pl}")

          # SOFI is a SHORT put (qty < 0), so we BUY to close
          current_qty = float(target_position.qty)
          order_qty = abs(int(current_qty)) if current_qty != 0 else 1

          if current_qty < 0:
              order_side = OrderSide.BUY
              print(f"Position is SHORT ({current_qty}) -> Using BUY to close")
          else:
              order_side = OrderSide.SELL
              print(f"Position is LONG ({current_qty}) -> Using SELL to close")

          # Submit close order
          print(f"Submitting {order_side.value} order for {order_qty} {target_symbol}")

          order_request = MarketOrderRequest(
              symbol=target_symbol,
              qty=order_qty,
              side=order_side,
              time_in_force=TimeInForce.DAY
          )

          try:
              order = client.submit_order(order_request)
              print(f"âœ… Order submitted: {order.id}")
              print(f"   Status: {order.status}")
              print(f"SOFI position close initiated!")
          except Exception as e:
              print(f"Order failed: {e}")
              exit(1)
          PYTHON_SCRIPT

      - name: Delete this workflow after use
        if: always()
        run: |
          echo "This emergency workflow should be deleted after the SOFI position is closed"
          echo "Run: git rm .github/workflows/close-sofi-emergency.yml"
