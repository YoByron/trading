name: Pre-Deploy Stress Test

# Trigger on strategy/ML changes to main
on:
  push:
    branches: [main]
    paths:
      - 'src/strategies/**'
      - 'src/ml/**'
      - 'src/backtesting/**'
      - 'src/risk/**'
  pull_request:
    branches: [main]
    paths:
      - 'src/strategies/**'
      - 'src/ml/**'
      - 'src/backtesting/**'
      - 'src/risk/**'
  workflow_dispatch:
    inputs:
      symbols:
        description: 'Comma-separated symbols to test'
        required: false
        default: 'SPY,QQQ,IWM'
      period:
        description: 'Backtest period in days'
        required: false
        default: '180'
      min_sharpe:
        description: 'Minimum Sharpe ratio threshold'
        required: false
        default: '0.5'
      max_drawdown:
        description: 'Maximum drawdown threshold (%)'
        required: false
        default: '25'

env:
  PYTHONUNBUFFERED: "1"

jobs:
  stress-test:
    name: Run Pessimistic Backtest
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Stress Test Validation
        id: stress_test
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          # Use paper trading for backtests
          ALPACA_PAPER: "true"
        run: |
          python scripts/validate_stress_test.py \
            --symbols "${{ github.event.inputs.symbols || 'SPY,QQQ,IWM' }}" \
            --period "${{ github.event.inputs.period || '180' }}" \
            --min-sharpe "${{ github.event.inputs.min_sharpe || '0.5' }}" \
            --max-drawdown "${{ github.event.inputs.max_drawdown || '25' }}" \
            --output data/stress_test_results.json \
            --verbose

      - name: Upload stress test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: stress-test-results
          path: data/stress_test_results.json
          retention-days: 30

      - name: Parse and report results
        if: always()
        run: |
          if [ -f data/stress_test_results.json ]; then
            echo "## Stress Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Extract key metrics
            PASSES=$(jq -r '.validation.passes' data/stress_test_results.json)
            SHARPE=$(jq -r '.pessimistic_results.sharpe_ratio // "N/A"' data/stress_test_results.json)
            DRAWDOWN=$(jq -r '.pessimistic_results.max_drawdown // "N/A"' data/stress_test_results.json)
            PNL=$(jq -r '.pessimistic_results.total_pnl // "N/A"' data/stress_test_results.json)

            if [ "$PASSES" == "true" ]; then
              echo "### ✅ Validation PASSED" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Strategy survives stress test - safe to deploy" >> $GITHUB_STEP_SUMMARY
            else
              echo "### ❌ Validation FAILED" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              REASON=$(jq -r '.validation.reason // "Unknown"' data/stress_test_results.json)
              echo "**Reason:** $REASON" >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Pessimistic Backtest Metrics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Sharpe Ratio | $SHARPE |" >> $GITHUB_STEP_SUMMARY
            echo "| Max Drawdown | $DRAWDOWN% |" >> $GITHUB_STEP_SUMMARY
            echo "| P/L | \$$PNL |" >> $GITHUB_STEP_SUMMARY
          fi

  # Gate deployment based on stress test
  deployment-gate:
    name: Deployment Gate
    needs: stress-test
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check stress test result
        run: |
          if [ "${{ needs.stress-test.result }}" != "success" ]; then
            echo "❌ Stress test failed - blocking deployment"
            echo ""
            echo "Strategy does not meet minimum requirements for live trading:"
            echo "  - Pessimistic Sharpe ratio must be >= 0.5"
            echo "  - Maximum drawdown must be <= 25%"
            echo "  - Strategy must remain profitable under stress"
            echo ""
            echo "Please review and improve strategy before deploying."
            exit 1
          fi

          echo "✅ Stress test passed - deployment allowed"
