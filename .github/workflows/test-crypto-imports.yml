name: Test Crypto Trading Imports

on:
  pull_request:
    paths:
      - 'src/rag/**'
      - 'src/deepagents_integration/**'
      - 'src/strategies/crypto_strategy.py'
      - 'scripts/autonomous_trader.py'
  push:
    branches: [main]
    paths:
      - 'src/rag/**'
      - 'src/deepagents_integration/**'
      - 'src/strategies/crypto_strategy.py'
      - 'scripts/autonomous_trader.py'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-crypto-imports:
    name: Test Crypto Trading Imports (No RAG)
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install minimal dependencies (no RAG)
        run: |
          python -m pip install --upgrade pip
          # Install only core dependencies, NOT requirements-rag.txt
          pip install -r requirements.txt

      - name: Test embedder imports without sentence_transformers
        run: |
          echo "Testing embedder module import..."
          python3 -c "
          from src.rag.vector_db import embedder
          print('✅ embedder module imports successfully')

          # Should fail gracefully when trying to use it
          try:
              embedder._get_sentence_transformer()
              print('⚠️  sentence_transformers is available (unexpected)')
          except ImportError as e:
              if 'sentence-transformers' in str(e):
                  print('✅ ImportError raised correctly (RAG not installed)')
              else:
                  print(f'❌ Wrong error: {e}')
                  exit(1)
          "

      - name: Test autonomous_trader imports
        run: |
          echo "Testing autonomous_trader import chain..."
          python3 -c "
          import sys
          import scripts.autonomous_trader
          print('✅ autonomous_trader imports successfully')

          # Verify sentiment_store was NOT imported
          if 'src.rag.sentiment_store' in sys.modules:
              print('⚠️  WARNING: sentiment_store was imported (should be lazy)')
              exit(1)
          else:
              print('✅ sentiment_store NOT imported (lazy loading works)')
          "

      - name: Test crypto strategy imports
        run: |
          echo "Testing crypto strategy imports..."
          python3 -c "
          from src.strategies.crypto_strategy import CryptoStrategy
          print('✅ CryptoStrategy imports successfully')

          # Should be able to create instance
          strategy = CryptoStrategy(daily_amount=0.50)
          assert strategy.daily_amount == 0.50
          print('✅ CryptoStrategy can be instantiated')
          "

      - name: Run integration test script
        run: |
          python3 scripts/test_crypto_imports.py

      - name: Verify no RAG dependencies required
        run: |
          echo "Verifying RAG dependencies are NOT required..."
          python3 -c "
          import sys

          # Check that we can import everything without RAG
          from scripts.autonomous_trader import execute_crypto_trading, is_weekend
          from src.strategies.crypto_strategy import CryptoStrategy
          from src.core.risk_manager import RiskManager

          # Verify sentiment_store is NOT in sys.modules
          if 'src.rag.sentiment_store' in sys.modules:
              print('❌ FAILED: sentiment_store was imported')
              exit(1)

          print('✅ All imports work without RAG dependencies')
          print('✅ Crypto trading is independent of RAG system')
          "
