name: Continuous RL Training

on:
  schedule:
    # Run every 2 hours during market hours (9 AM - 4 PM ET = 13:00-20:00 UTC)
    # Plus once after market close (8 PM ET = 00:00 UTC next day)
    - cron: '0 13,15,17,19,21,23,1 * * 1-5'  # Every 2 hours during market hours + after close
  workflow_dispatch:
    inputs:
      agents:
        description: "Comma-separated agents to train: q_learning,dqn,ppo,all"
        required: false
        default: "q_learning"
      use_langsmith:
        description: "Enable LangSmith monitoring"
        required: false
        default: "false"

permissions:
  contents: read

jobs:
  train-rl:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # RL training is fast (<5 minutes)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Install langsmith if using LangSmith
          if [ "${{ github.event.inputs.use_langsmith }}" = "true" ] || [ "${{ secrets.LANGCHAIN_API_KEY }}" != "" ]; then
            pip install langsmith
          fi

      - name: Train RL Agents
        env:
          LANGCHAIN_API_KEY: ${{ secrets.LANGCHAIN_API_KEY }}
          LANGCHAIN_TRACING_V2: ${{ github.event.inputs.use_langsmith == 'true' && 'true' || '' }}
          LANGCHAIN_PROJECT: trading-rl-training
        run: |
          echo "ðŸ¤– Training RL Agents..."
          echo "=========================================="
          
          AGENTS="${{ github.event.inputs.agents || 'q_learning' }}"
          USE_LANGSMITH="${{ github.event.inputs.use_langsmith || 'false' }}"
          
          python3 scripts/rl_training_orchestrator.py \
            --platform github \
            --agents "$AGENTS" \
            --device cpu \
            $([ "$USE_LANGSMITH" = "true" ] && echo "--use-langsmith" || echo "")
          
          TRAINING_RESULT=$?
          
          if [ $TRAINING_RESULT -eq 0 ]; then
            echo "âœ… RL training completed successfully"
          else
            echo "âš ï¸  RL training completed with warnings"
            exit 0  # Don't fail workflow - training can have warnings
          fi

      - name: Upload training logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rl-training-logs-${{ github.run_id }}
          path: |
            data/rl_training_log.json
          retention-days: 30

      - name: Training summary
        if: always()
        run: |
          echo "=========================================="
          echo "RL Training Summary"
          echo "=========================================="
          echo "Platform: GitHub Actions"
          echo "Agents: ${{ github.event.inputs.agents || 'q_learning' }}"
          echo "LangSmith: ${{ github.event.inputs.use_langsmith || 'false' }}"
          echo "Time Completed: $(date)"
          echo "=========================================="

