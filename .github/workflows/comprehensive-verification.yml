name: Comprehensive Verification Gate

# This workflow is the MANDATORY gate before any merge to main
# Created: Dec 14, 2025
# Purpose: Prevent repeating past failures (ll_009, ll_024, ci_failure_blocked_trading)

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  syntax-verification:
    name: Syntax & Import Verification
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install pytest ruff mypy

      - name: Python Syntax Check (ALL files)
        run: |
          echo "üîç Checking Python syntax..."
          find src scripts tests -name "*.py" -type f -exec python3 -m py_compile {} \;
          echo "‚úÖ All Python files compile successfully"

      - name: Ruff Lint Check
        run: |
          ruff check src/ scripts/ --select=E9,F63,F7,F82
          echo "‚úÖ Ruff lint passed"

      - name: Critical Import Verification
        run: |
          echo "üîç Verifying critical imports..."
          python3 -c "from src.orchestrator.main import TradingOrchestrator; print('‚úÖ TradingOrchestrator')"
          python3 -c "from src.execution.alpaca_executor import AlpacaExecutor; print('‚úÖ AlpacaExecutor')"
          python3 -c "from src.risk.trade_gateway import TradeGateway; print('‚úÖ TradeGateway')"
          python3 -c "from src.agents.rl_agent import RLFilter; print('‚úÖ RLFilter')"
          echo "‚úÖ All critical imports work"

  rag-ml-verification:
    name: RAG & ML Verification
    runs-on: ubuntu-latest
    timeout-minutes: 10
    continue-on-error: true  # Don't block on warnings

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need history for git diff

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install numpy

      - name: RAG Safety Check
        run: |
          echo "üîç Running RAG verification..."
          python3 -c "
          from pathlib import Path
          import sys
          sys.path.insert(0, str(Path.cwd()))
          from src.verification.rag_verification_gate import RAGVerificationGate
          gate = RAGVerificationGate()
          print(f'‚úÖ RAG gate loaded {len(gate.lessons)} lessons')
          "

      - name: ML Anomaly Detection
        run: |
          echo "üîç Running ML anomaly detection..."
          python3 -c "
          from pathlib import Path
          import sys
          sys.path.insert(0, str(Path.cwd()))
          from src.verification.ml_anomaly_detector import MLAnomalyDetector
          detector = MLAnomalyDetector()
          anomalies = detector.run_all_checks()
          if anomalies:
              print(f'‚ö†Ô∏è  Found {len(anomalies)} anomalies')
              for a in anomalies:
                  print(f'  [{a.severity}] {a.description}')
          else:
              print('‚úÖ No anomalies detected')
          "

  test-verification-suite:
    name: Run Verification Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.in pytest pytest-asyncio numpy

      - name: Run Syntax Verification Tests
        run: |
          pytest tests/test_syntax_verification.py -v --tb=short
          echo "‚úÖ Syntax verification tests passed"

      - name: Run Verification System Tests
        run: |
          pytest tests/test_verification_system.py -v --tb=short
          echo "‚úÖ Verification system tests passed"

      - name: Run Lessons Learned Regression Tests
        run: |
          echo "üîç Running regression tests for ALL lessons learned..."
          pytest tests/test_lessons_learned_regression.py -v --tb=short
          echo "‚úÖ Lessons learned regression tests passed"

  pre-merge-gate:
    name: Pre-Merge Gate (MANDATORY)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [syntax-verification]  # Must pass syntax first

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install numpy ruff mypy

      - name: Run Pre-Merge Gate
        run: |
          echo "üö¶ Running pre-merge gate..."
          python3 scripts/pre_merge_gate.py
          echo "‚úÖ Pre-merge gate PASSED"

  summary:
    name: Verification Summary
    runs-on: ubuntu-latest
    needs: [syntax-verification, rag-ml-verification, test-verification-suite, pre-merge-gate]
    if: always()

    steps:
      - name: Check Results
        run: |
          echo "üìä Verification Summary:"
          echo "  Syntax Verification: ${{ needs.syntax-verification.result }}"
          echo "  RAG/ML Verification: ${{ needs.rag-ml-verification.result }}"
          echo "  Test Suite: ${{ needs.test-verification-suite.result }}"
          echo "  Pre-Merge Gate: ${{ needs.pre-merge-gate.result }}"

          if [ "${{ needs.syntax-verification.result }}" != "success" ]; then
            echo "‚ùå SYNTAX VERIFICATION FAILED - DO NOT MERGE"
            exit 1
          fi

          if [ "${{ needs.pre-merge-gate.result }}" != "success" ]; then
            echo "‚ùå PRE-MERGE GATE FAILED - DO NOT MERGE"
            exit 1
          fi

          echo "‚úÖ All mandatory checks passed - Safe to merge"
