name: Detect Contract Accumulation

# SECOND LINE OF DEFENSE: Detects when contracts accumulate beyond safe levels
# Root cause of LL-275 disaster: 9 BUY orders accumulated 8 contracts of same symbol
# Prevention: mandatory_trade_gate.py CHECK 2.6
# Detection: This workflow (runs every 15 min during market hours)

on:
  schedule:
    # Every 15 minutes during market hours (9:30 AM - 4 PM ET = 14:30 - 21:00 UTC)
    - cron: '*/15 14-20 * * 1-5'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  detect-accumulation:
    name: Contract Accumulation Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install alpaca-py

      - name: Check for Contract Accumulation
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_30K_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_PAPER_TRADING_30K_API_SECRET }}
        run: |
          python3 -c "
          import os
          import sys
          from datetime import datetime

          print('=' * 60)
          print(f'CONTRACT ACCUMULATION CHECK - {datetime.now()}')
          print('LL-275 Prevention: Detect stacking before it causes losses')
          print('=' * 60)

          # Validate environment variables first
          api_key = os.environ.get('ALPACA_API_KEY', '')
          secret_key = os.environ.get('ALPACA_SECRET_KEY', '')

          if not api_key or not secret_key:
              print('âŒ ERROR: ALPACA_API_KEY or ALPACA_SECRET_KEY not set')
              print('Check GitHub secrets configuration')
              sys.exit(1)

          try:
              from alpaca.trading.client import TradingClient
          except ImportError as e:
              print(f'âŒ ERROR: Failed to import alpaca-py: {e}')
              sys.exit(1)

          # Max contracts per symbol (1 iron condor = 1-2 contracts per leg)
          MAX_CONTRACTS_PER_SYMBOL = 2

          try:
              client = TradingClient(api_key, secret_key, paper=True)
              positions = client.get_all_positions()
          except Exception as e:
              print(f'âŒ ERROR: Failed to connect to Alpaca API: {e}')
              sys.exit(1)

          if positions is None:
              positions = []

          print(f'\nTotal Positions: {len(positions)}')

          violations = []
          warnings = []

          for pos in positions:
              try:
                  symbol = getattr(pos, 'symbol', 'UNKNOWN')
                  qty = abs(int(float(getattr(pos, 'qty', 0))))
                  side = 'LONG' if float(getattr(pos, 'qty', 0)) > 0 else 'SHORT'
                  pl = float(getattr(pos, 'unrealized_pl', 0))

                  # Only check options (symbols > 10 chars)
                  if len(symbol) > 10:
                      print(f'  {symbol}: {qty} {side} (P/L: \${pl:+.2f})')

                      if qty > MAX_CONTRACTS_PER_SYMBOL:
                          violations.append({
                              'symbol': symbol,
                              'qty': qty,
                              'side': side,
                              'pl': pl,
                              'excess': qty - MAX_CONTRACTS_PER_SYMBOL
                          })
                      elif qty == MAX_CONTRACTS_PER_SYMBOL:
                          warnings.append({
                              'symbol': symbol,
                              'qty': qty,
                              'side': side
                          })
              except Exception as e:
                  print(f'  âš ï¸ Error processing position: {e}')
                  continue

          print(f'\n' + '=' * 60)
          print('ACCUMULATION CHECK RESULTS')
          print('=' * 60)

          if violations:
              print(f'\nðŸš¨ VIOLATIONS FOUND: {len(violations)}')
              for v in violations:
                  print(f'  âŒ {v[\"symbol\"]}: {v[\"qty\"]} contracts ({v[\"excess\"]} excess)')
                  print(f'     Side: {v[\"side\"]} | P/L: \${v[\"pl\"]:+.2f}')
                  print(f'     ACTION REQUIRED: Close excess contracts')

              print(f'\nâš ï¸  This is the LL-275 pattern that caused -\$1,472 loss')
              print('Prevention layer (mandatory_trade_gate.py) may have been bypassed')
              sys.exit(1)  # FAIL the workflow

          if warnings:
              print(f'\nâš ï¸  WARNINGS: {len(warnings)} positions at max capacity')
              for w in warnings:
                  print(f'  âš ï¸  {w[\"symbol\"]}: {w[\"qty\"]} contracts (at limit)')

          if not violations and not warnings:
              print('\nâœ… No accumulation detected - all positions within limits')

          print(f'\nMax allowed per symbol: {MAX_CONTRACTS_PER_SYMBOL} contracts')
          print('=' * 60)
          "

      - name: Post summary
        if: always()
        run: |
          echo "## Contract Accumulation Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Purpose:** Detect when contracts accumulate beyond safe levels (LL-275 prevention)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Max contracts per symbol:** 2" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This is the SECOND line of defense after \`mandatory_trade_gate.py\` CHECK 2.6" >> $GITHUB_STEP_SUMMARY
