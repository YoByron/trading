name: Verify Trading Activity

on:
  schedule:
    # Run every weekday at 5:00 PM Eastern (after market close at 4:00 PM)
    # AUTOMATIC DST HANDLING: Runs at both times to cover EST/EDT transitions
    # EST (Nov-Mar): UTC-5 -> 5:00 PM ET = 22:00 UTC
    # EDT (Mar-Nov): UTC-4 -> 5:00 PM ET = 21:00 UTC
    - cron: '0 21,22 * * 1-5'   # 5:00 PM Eastern (covers both EST and EDT)
  workflow_dispatch:
    inputs:
      date:
        description: "Date to verify (YYYY-MM-DD), defaults to today"
        required: false
        type: string

permissions:
  contents: read
  issues: write  # For creating issues on failure

jobs:
  verify-trading:
    runs-on: ubuntu-22.04
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install --no-cache-dir alpaca-py python-dotenv

      - name: Determine verification date
        id: date
        run: |
          if [ -n "${{ inputs.date }}" ]; then
            echo "date=${{ inputs.date }}" >> $GITHUB_OUTPUT
            echo "üìÖ Verifying trades for: ${{ inputs.date }}"
          else
            TODAY=$(date -u +%Y-%m-%d)
            echo "date=$TODAY" >> $GITHUB_OUTPUT
            echo "üìÖ Verifying trades for today: $TODAY"
          fi

      - name: Check if market day
        id: market_check
        run: |
          # Check if today is a weekday (Mon-Fri)
          DAY_OF_WEEK=$(date -u +%u)  # 1=Monday, 7=Sunday

          if [ "$DAY_OF_WEEK" -ge 6 ]; then
            echo "is_market_day=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Weekend detected - skipping verification"
          else
            echo "is_market_day=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Weekday detected - proceeding with verification"
          fi

          # TODO: Add holiday check using market calendar API
          # For now, we assume all weekdays are market days

      - name: Verify trades via Alpaca API
        id: verify_api
        if: steps.market_check.outputs.is_market_day == 'true'
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          PAPER_TRADING: "true"
        run: |
          echo "üåê Checking Alpaca API for today's orders..."

          # Run verification script with JSON output
          python3 scripts/verify_trades.py --date "${{ steps.date.outputs.date }}" --json > /tmp/verify_output.json || true

          # Parse JSON output
          ORDERS_COUNT=$(jq '.orders | length' /tmp/verify_output.json 2>/dev/null || echo "0")
          FILLED_COUNT=$(jq '[.orders[] | select(.status == "filled")] | length' /tmp/verify_output.json 2>/dev/null || echo "0")

          echo "orders_count=$ORDERS_COUNT" >> $GITHUB_OUTPUT
          echo "filled_count=$FILLED_COUNT" >> $GITHUB_OUTPUT

          echo "üìä Orders found: $ORDERS_COUNT"
          echo "‚úÖ Filled orders: $FILLED_COUNT"

          # Display order summary
          echo ""
          echo "Order Summary:"
          jq -r '.orders[] | "  ‚Ä¢ \(.symbol) \(.side) \(.filled_qty) @ $\(.filled_price) - \(.status)"' /tmp/verify_output.json 2>/dev/null || echo "  (none)"

      - name: Check for trade log files
        id: verify_files
        if: steps.market_check.outputs.is_market_day == 'true'
        run: |
          echo "üìÅ Checking for trade log files..."

          TRADE_FILE="data/trades_${{ steps.date.outputs.date }}.json"

          if [ -f "$TRADE_FILE" ]; then
            echo "file_exists=true" >> $GITHUB_OUTPUT

            # Count trades in file
            TRADE_COUNT=$(jq '. | length' "$TRADE_FILE" 2>/dev/null || echo "0")
            echo "file_trade_count=$TRADE_COUNT" >> $GITHUB_OUTPUT

            echo "‚úÖ Trade file found: $TRADE_FILE"
            echo "üìù Trades logged: $TRADE_COUNT"

            # Show trade summary
            echo ""
            echo "Trade Log Summary:"
            jq -r '.[] | "  ‚Ä¢ \(.symbol) \(.action) \(.quantity) @ $\(.price // "N/A") - \(.status // "N/A")"' "$TRADE_FILE" 2>/dev/null || echo "  (error parsing)"
          else
            echo "file_exists=false" >> $GITHUB_OUTPUT
            echo "file_trade_count=0" >> $GITHUB_OUTPUT
            echo "‚ùå Trade file not found: $TRADE_FILE"
          fi

      - name: Verify order accuracy
        id: verify_accuracy
        if: steps.market_check.outputs.is_market_day == 'true'
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          PAPER_TRADING: "true"
        run: |
          echo "üîç Running order verification (Trust but Verify)..."

          # Run the comprehensive verification script
          if python3 scripts/verify_orders.py; then
            echo "verification_passed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Order verification PASSED"
          else
            echo "verification_passed=false" >> $GITHUB_OUTPUT
            echo "‚ùå Order verification FAILED"
          fi

      - name: Determine verification status
        id: status
        if: steps.market_check.outputs.is_market_day == 'true'
        run: |
          ORDERS=${{ steps.verify_api.outputs.orders_count || 0 }}
          FILLED=${{ steps.verify_api.outputs.filled_count || 0 }}
          FILE_EXISTS=${{ steps.verify_files.outputs.file_exists }}
          VERIFICATION=${{ steps.verify_accuracy.outputs.verification_passed }}

          echo ""
          echo "================================"
          echo "VERIFICATION SUMMARY"
          echo "================================"
          echo "Date: ${{ steps.date.outputs.date }}"
          echo "Orders found in Alpaca: $ORDERS"
          echo "Filled orders: $FILLED"
          echo "Trade file exists: $FILE_EXISTS"
          echo "Order verification: $VERIFICATION"
          echo "================================"
          echo ""

          # Determine if trading happened
          if [ "$ORDERS" -gt 0 ] || [ "$FILE_EXISTS" = "true" ]; then
            echo "trading_occurred=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Trading activity detected"

            # Check if verification passed
            if [ "$VERIFICATION" != "true" ]; then
              echo "has_issues=true" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è  WARNING: Trading occurred but verification failed"
            else
              echo "has_issues=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "trading_occurred=false" >> $GITHUB_OUTPUT
            echo "has_issues=true" >> $GITHUB_OUTPUT
            echo "‚ùå NO TRADING ACTIVITY DETECTED"
          fi

      - name: Fail if no trading on market day
        if: |
          steps.market_check.outputs.is_market_day == 'true' &&
          steps.status.outputs.trading_occurred != 'true'
        run: |
          echo ""
          echo "üö® ================================ üö®"
          echo "üö®   CRITICAL: NO TRADING TODAY    üö®"
          echo "üö® ================================ üö®"
          echo ""
          echo "Expected trading activity on market day but found:"
          echo "  ‚Ä¢ Orders in Alpaca: ${{ steps.verify_api.outputs.orders_count || 0 }}"
          echo "  ‚Ä¢ Trade file exists: ${{ steps.verify_files.outputs.file_exists }}"
          echo ""
          echo "Possible causes:"
          echo "  1. Daily trading workflow did not run"
          echo "  2. Trading workflow ran but failed silently"
          echo "  3. System is paused/disabled"
          echo "  4. Market holiday (not detected by our calendar)"
          echo ""
          echo "Action required:"
          echo "  ‚Ä¢ Check daily-trading workflow logs"
          echo "  ‚Ä¢ Verify ALPACA_API_KEY and ALPACA_SECRET_KEY secrets"
          echo "  ‚Ä¢ Review system_state.json for errors"
          echo "  ‚Ä¢ Check if market was open today"
          echo ""
          exit 1

      - name: Fail if verification issues
        if: |
          steps.market_check.outputs.is_market_day == 'true' &&
          steps.status.outputs.has_issues == 'true' &&
          steps.status.outputs.trading_occurred == 'true'
        run: |
          echo ""
          echo "üö® ================================ üö®"
          echo "üö®   VERIFICATION FAILED           üö®"
          echo "üö® ================================ üö®"
          echo ""
          echo "Trading occurred but verification found issues:"
          echo "  ‚Ä¢ Check logs above for details"
          echo "  ‚Ä¢ Review scripts/verify_orders.py output"
          echo "  ‚Ä¢ Verify order accuracy in Alpaca dashboard"
          echo ""
          exit 1

      - name: Post success notification
        if: |
          steps.market_check.outputs.is_market_day == 'true' &&
          steps.status.outputs.trading_occurred == 'true' &&
          steps.status.outputs.has_issues == 'false'
        run: |
          echo ""
          echo "‚úÖ ================================ ‚úÖ"
          echo "‚úÖ   TRADING VERIFICATION PASSED   ‚úÖ"
          echo "‚úÖ ================================ ‚úÖ"
          echo ""
          echo "Summary for ${{ steps.date.outputs.date }}:"
          echo "  ‚Ä¢ Orders executed: ${{ steps.verify_api.outputs.orders_count }}"
          echo "  ‚Ä¢ Orders filled: ${{ steps.verify_api.outputs.filled_count }}"
          echo "  ‚Ä¢ Trade log verified: ‚úÖ"
          echo "  ‚Ä¢ Order accuracy: ‚úÖ"
          echo ""
          echo "All systems operational! üöÄ"
          echo ""

      - name: Skip verification (weekend)
        if: steps.market_check.outputs.is_market_day != 'true'
        run: |
          echo ""
          echo "‚è≠Ô∏è  ================================ ‚è≠Ô∏è"
          echo "‚è≠Ô∏è   SKIPPING VERIFICATION          ‚è≠Ô∏è"
          echo "‚è≠Ô∏è ================================ ‚è≠Ô∏è"
          echo ""
          echo "Reason: Not a market day"
          echo "Date: ${{ steps.date.outputs.date }}"
          echo ""
          echo "No action required."
          echo ""
