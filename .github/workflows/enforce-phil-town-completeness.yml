name: Enforce Phil Town RAG Completeness

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run daily at 5:00 AM ET to catch any gaps before trading
    - cron: '0 9,10 * * *'
  workflow_dispatch:

jobs:
  check-phil-town-completeness:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Phil Town RAG Content Completeness
        id: check
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë       PHIL TOWN RAG COMPLETENESS ENFORCEMENT CHECK         ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""

          FAILURES=0
          WARNINGS=0

          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          # MINIMUM REQUIREMENTS (FAIL if not met)
          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

          MIN_YOUTUBE_TRANSCRIPTS=10
          MIN_BLOG_ARTICLES=10
          MIN_BOOKS=1
          MIN_TOTAL_CONTENT=25

          # Count YouTube transcripts
          YOUTUBE_COUNT=$(find rag_knowledge/youtube/transcripts -name "*.md" 2>/dev/null | wc -l)
          echo "üì∫ YouTube transcripts: $YOUTUBE_COUNT (minimum: $MIN_YOUTUBE_TRANSCRIPTS)"
          if [ "$YOUTUBE_COUNT" -lt "$MIN_YOUTUBE_TRANSCRIPTS" ]; then
            echo "::error::FAIL: YouTube transcripts below minimum ($YOUTUBE_COUNT < $MIN_YOUTUBE_TRANSCRIPTS)"
            FAILURES=$((FAILURES + 1))
          fi

          # Count blog articles
          BLOG_COUNT=$(find rag_knowledge/blogs/phil_town -name "*.md" 2>/dev/null | wc -l)
          echo "üìù Blog articles: $BLOG_COUNT (minimum: $MIN_BLOG_ARTICLES)"
          if [ "$BLOG_COUNT" -lt "$MIN_BLOG_ARTICLES" ]; then
            echo "::error::FAIL: Blog articles below minimum ($BLOG_COUNT < $MIN_BLOG_ARTICLES)"
            FAILURES=$((FAILURES + 1))
          fi

          # Count books
          BOOK_COUNT=$(find rag_knowledge/books -name "*phil*" -o -name "*rule*one*" 2>/dev/null | wc -l)
          if [ "$BOOK_COUNT" -eq 0 ]; then
            BOOK_COUNT=$(find rag_knowledge/books -name "*.md" 2>/dev/null | wc -l)
          fi
          echo "üìö Books/summaries: $BOOK_COUNT (minimum: $MIN_BOOKS)"
          if [ "$BOOK_COUNT" -lt "$MIN_BOOKS" ]; then
            echo "::error::FAIL: Books below minimum ($BOOK_COUNT < $MIN_BOOKS)"
            FAILURES=$((FAILURES + 1))
          fi

          # Total content check
          TOTAL=$((YOUTUBE_COUNT + BLOG_COUNT + BOOK_COUNT))
          echo "üìä Total content pieces: $TOTAL (minimum: $MIN_TOTAL_CONTENT)"
          if [ "$TOTAL" -lt "$MIN_TOTAL_CONTENT" ]; then
            echo "::error::FAIL: Total content below minimum ($TOTAL < $MIN_TOTAL_CONTENT)"
            FAILURES=$((FAILURES + 1))
          fi

          echo ""

          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          # CONTENT QUALITY CHECKS (WARN if not met)
          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

          # Check for key Phil Town concepts in content
          echo "üîç Checking for Phil Town key concepts..."

          KEY_CONCEPTS=("4 Ms" "moat" "margin of safety" "Rule #1" "Rule 1" "intrinsic value" "sticker price")
          CONCEPT_FOUND=0

          for concept in "${KEY_CONCEPTS[@]}"; do
            if grep -rli "$concept" rag_knowledge/ >/dev/null 2>&1; then
              CONCEPT_FOUND=$((CONCEPT_FOUND + 1))
            fi
          done

          echo "   Key concepts found: $CONCEPT_FOUND / ${#KEY_CONCEPTS[@]}"
          if [ "$CONCEPT_FOUND" -lt 4 ]; then
            echo "::warning::Content may not contain enough Phil Town concepts"
            WARNINGS=$((WARNINGS + 1))
          fi

          # Check Rule #1 book exists
          if [ ! -f "rag_knowledge/books/phil_town_rule_one.md" ]; then
            echo "::warning::Rule #1 book summary not found"
            WARNINGS=$((WARNINGS + 1))
          else
            BOOK_SIZE=$(wc -c < "rag_knowledge/books/phil_town_rule_one.md")
            echo "   Rule #1 book summary: $BOOK_SIZE bytes"
            if [ "$BOOK_SIZE" -lt 5000 ]; then
              echo "::warning::Rule #1 book summary seems incomplete (<5KB)"
              WARNINGS=$((WARNINGS + 1))
            fi
          fi

          echo ""

          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          # FRESHNESS CHECK (WARN if stale)
          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

          echo "üïê Checking content freshness..."

          # Find most recent file modification
          NEWEST_FILE=$(find rag_knowledge/youtube/transcripts rag_knowledge/blogs/phil_town -name "*.md" -printf '%T@ %p\n' 2>/dev/null | sort -n | tail -1)
          if [ -n "$NEWEST_FILE" ]; then
            NEWEST_DATE=$(echo "$NEWEST_FILE" | cut -d' ' -f1 | xargs -I{} date -d @{} +%Y-%m-%d 2>/dev/null || echo "unknown")
            echo "   Most recent content: $NEWEST_DATE"
          fi

          # Check if blog cache was updated in last 7 days
          if [ -f "data/blog_cache/phil_town_articles.json" ]; then
            CACHE_AGE=$(find data/blog_cache/phil_town_articles.json -mtime +7 2>/dev/null | wc -l)
            if [ "$CACHE_AGE" -gt 0 ]; then
              echo "::warning::Blog cache is older than 7 days - may need refresh"
              WARNINGS=$((WARNINGS + 1))
            fi
          fi

          echo ""

          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          # SUMMARY
          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë                        SUMMARY                             ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          echo "   YouTube transcripts: $YOUTUBE_COUNT"
          echo "   Blog articles: $BLOG_COUNT"
          echo "   Books: $BOOK_COUNT"
          echo "   Total: $TOTAL"
          echo ""
          echo "   Failures: $FAILURES"
          echo "   Warnings: $WARNINGS"
          echo ""

          # Save outputs
          echo "youtube_count=$YOUTUBE_COUNT" >> $GITHUB_OUTPUT
          echo "blog_count=$BLOG_COUNT" >> $GITHUB_OUTPUT
          echo "book_count=$BOOK_COUNT" >> $GITHUB_OUTPUT
          echo "total_count=$TOTAL" >> $GITHUB_OUTPUT
          echo "failures=$FAILURES" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT

          if [ "$FAILURES" -gt 0 ]; then
            echo "::error::‚ùå PHIL TOWN COMPLETENESS CHECK FAILED"
            echo "Run 'gh workflow run phil-town-ingestion.yml -f mode=backfill' to fix"
            exit 1
          fi

          if [ "$WARNINGS" -gt 0 ]; then
            echo "‚ö†Ô∏è  Phil Town content check passed with warnings"
          else
            echo "‚úÖ Phil Town content check PASSED"
          fi

      - name: Trigger backfill if needed
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            console.log('Phil Town content incomplete - triggering backfill...');
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'phil-town-ingestion.yml',
              ref: 'main',
              inputs: {
                mode: 'backfill'
              }
            });
            console.log('Backfill triggered!');
