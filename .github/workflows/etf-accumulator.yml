name: ETF Accumulator (Simple & Proven)

# CTO/CFO Decision (Dec 10, 2025):
# Options strategy has negative Sharpe (-7 to -72) - it LOSES money
# Pivoting to simple ETF accumulation - the Bogleheads way
# Buy $10/day of SPY, hold forever, average ~10% annual return

on:
  schedule:
    # Run at 9:35 AM ET (market open + 5 min for stability)
    # EST (Nov-Mar): UTC-5 -> 9:35 AM ET = 14:35 UTC
    # EDT (Mar-Nov): UTC-4 -> 9:35 AM ET = 13:35 UTC
    - cron: '35 13,14 * * 1-5'  # Weekdays only
  workflow_dispatch:
    inputs:
      symbol:
        description: 'ETF to buy'
        required: false
        default: 'SPY'
      amount:
        description: 'Dollar amount to invest'
        required: false
        default: '10'
      dry_run:
        description: 'Dry run (no actual trade)'
        required: false
        default: 'false'

permissions:
  contents: write

concurrency:
  group: etf-accumulator
  cancel-in-progress: false

jobs:
  accumulate-etf:
    runs-on: ubuntu-22.04
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install alpaca-py yfinance

      - name: Execute ETF Purchase
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          PAPER_TRADING: 'true'
        run: |
          echo "ðŸ“ˆ ========================================"
          echo "ðŸ“ˆ ETF ACCUMULATOR - $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ“ˆ ========================================"
          echo ""
          echo "Strategy: Simple Buy & Hold (Bogleheads)"
          echo "Symbol: ${{ github.event.inputs.symbol || 'SPY' }}"
          echo "Amount: $${{ github.event.inputs.amount || '10' }}"
          echo ""

          ARGS="--symbol ${{ github.event.inputs.symbol || 'SPY' }}"
          ARGS="$ARGS --amount ${{ github.event.inputs.amount || '10' }}"

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            ARGS="$ARGS --dry-run"
          fi

          python3 scripts/simple_etf_accumulator.py $ARGS

      - name: Commit trade record
        if: success()
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # Check for new trade files
          if git status --short data/etf_trades_*.json 2>/dev/null | grep -q .; then
            git add data/etf_trades_*.json
            git commit -m "chore: Record ETF purchase (${{ github.run_id }})"

            # Push with retry
            for i in 1 2 3 4; do
              if git push origin main; then
                echo "âœ… Trade record pushed"
                break
              fi
              sleep $((2 ** i))
            done
          fi

      - name: Upload trade log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: etf-trade-log-${{ github.run_id }}
          path: data/etf_trades_*.json
          retention-days: 90
