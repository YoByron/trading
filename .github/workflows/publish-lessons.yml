name: Publish Lessons to Blog

on:
  push:
    branches:
      - main
    paths:
      - 'rag_knowledge/lessons_learned/*.md'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Find new lessons
        id: find_lessons
        run: |
          # Get lessons modified in this push
          LESSONS=$(git diff --name-only HEAD~1 HEAD -- 'rag_knowledge/lessons_learned/*.md' | tr '\n' ' ')
          echo "lessons=$LESSONS" >> $GITHUB_OUTPUT
          echo "Found lessons: $LESSONS"

      - name: Convert and publish to Dev.to
        if: steps.find_lessons.outputs.lessons != ''
        env:
          DEVTO_API_KEY: ${{ secrets.DEVTO_API_KEY }}
          LESSONS: ${{ steps.find_lessons.outputs.lessons }}
        run: |
          python3 << 'PYTHON'
          import os
          import json
          import requests
          from pathlib import Path

          api_key = os.environ.get('DEVTO_API_KEY')
          if not api_key:
              print("No Dev.to API key configured - skipping Dev.to publish")
              exit(0)

          lessons = os.environ.get('LESSONS', '').split()

          for lesson_path in lessons:
              if not lesson_path or not Path(lesson_path).exists():
                  continue

              content = Path(lesson_path).read_text()

              # Extract title from first H1
              lines = content.split('\n')
              title = "AI Trading Lesson"
              for line in lines:
                  if line.startswith('# '):
                      title = line[2:].strip()
                      break

              # Add footer
              content += f"""

          ---

          *This lesson was auto-published from our [AI Trading repository](https://github.com/IgorGanapolsky/trading).*

          **More lessons**: [rag_knowledge/lessons_learned](https://github.com/IgorGanapolsky/trading/tree/main/rag_knowledge/lessons_learned)
          """

              # Publish to Dev.to
              headers = {
                  'api-key': api_key,
                  'Content-Type': 'application/json'
              }

              payload = {
                  'article': {
                      'title': f"AI Trading: {title}",
                      'body_markdown': content,
                      'published': True,
                      'tags': ['ai', 'trading', 'python', 'machinelearning'],
                      'series': 'AI Trading Journey',
                      'canonical_url': f"https://github.com/IgorGanapolsky/trading/blob/main/{lesson_path}"
                  }
              }

              try:
                  resp = requests.post(
                      'https://dev.to/api/articles',
                      headers=headers,
                      json=payload
                  )
                  if resp.status_code in [200, 201]:
                      print(f"Published: {title}")
                      print(f"URL: {resp.json().get('url')}")
                  else:
                      print(f"Failed to publish {title}: {resp.status_code}")
                      print(resp.text)
              except Exception as e:
                  print(f"Error publishing {title}: {e}")
          PYTHON

      - name: Copy lessons to docs for GitHub Pages
        run: |
          mkdir -p docs/_lessons
          for file in rag_knowledge/lessons_learned/*.md; do
            filename=$(basename "$file")
            first_line=$(head -1 "$file")

            # Check if file already has Jekyll frontmatter (starts with ---)
            if [[ "$first_line" == "---" ]]; then
              # File already has frontmatter - just copy it, adding layout if missing
              if grep -q "^layout:" "$file"; then
                # Has layout, copy as-is
                cp "$file" "docs/_lessons/$filename"
              else
                # Add layout to existing frontmatter
                sed '1,/^---$/{ /^---$/a\layout: post
                }' "$file" > "docs/_lessons/$filename"
              fi
              echo "Copied (has frontmatter): $filename"
            else
              # No frontmatter - add it
              title=$(echo "$first_line" | sed 's/^# //')

              # Extract date from filename (e.g., ll_056_xxx_dec22.md -> 2025-12-22)
              if [[ "$filename" =~ (jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)([0-9]+) ]]; then
                month="${BASH_REMATCH[1]}"
                day="${BASH_REMATCH[2]}"
                case "$month" in
                  jan) month_num="01"; year="2026" ;;
                  feb) month_num="02"; year="2026" ;;
                  mar) month_num="03"; year="2026" ;;
                  apr) month_num="04"; year="2026" ;;
                  may) month_num="05"; year="2026" ;;
                  jun) month_num="06"; year="2026" ;;
                  jul) month_num="07"; year="2026" ;;
                  aug) month_num="08"; year="2026" ;;
                  sep) month_num="09"; year="2026" ;;
                  oct) month_num="10"; year="2025" ;;
                  nov) month_num="11"; year="2025" ;;
                  dec) month_num="12"; year="2025" ;;
                esac
                day=$(printf "%02d" "$((10#$day))")
                date="${year}-${month_num}-${day}"
              else
                date=$(date +%Y-%m-%d)
              fi

              {
                echo "---"
                echo "layout: post"
                printf 'title: "%s"\n' "$title"
                echo "date: $date"
                echo "---"
                echo ""
                cat "$file"
              } > "docs/_lessons/$filename"
              echo "Added frontmatter: $filename"
            fi
          done

      - name: Create PR for docs updates
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/_lessons/
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Create branch with timestamp
          BRANCH="auto/sync-lessons-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH"
          git commit -m "docs: Sync lessons to GitHub Pages"
          git push origin "$BRANCH"

          # Create and auto-merge PR
          PR_URL=$(gh pr create --title "docs: Sync lessons to GitHub Pages" --body "Auto-synced lessons from rag_knowledge/lessons_learned/" --base main --head "$BRANCH")
          echo "Created PR: $PR_URL"

          # Auto-merge the PR
          gh pr merge "$BRANCH" --squash --delete-branch --auto || echo "Auto-merge not enabled, PR needs manual merge"
