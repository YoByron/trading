name: Phil Town Knowledge Ingestion

on:
  schedule:
    # Run daily at 6:00 AM Eastern (before market open)
    # EST: 11:00 UTC, EDT: 10:00 UTC
    - cron: '0 10,11 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: "Ingestion mode"
        required: true
        default: "recent"
        type: choice
        options:
          - recent
          - backfill
          - new

permissions:
  contents: write
  pull-requests: write

jobs:
  ingest-phil-town:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install yt-dlp youtube-transcript-api chromadb

      - name: Run Phil Town YouTube Ingestion
        run: |
          MODE="${{ github.event.inputs.mode || 'recent' }}"
          echo "Running ingestion in $MODE mode..."
          python3 scripts/ingest_phil_town_youtube.py --mode "$MODE"

      - name: Run Phil Town Blog and Podcast Ingestion
        run: |
          echo "Ingesting Phil Town blog and podcast..."
          python3 scripts/ingest_phil_town_blog.py --source all --max-articles 10

      - name: Vectorize new content into RAG
        run: |
          echo "Vectorizing content into ChromaDB..."
          python3 scripts/vectorize_rag_knowledge.py --update

          echo ""
          echo "=== RAG Stats ==="
          python3 scripts/vectorize_rag_knowledge.py --stats

      - name: Verify ingestion success
        run: |
          echo "=== Verifying Phil Town Ingestion ==="

          # Count YouTube transcripts
          TRANSCRIPT_COUNT=$(find rag_knowledge/youtube/transcripts -name "*.md" 2>/dev/null | wc -l)
          echo "YouTube transcripts: $TRANSCRIPT_COUNT"

          # Count blog articles
          BLOG_COUNT=$(find rag_knowledge/blogs/phil_town -name "*.md" 2>/dev/null | wc -l)
          echo "Blog articles: $BLOG_COUNT"

          # Verify at least one type of content exists
          TOTAL=$((TRANSCRIPT_COUNT + BLOG_COUNT))
          if [ "$TOTAL" -eq 0 ]; then
            echo "::error::INGESTION FAILED - No Phil Town content was ingested!"
            echo "This means the pipeline ran but produced zero output."
            echo "Check yt-dlp, youtube-transcript-api, and network connectivity."
            exit 1
          fi

          echo ""
          echo "=== YouTube Transcripts ==="
          ls -la rag_knowledge/youtube/transcripts/ 2>/dev/null | head -10 || echo "No transcripts"

          # Validate content contains Phil Town keywords
          if [ "$TRANSCRIPT_COUNT" -gt 0 ]; then
            echo ""
            echo "=== Content Validation ==="
            PHIL_MENTIONS=$(grep -rl -i "phil\|rule.*1\|moat\|margin.*safety" rag_knowledge/youtube/transcripts/*.md 2>/dev/null | wc -l)
            echo "Files mentioning Phil Town concepts: $PHIL_MENTIONS"
            if [ "$PHIL_MENTIONS" -eq 0 ]; then
              echo "::warning::Content may not be from Phil Town - no key concepts found"
            fi
          fi

          echo ""
          echo "=== Blog Articles ==="
          ls -la rag_knowledge/blogs/phil_town/ 2>/dev/null | head -10 || echo "No blog articles"

          echo ""
          echo "=== SUCCESS: Phil Town content ingested ==="

      - name: Create Pull Request with ingested content
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat(rag): Phil Town content ${{ github.run_id }}"
          title: "feat(rag): Phil Town content ingestion"
          body: |
            ## Automated Phil Town Content Ingestion

            - YouTube transcripts
            - Blog posts
            - Podcast content
            - Vector embeddings

            Auto-generated by Phil Town Ingestion Pipeline.
          branch: auto/phil-town-${{ github.run_id }}
          add-paths: |
            rag_knowledge/
            data/youtube_cache/
            data/blog_cache/
            data/vector_db/
          delete-branch: true
