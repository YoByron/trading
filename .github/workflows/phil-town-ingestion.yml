name: Phil Town Knowledge Ingestion

on:
  schedule:
    # Run daily at 6:00 AM Eastern (before market open)
    # EST: 11:00 UTC, EDT: 10:00 UTC
    - cron: '0 10,11 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: "Ingestion mode"
        required: true
        default: "recent"
        type: choice
        options:
          - recent
          - backfill
          - new

permissions:
  contents: write
  pull-requests: write

jobs:
  ingest-phil-town:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install yt-dlp youtube-transcript-api chromadb

      - name: Run Phil Town YouTube Ingestion
        run: |
          MODE="${{ github.event.inputs.mode || 'recent' }}"
          echo "Running ingestion in $MODE mode..."
          python3 scripts/ingest_phil_town_youtube.py --mode "$MODE"

      - name: Run Phil Town Blog and Podcast Ingestion
        run: |
          echo "Ingesting Phil Town blog and podcast..."
          python3 scripts/ingest_phil_town_blog.py --source all --max-articles 10

      - name: Vectorize new content into RAG
        run: |
          echo "Vectorizing content into ChromaDB..."
          python3 scripts/vectorize_rag_knowledge.py --update

          echo ""
          echo "=== RAG Stats ==="
          python3 scripts/vectorize_rag_knowledge.py --stats

      - name: Show ingestion results
        run: |
          echo "=== YouTube Transcripts ==="
          ls -la rag_knowledge/youtube/transcripts/ 2>/dev/null | head -10 || echo "No transcripts yet"
          echo ""
          echo "=== Blog Articles ==="
          ls -la rag_knowledge/blogs/phil_town/ 2>/dev/null | head -10 || echo "No blog articles yet"
          echo ""
          echo "=== Vector DB ==="
          ls -la data/vector_db/ 2>/dev/null || echo "No vector DB yet"

      - name: Create Pull Request with ingested content
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat(rag): Phil Town content ${{ github.run_id }}"
          title: "feat(rag): Phil Town content ingestion"
          body: |
            ## Automated Phil Town Content Ingestion

            - YouTube transcripts
            - Blog posts
            - Podcast content
            - Vector embeddings

            Auto-generated by Phil Town Ingestion Pipeline.
          branch: auto/phil-town-${{ github.run_id }}
          add-paths: |
            rag_knowledge/
            data/youtube_cache/
            data/blog_cache/
            data/vector_db/
          delete-branch: true
