name: Phil Town Knowledge Ingestion

on:
  schedule:
    # Run daily at 6:00 AM Eastern (before market open)
    # EST: 11:00 UTC, EDT: 10:00 UTC
    - cron: '0 10,11 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: "Ingestion mode"
        required: true
        default: "recent"
        type: choice
        options:
          - recent
          - backfill
          - new

permissions:
  contents: write

jobs:
  ingest-phil-town:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # Increased for backfill mode

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install yt-dlp youtube-transcript-api chromadb requests beautifulsoup4

      - name: Run Phil Town YouTube Ingestion
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: |
          MODE="${{ github.event.inputs.mode || 'recent' }}"
          echo "Running ingestion in $MODE mode..."
          echo "YOUTUBE_API_KEY: $([ -n \"$YOUTUBE_API_KEY\" ] && echo 'SET' || echo 'NOT SET - using fallback methods')"
          python3 scripts/ingest_phil_town_youtube.py --mode "$MODE"

      - name: Run Phil Town Blog and Podcast Ingestion
        run: |
          MODE="${{ github.event.inputs.mode || 'recent' }}"
          echo "Ingesting Phil Town blog and podcast..."

          # Backfill mode gets ALL articles, recent mode gets 10
          if [ "$MODE" = "backfill" ]; then
            MAX_ARTICLES=500
          else
            MAX_ARTICLES=20
          fi

          python3 scripts/ingest_phil_town_blog.py --source all --max-articles $MAX_ARTICLES

      - name: Vectorize new content into RAG
        run: |
          echo "Vectorizing content into ChromaDB..."
          python3 scripts/vectorize_rag_knowledge.py --update

          echo ""
          echo "=== RAG Stats ==="
          python3 scripts/vectorize_rag_knowledge.py --stats

      - name: Verify ingestion success
        id: verify
        run: |
          echo "=== Verifying Phil Town Ingestion ==="

          # Count YouTube transcripts
          TRANSCRIPT_COUNT=$(find rag_knowledge/youtube/transcripts -name "*.md" 2>/dev/null | wc -l)
          echo "YouTube transcripts: $TRANSCRIPT_COUNT"
          echo "transcript_count=$TRANSCRIPT_COUNT" >> $GITHUB_OUTPUT

          # Count blog articles
          BLOG_COUNT=$(find rag_knowledge/blogs/phil_town -name "*.md" 2>/dev/null | wc -l)
          echo "Blog articles: $BLOG_COUNT"
          echo "blog_count=$BLOG_COUNT" >> $GITHUB_OUTPUT

          # Count books
          BOOK_COUNT=$(find rag_knowledge/books -name "*.md" -o -name "*.json" 2>/dev/null | wc -l)
          echo "Books: $BOOK_COUNT"
          echo "book_count=$BOOK_COUNT" >> $GITHUB_OUTPUT

          # Total content
          TOTAL=$((TRANSCRIPT_COUNT + BLOG_COUNT + BOOK_COUNT))
          echo "total_count=$TOTAL" >> $GITHUB_OUTPUT

          if [ "$TOTAL" -eq 0 ]; then
            echo "::error::INGESTION FAILED - No Phil Town content was ingested!"
            exit 1
          fi

          echo ""
          echo "=== SUCCESS: Phil Town content verified ==="
          echo "Total content pieces: $TOTAL"

      - name: Commit directly to main (auto-merge)
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add all RAG content
          git add rag_knowledge/ data/youtube_cache/ data/blog_cache/ data/vector_db/

          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No new content to commit"
            exit 0
          fi

          # Get counts for commit message
          TRANSCRIPT_COUNT=${{ steps.verify.outputs.transcript_count }}
          BLOG_COUNT=${{ steps.verify.outputs.blog_count }}

          git commit -m "feat(rag): Auto-ingest Phil Town content

          YouTube transcripts: $TRANSCRIPT_COUNT
          Blog articles: $BLOG_COUNT

          Mode: ${{ github.event.inputs.mode || 'recent' }}
          Run: ${{ github.run_id }}"

          git push origin main

          echo "âœ… Content committed directly to main"
