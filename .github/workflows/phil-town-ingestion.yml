name: Phil Town Knowledge Ingestion

on:
  schedule:
    # Run daily at 6:00 AM Eastern (before market open)
    # EST: 11:00 UTC, EDT: 10:00 UTC
    - cron: '0 10,11 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: "Ingestion mode"
        required: true
        default: "recent"
        type: choice
        options:
          - recent
          - backfill
          - new

permissions:
  contents: write

jobs:
  ingest-phil-town:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install yt-dlp youtube-transcript-api chromadb

      - name: Run Phil Town YouTube Ingestion
        run: |
          MODE="${{ github.event.inputs.mode || 'recent' }}"
          echo "Running ingestion in $MODE mode..."
          python3 scripts/ingest_phil_town_youtube.py --mode "$MODE"

      - name: Run Phil Town Blog and Podcast Ingestion
        run: |
          echo "Ingesting Phil Town blog and podcast..."
          python3 scripts/ingest_phil_town_blog.py --source all --max-articles 10

      - name: Vectorize new content into RAG
        run: |
          echo "Vectorizing content into ChromaDB..."
          python3 scripts/vectorize_rag_knowledge.py --update

          echo ""
          echo "=== RAG Stats ==="
          python3 scripts/vectorize_rag_knowledge.py --stats

      - name: Show ingestion results
        run: |
          echo "=== YouTube Transcripts ==="
          ls -la rag_knowledge/youtube/transcripts/ 2>/dev/null | head -10 || echo "No transcripts yet"
          echo ""
          echo "=== Blog Articles ==="
          ls -la rag_knowledge/blogs/phil_town/ 2>/dev/null | head -10 || echo "No blog articles yet"
          echo ""
          echo "=== Vector DB ==="
          ls -la data/vector_db/ 2>/dev/null || echo "No vector DB yet"

      - name: Commit ingested content
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # Force add files that may be in .gitignore
          git add -f rag_knowledge/ 2>/dev/null || true
          git add -f data/youtube_cache/ 2>/dev/null || true
          git add -f data/blog_cache/ 2>/dev/null || true
          git add -f data/vector_db/ 2>/dev/null || true

          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No new content to commit"
          else
            git commit -m "feat(rag): Phil Town content + vectorization $(date +%Y-%m-%d)"
            # Pull any changes made since checkout, then push
            git pull --rebase origin main || true
            git push origin main
          fi
