name: Phil Town Knowledge Ingestion

on:
  schedule:
    # Run daily at 6:00 AM Eastern (before market open)
    # EST (Nov-Mar): UTC-5 -> 11:00 UTC
    # EDT (Mar-Nov): UTC-4 -> 10:00 UTC
    # Weekdays only (markets closed weekends)
    - cron: '0 10,11 * * 1-5'
  workflow_dispatch:
    inputs:
      mode:
        description: "Ingestion mode"
        required: true
        default: "recent"
        type: choice
        options:
          - recent
          - backfill
          - new

permissions:
  contents: write
  issues: write

# Prevent concurrent runs from corrupting RAG data
concurrency:
  group: phil-town-ingestion
  cancel-in-progress: true

jobs:
  ingest-phil-town:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Increased for backfill mode

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install yt-dlp youtube-transcript-api requests beautifulsoup4 sentence-transformers

      - name: Validate secrets
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: |
          if [ -z "$YOUTUBE_API_KEY" ]; then
            echo "::warning::YOUTUBE_API_KEY not set - will use fallback methods (curated list)"
            echo "For full channel ingestion, set YOUTUBE_API_KEY in repository secrets"
          else
            echo "✓ YOUTUBE_API_KEY is configured"
          fi

      - name: Run Phil Town YouTube Ingestion
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: |
          set -e
          MODE="${{ github.event.inputs.mode || 'recent' }}"
          echo "Running YouTube ingestion in $MODE mode..."
          python3 scripts/ingest_phil_town_youtube.py --mode "$MODE" || {
            echo "::error::YouTube ingestion script failed"
            exit 1
          }
          echo "✓ YouTube ingestion completed"

      - name: Run Phil Town Blog and Podcast Ingestion
        run: |
          set -e
          MODE="${{ github.event.inputs.mode || 'recent' }}"
          echo "Ingesting Phil Town blog and podcast..."

          # Backfill mode gets ALL articles, recent mode gets 100
          if [ "$MODE" = "backfill" ]; then
            MAX_ARTICLES=500
          else
            MAX_ARTICLES=100
          fi

          python3 scripts/ingest_phil_town_blog.py --source all --max-articles $MAX_ARTICLES || {
            echo "::error::Blog ingestion script failed"
            exit 1
          }
          echo "✓ Blog ingestion completed"

      - name: Vectorize new content into RAG
        run: |
          set -e
          echo "Vectorizing content into RAG..."
          python3 scripts/vectorize_rag_knowledge.py --update || {
            echo "::warning::Vectorization had issues, continuing..."
          }

          echo ""
          echo "=== RAG Stats ==="
          python3 scripts/vectorize_rag_knowledge.py --stats || true

      - name: Verify ingestion success with content validation
        id: verify
        run: |
          set -e
          echo "=== Verifying Phil Town Ingestion ==="

          # Count YouTube transcripts
          TRANSCRIPT_COUNT=$(find rag_knowledge/youtube/transcripts -name "*.md" 2>/dev/null | wc -l)
          echo "YouTube transcripts: $TRANSCRIPT_COUNT"
          echo "transcript_count=$TRANSCRIPT_COUNT" >> $GITHUB_OUTPUT

          # Count blog articles
          BLOG_COUNT=$(find rag_knowledge/blogs/phil_town -name "*.md" 2>/dev/null | wc -l)
          echo "Blog articles: $BLOG_COUNT"
          echo "blog_count=$BLOG_COUNT" >> $GITHUB_OUTPUT

          # Count books
          BOOK_COUNT=$(find rag_knowledge/books -name "*.md" -o -name "*.json" 2>/dev/null | wc -l)
          echo "Books: $BOOK_COUNT"
          echo "book_count=$BOOK_COUNT" >> $GITHUB_OUTPUT

          # Total content
          TOTAL=$((TRANSCRIPT_COUNT + BLOG_COUNT + BOOK_COUNT))
          echo "total_count=$TOTAL" >> $GITHUB_OUTPUT

          if [ "$TOTAL" -eq 0 ]; then
            echo "::error::INGESTION FAILED - No Phil Town content was ingested!"
            exit 1
          fi

          # CRITICAL: Validate content contains Phil Town key concepts
          echo ""
          echo "=== Validating Phil Town Content ==="
          FOUND_CONCEPTS=0

          for concept in "Rule #1" "moat" "margin of safety" "4 M" "sticker price" "wonderful company"; do
            if grep -ri "$concept" rag_knowledge/youtube/transcripts rag_knowledge/blogs/phil_town 2>/dev/null | head -1 | grep -q .; then
              FOUND_CONCEPTS=$((FOUND_CONCEPTS + 1))
              echo "✓ Found: \"$concept\""
            fi
          done

          if [ "$FOUND_CONCEPTS" -lt 3 ]; then
            echo "::error::CONTENT VALIDATION FAILED - Missing Phil Town key concepts!"
            echo "Found only $FOUND_CONCEPTS/6 key concepts. Content may be from wrong source."
            exit 1
          fi

          echo ""
          echo "=== SUCCESS: Phil Town content verified ==="
          echo "Total content pieces: $TOTAL"
          echo "Key concepts validated: $FOUND_CONCEPTS/6"

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add all RAG content (force add in case of gitignore)
          git add -f rag_knowledge/ data/youtube_cache/ data/blog_cache/ 2>/dev/null || true

          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No new content to commit"
            exit 0
          fi

          # Get counts for commit message
          TRANSCRIPT_COUNT=${{ steps.verify.outputs.transcript_count }}
          BLOG_COUNT=${{ steps.verify.outputs.blog_count }}

          git commit -m "feat(rag): Auto-ingest Phil Town content

          YouTube transcripts: $TRANSCRIPT_COUNT
          Blog articles: $BLOG_COUNT

          Mode: ${{ github.event.inputs.mode || 'recent' }}
          Run: ${{ github.run_id }}"

          git push origin main || {
            echo "::warning::Direct push to main failed, may need branch protection adjustment"
            exit 1
          }

          echo "✅ Content committed directly to main"

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = '❌ Phil Town Ingestion Failed';
            const body = `## Ingestion Failure Report

            **Workflow Run**: [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            **Branch**: ${context.ref}
            **Mode**: ${{ github.event.inputs.mode || 'recent' }}
            **Timestamp**: ${new Date().toISOString()}

            ### Action Required
            1. Check the workflow logs for error details
            2. Verify YOUTUBE_API_KEY secret is configured
            3. Check if ruleoneinvesting.com blog is accessible
            4. Re-run the workflow manually if transient failure

            ### Quick Links
            - [Workflow Logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            - [Ingestion Script](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/blob/main/scripts/ingest_phil_town_youtube.py)
            `;

            // Check for existing open issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ingestion-failure'
            });

            if (issues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['ingestion-failure', 'automated']
              });
              console.log('Created new issue for ingestion failure');
            } else {
              // Comment on existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: `### New Failure\n\n${body}`
              });
              console.log('Commented on existing issue');
            }
