name: System Health Alert

on:
  schedule:
    # Run every 6 hours: 0:00, 6:00, 12:00, 18:00 UTC
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      force_check:
        description: 'Force health check regardless of recent status'
        required: false
        default: 'false'

permissions:
  contents: read
  issues: write

jobs:
  health-check:
    name: Monitor System Health
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install alpaca-py pyyaml

      - name: Run health monitor
        id: health_check
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        run: |
          echo "üè• Running system health checks..."

          # Run health monitor and capture output
          if python3 scripts/health_monitor.py > health_output.txt 2>&1; then
            echo "health_status=healthy" >> $GITHUB_OUTPUT
            echo "‚úÖ System is healthy"
            cat health_output.txt
          else
            echo "health_status=unhealthy" >> $GITHUB_OUTPUT
            echo "‚ùå System is unhealthy"
            cat health_output.txt

            # Save output for issue creation
            echo "HEALTH_OUTPUT<<EOF" >> $GITHUB_ENV
            cat health_output.txt >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi

      - name: Create GitHub issue on failure
        if: steps.health_check.outputs.health_status == 'unhealthy'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const healthOutput = process.env.HEALTH_OUTPUT;
            const timestamp = new Date().toISOString();

            // Check if there's already an open health alert issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-alert,auto-alert',
              per_page: 1
            });

            if (issues.data.length > 0) {
              // Update existing issue
              const issue = issues.data[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `## Health Check Failed Again\n\n**Time**: ${timestamp}\n\n\`\`\`\n${healthOutput}\n\`\`\``
              });
              console.log(`Updated existing health alert issue #${issue.number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üö® ALERT: Trading system health check failed - ${new Date().toISOString().split('T')[0]}`,
                labels: ['critical', 'health-alert', 'auto-alert'],
                body: `## System Health Alert

            **Detected**: ${timestamp}
            **Severity**: CRITICAL
            **Auto-generated**: This issue was created automatically by the health monitoring system

            ---

            ### Health Check Results

            \`\`\`
            ${healthOutput}
            \`\`\`

            ---

            ### Recommended Actions

            1. **Check Recent Trades**: Verify trades are executing
               - Look at \`data/trades_YYYY-MM-DD.json\` files
               - Run: \`python3 scripts/verify_trades.py\`

            2. **Check Workflow Runs**: Review failed workflows
               - Visit: https://github.com/${context.repo.owner}/${context.repo.repo}/actions
               - Look for recent failures

            3. **Check System State**: Verify state file is current
               - Review: \`data/system_state.json\`
               - Check \`last_updated\` timestamp

            4. **Check Alpaca Connection**: Verify API connectivity
               - Run health check locally with credentials
               - Check Alpaca status page

            5. **Review Lessons Learned**: Check for similar past failures
               - \`rag_knowledge/lessons_learned/\`
               - Look for related failure patterns

            ---

            ### Auto-Resolution

            This issue will automatically close when the health check passes again.

            **Monitoring Frequency**: Every 6 hours
            **Detection Window**: 2 days of trade history
            **Failure Threshold**: >60% workflow failure rate

            ---

            ü§ñ Generated by Health Monitoring System (P1 Action)`
              });
              console.log(`Created new health alert issue #${issue.data.number}`);
            }

      - name: Close resolved health issues
        if: steps.health_check.outputs.health_status == 'healthy'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Find open health alert issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-alert,auto-alert'
            });

            // Close them with resolution comment
            for (const issue of issues.data) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `## ‚úÖ System Health Restored\n\n**Time**: ${new Date().toISOString()}\n\nHealth check is now passing. Auto-closing this issue.`
              });

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'completed'
              });

              console.log(`Closed resolved health alert issue #${issue.number}`);
            }

      - name: Upload health check logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: health-check-logs-${{ github.run_id }}
          path: health_output.txt
          retention-days: 7
