name: Force Crypto Trade (World-Class Strategy)

on:
  push:
    paths:
      - '.github/FORCE_CRYPTO'
    branches: ['*']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  crypto-trade:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install alpaca-py yfinance pandas numpy requests

      - name: Execute Crypto Trade
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        run: |
          python3 << 'PYTHON'
          """
          World-Class Crypto Trading Strategy v4.0 (Trend-Aware)

          RESEARCH-BACKED:
          - Only buy when price > 50-day MA (5x better returns per Coinbase)
          - Fear & Greed for SIZING only, not timing
          - Stop catching falling knives
          """
          import os, sys, json, traceback, requests
          from datetime import datetime, timezone

          today = datetime.now(timezone.utc).strftime("%Y-%m-%d")
          result = {"timestamp": datetime.now(timezone.utc).isoformat(), "date": today, "strategy": "WorldClassCrypto", "strategy_version": "4.0"}

          def save():
              os.makedirs("data", exist_ok=True)
              f = f"data/trades_{today}.json"
              t = json.load(open(f)) if os.path.exists(f) else []
              if not isinstance(t, list): t = [t]
              t.append(result)
              json.dump(t, open(f, "w"), indent=2)
              print(f"‚úÖ Saved to {f}")

          api_key, secret = os.environ.get("ALPACA_API_KEY",""), os.environ.get("ALPACA_SECRET_KEY","")
          print("=" * 60)
          print("üåç WORLD-CLASS CRYPTO STRATEGY v4.0 (Trend-Aware)")
          print("   Only buy when price > 50-day MA")
          print("=" * 60)

          if not api_key or not secret:
              result["error"], result["status"] = "MISSING_SECRETS", "FAILED"
              save()
              sys.exit(0)

          try:
              from alpaca.trading.client import TradingClient
              from alpaca.trading.requests import MarketOrderRequest
              from alpaca.trading.enums import OrderSide, TimeInForce
              import yfinance as yf

              client = TradingClient(api_key, secret, paper=True)
              acct = client.get_account()
              result["account_value"] = float(acct.equity)
              print(f"‚úÖ Account: ${result['account_value']:,.2f}")

              # STEP 1: TREND CHECK (50-day MA)
              print("\nüìä STEP 1: Trend Check (50-day MA)")
              print("-" * 40)
              trend_data = {}
              for s in ["BTC-USD","ETH-USD","SOL-USD"]:
                  try:
                      h = yf.Ticker(s).history(period="60d")
                      if len(h) >= 50:
                          price = float(h["Close"].iloc[-1])
                          ma50 = float(h["Close"].rolling(50).mean().iloc[-1])
                          above = price > ma50
                          pct = ((price - ma50) / ma50) * 100
                          chg = ((h["Close"].iloc[-1] - h["Close"].iloc[-7]) / h["Close"].iloc[-7]) * 100
                          trend_data[s] = {"price":price,"ma50":ma50,"above":above,"pct":pct,"chg7d":chg}
                          st = "‚úÖ ABOVE" if above else "‚ùå BELOW"
                          print(f"   {s}: ${price:,.0f} | MA50: ${ma50:,.0f} | {st} ({pct:+.1f}%)")
                  except Exception as e:
                      print(f"   {s}: Error - {e}")

              result["trend_analysis"] = trend_data
              above_ma = {k:v for k,v in trend_data.items() if v.get("above")}

              if not above_ma:
                  print("\n‚õî ALL CRYPTOS BELOW 50-DAY MA - SKIPPING")
                  print("   Research: Buying below MA = catching falling knife")
                  result["action"] = "SKIP"
                  result["skip_reason"] = "All below 50-day MA - waiting for trend"
                  result["status"] = "WAITING_FOR_TREND"
                  save()
                  sys.exit(0)

              # STEP 2: Fear & Greed (for sizing only)
              print("\nüìä STEP 2: Fear & Greed (sizing only)")
              mult = 1.0
              try:
                  fng = requests.get("https://api.alternative.me/fng/", timeout=10).json()
                  fv = int(fng["data"][0]["value"])
                  result["fear_greed_index"] = fv
                  fc = fng["data"][0]["value_classification"]
                  result["fear_greed_class"] = fc
                  print(f"   Value: {fv} ({fc})")
                  if fv <= 25: mult = 1.5; print("   üü¢ EXTREME FEAR + TREND = 1.5x")
                  elif fv <= 40: mult = 1.25; print("   üü¢ FEAR + TREND = 1.25x")
                  elif fv <= 60: mult = 1.0; print("   üü° NEUTRAL + TREND = 1.0x")
                  elif fv <= 75: mult = 0.75; print("   üü† GREED + TREND = 0.75x")
                  else:
                      print("   üî¥ EXTREME GREED - Skip")
                      result["action"], result["skip_reason"] = "SKIP", "Extreme greed"
                      save()
                      sys.exit(0)
              except: pass

              # STEP 3: Select best (above MA only)
              print("\nüéØ STEP 3: Select Best (above MA)")
              best_item = max(above_ma.items(), key=lambda x: x[1]["chg7d"])
              best, best_data = best_item[0].replace("-USD","USD"), best_item[1]
              print(f"   Selected: {best} (+{best_data['pct']:.1f}% above MA)")

              # STEP 4: Execute
              print("\nüí∞ STEP 4: Execute Trade")
              base = 10.0
              amt = min(base * mult, result["account_value"] * 0.02)
              if amt < 1: amt = 1
              print(f"   Amount: ${amt:.2f} (base ${base} √ó {mult}x)")

              order = client.submit_order(MarketOrderRequest(
                  symbol=best, notional=amt, side=OrderSide.BUY, time_in_force=TimeInForce.GTC))
              print(f"   ‚úÖ Order: {order.id}")

              result.update({
                  "symbol": best, "action": "BUY", "notional": amt,
                  "price": best_data["price"], "order_id": str(order.id),
                  "status": str(order.status), "size_multiplier": mult,
                  "trend_confirmed": True, "pct_above_ma": best_data["pct"]
              })

          except Exception as e:
              print(f"\n‚ùå ERROR: {e}")
              traceback.print_exc()
              result["error"], result["status"] = str(e), "FAILED"

          save()
          print("\n" + "=" * 60)
          print(json.dumps({k:v for k,v in result.items() if k != "trend_analysis"}, indent=2))
          PYTHON

      - name: Commit trade data
        if: always()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "trade: crypto v4.0 (trend-aware) [skip ci]"
          file_pattern: "data/trades_*.json"
          commit_user_name: "GitHub Actions Bot"
          commit_user_email: "actions@github.com"
