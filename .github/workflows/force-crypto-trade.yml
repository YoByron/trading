name: Force Crypto Trade (World-Class Strategy)

on:
  push:
    paths:
      - '.github/FORCE_CRYPTO'
    branches: ['*']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  crypto-trade:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install alpaca-py yfinance pandas numpy requests

      - name: Execute Crypto Trade
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        run: |
          python3 << 'PYTHON'
          """
          World-Class Crypto Trading Strategy v4.1 (Trend + Momentum)

          RESEARCH-BACKED:
          - Only buy when price > 50-day MA (5x better returns per Coinbase)
          - RSI > 50 confirms momentum is bullish
          - Fear & Greed for SIZING only, not timing
          - Stop catching falling knives
          """
          import os, sys, json, traceback, requests
          from datetime import datetime, timezone

          today = datetime.now(timezone.utc).strftime("%Y-%m-%d")
          result = {"timestamp": datetime.now(timezone.utc).isoformat(), "date": today, "strategy": "WorldClassCrypto", "strategy_version": "4.1"}

          def save():
              os.makedirs("data", exist_ok=True)
              f = f"data/trades_{today}.json"
              t = json.load(open(f)) if os.path.exists(f) else []
              if not isinstance(t, list): t = [t]
              t.append(result)
              json.dump(t, open(f, "w"), indent=2)
              print(f"‚úÖ Saved to {f}")

          api_key, secret = os.environ.get("ALPACA_API_KEY",""), os.environ.get("ALPACA_SECRET_KEY","")
          print("=" * 60)
          print("üåç WORLD-CLASS CRYPTO STRATEGY v4.1 (Trend + Momentum)")
          print("   Only buy when price > 50-day MA AND RSI > 50")
          print("=" * 60)

          if not api_key or not secret:
              result["error"], result["status"] = "MISSING_SECRETS", "FAILED"
              save()
              sys.exit(0)

          try:
              from alpaca.trading.client import TradingClient
              from alpaca.trading.requests import MarketOrderRequest
              from alpaca.trading.enums import OrderSide, TimeInForce
              import yfinance as yf

              client = TradingClient(api_key, secret, paper=True)
              acct = client.get_account()
              result["account_value"] = float(acct.equity)
              print(f"‚úÖ Account: ${result['account_value']:,.2f}")

              # STEP 1: TREND + MOMENTUM CHECK (50-day MA + RSI)
              print("\nüìä STEP 1: Trend + Momentum Check")
              print("-" * 40)

              def calc_rsi(prices, period=14):
                  """Calculate RSI (Relative Strength Index)"""
                  delta = prices.diff()
                  gain = delta.where(delta > 0, 0).rolling(window=period).mean()
                  loss = (-delta.where(delta < 0, 0)).rolling(window=period).mean()
                  rs = gain / loss
                  return 100 - (100 / (1 + rs))

              trend_data = {}
              for s in ["BTC-USD","ETH-USD","SOL-USD"]:
                  try:
                      h = yf.Ticker(s).history(period="60d")
                      if len(h) >= 50:
                          price = float(h["Close"].iloc[-1])
                          ma50 = float(h["Close"].rolling(50).mean().iloc[-1])
                          rsi = float(calc_rsi(h["Close"]).iloc[-1])
                          above_ma = price > ma50
                          rsi_bullish = rsi > 50
                          pct = ((price - ma50) / ma50) * 100
                          chg = ((h["Close"].iloc[-1] - h["Close"].iloc[-7]) / h["Close"].iloc[-7]) * 100

                          trend_data[s] = {
                              "price": price, "ma50": ma50, "above_ma": above_ma,
                              "rsi": rsi, "rsi_bullish": rsi_bullish,
                              "pct": pct, "chg7d": chg,
                              "valid": above_ma and rsi_bullish  # Both conditions must be true
                          }

                          ma_st = "‚úÖ" if above_ma else "‚ùå"
                          rsi_st = "‚úÖ" if rsi_bullish else "‚ùå"
                          print(f"   {s}: ${price:,.0f}")
                          print(f"      MA50: ${ma50:,.0f} {ma_st} ({pct:+.1f}%)")
                          print(f"      RSI:  {rsi:.1f} {rsi_st} (>50 = bullish)")
                  except Exception as e:
                      print(f"   {s}: Error - {e}")

              result["trend_analysis"] = trend_data
              valid_cryptos = {k:v for k,v in trend_data.items() if v.get("valid")}

              if not valid_cryptos:
                  # Check why we're skipping
                  above_ma_only = [k for k,v in trend_data.items() if v.get("above_ma")]
                  rsi_only = [k for k,v in trend_data.items() if v.get("rsi_bullish")]

                  print("\n‚õî NO VALID ENTRIES - SKIPPING")
                  if not above_ma_only:
                      print("   ‚ùå All below 50-day MA (no trend)")
                      skip_reason = "All below 50-day MA"
                  elif not rsi_only:
                      print("   ‚ùå All RSI < 50 (weak momentum)")
                      skip_reason = "All RSI below 50"
                  else:
                      print("   ‚ùå No crypto has BOTH trend + momentum")
                      skip_reason = "No trend+momentum alignment"

                  result["action"] = "SKIP"
                  result["skip_reason"] = skip_reason
                  result["status"] = "WAITING_FOR_SIGNAL"
                  save()
                  sys.exit(0)

              # STEP 2: Fear & Greed (for sizing only)
              print("\nüìä STEP 2: Fear & Greed (sizing only)")
              mult = 1.0
              try:
                  fng = requests.get("https://api.alternative.me/fng/", timeout=10).json()
                  fv = int(fng["data"][0]["value"])
                  result["fear_greed_index"] = fv
                  fc = fng["data"][0]["value_classification"]
                  result["fear_greed_class"] = fc
                  print(f"   Value: {fv} ({fc})")
                  if fv <= 25: mult = 1.5; print("   üü¢ EXTREME FEAR + TREND = 1.5x")
                  elif fv <= 40: mult = 1.25; print("   üü¢ FEAR + TREND = 1.25x")
                  elif fv <= 60: mult = 1.0; print("   üü° NEUTRAL + TREND = 1.0x")
                  elif fv <= 75: mult = 0.75; print("   üü† GREED + TREND = 0.75x")
                  else:
                      print("   üî¥ EXTREME GREED - Skip")
                      result["action"], result["skip_reason"] = "SKIP", "Extreme greed"
                      save()
                      sys.exit(0)
              except: pass

              # STEP 3: Select best (valid cryptos only)
              print("\nüéØ STEP 3: Select Best (trend + momentum confirmed)")
              best_item = max(valid_cryptos.items(), key=lambda x: x[1]["chg7d"])
              best, best_data = best_item[0].replace("-USD","USD"), best_item[1]
              print(f"   Selected: {best}")
              print(f"   üìà {best_data['pct']:+.1f}% above MA, RSI {best_data['rsi']:.1f}")

              # STEP 4: Execute
              print("\nüí∞ STEP 4: Execute Trade")
              base = 10.0
              amt = min(base * mult, result["account_value"] * 0.02)
              if amt < 1: amt = 1
              print(f"   Amount: ${amt:.2f} (base ${base} √ó {mult}x)")

              order = client.submit_order(MarketOrderRequest(
                  symbol=best, notional=amt, side=OrderSide.BUY, time_in_force=TimeInForce.GTC))
              print(f"   ‚úÖ Order: {order.id}")

              result.update({
                  "symbol": best, "action": "BUY", "notional": amt,
                  "price": best_data["price"], "order_id": str(order.id),
                  "status": str(order.status), "size_multiplier": mult,
                  "trend_confirmed": True, "pct_above_ma": best_data["pct"],
                  "rsi": best_data["rsi"], "momentum_confirmed": True
              })

          except Exception as e:
              print(f"\n‚ùå ERROR: {e}")
              traceback.print_exc()
              result["error"], result["status"] = str(e), "FAILED"

          save()
          print("\n" + "=" * 60)
          print(json.dumps({k:v for k,v in result.items() if k != "trend_analysis"}, indent=2))
          PYTHON

      - name: Commit trade data
        if: always()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "trade: crypto v4.1 (trend+momentum) [skip ci]"
          file_pattern: "data/trades_*.json"
          commit_user_name: "GitHub Actions Bot"
          commit_user_email: "actions@github.com"
