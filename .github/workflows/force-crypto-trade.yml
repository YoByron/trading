name: Force Crypto Trade

on:
  push:
    paths:
      - '.github/FORCE_CRYPTO'
    branches: ['*']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  crypto-trade:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
      CRYPTO_FORCE_TRADE: 'true'
      CRYPTO_RSI_OVERBOUGHT: '85'
      CRYPTO_VOLUME_THRESHOLD: '0.05'
      CRYPTO_DAILY_AMOUNT: '10.0'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install alpaca-py yfinance pandas numpy

      - name: Execute Crypto Trade
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          APCA_API_KEY_ID: ${{ secrets.ALPACA_API_KEY }}
          APCA_API_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        run: |
          python3 << 'PYTHON'
          import os
          import sys
          import json
          from datetime import datetime, timezone

          today = datetime.now(timezone.utc).strftime("%Y-%m-%d")
          result = {"timestamp": datetime.now(timezone.utc).isoformat(), "date": today, "strategy": "CryptoForce"}

          api_key = os.environ.get("ALPACA_API_KEY", "")
          secret = os.environ.get("ALPACA_SECRET_KEY", "")

          print(f"üîê API Key present: {len(api_key) > 0}")
          print(f"üîê Secret present: {len(secret) > 0}")

          if not api_key or not secret:
              result["error"] = "MISSING_SECRETS"
              result["status"] = "FAILED"
              print("‚ùå ERROR: Alpaca secrets not configured!")
              sys.exit(1)

          try:
              from alpaca.trading.client import TradingClient
              from alpaca.trading.requests import MarketOrderRequest
              from alpaca.trading.enums import OrderSide, TimeInForce
              import yfinance as yf

              print("üîó Connecting to Alpaca Paper...")
              client = TradingClient(api_key, secret, paper=True)

              account = client.get_account()
              print(f"üí∞ Connected! Cash: ${float(account.cash):,.2f}")
              result["account_cash"] = float(account.cash)

              # Get current crypto prices
              cryptos = ["BTC-USD", "ETH-USD", "SOL-USD"]
              best_crypto = None
              best_score = -999

              print("\nüìä Analyzing crypto market conditions:")
              for symbol in cryptos:
                  try:
                      ticker = yf.Ticker(symbol)
                      hist = ticker.history(period="5d")
                      if not hist.empty:
                          current = hist['Close'].iloc[-1]
                          prev = hist['Close'].iloc[0]
                          change_pct = ((current - prev) / prev) * 100
                          print(f"  {symbol}: ${current:,.2f} | 5-day: {change_pct:+.2f}%")

                          # Simple momentum score
                          if change_pct > best_score:
                              best_score = change_pct
                              best_crypto = symbol
                  except Exception as e:
                      print(f"  {symbol}: Error - {e}")

              # Default to BTC if no clear winner
              if not best_crypto:
                  best_crypto = "BTC-USD"
                  print("‚ö†Ô∏è Using BTC as fallback")

              alpaca_symbol = best_crypto.replace("-USD", "USD")
              print(f"\nüéØ Selected: {alpaca_symbol} (score: {best_score:+.2f}%)")

              # Get current price for quantity calculation
              ticker = yf.Ticker(best_crypto)
              current_price = ticker.history(period="1d")['Close'].iloc[-1]

              # Calculate quantity for $10 trade
              amount = 10.0
              qty = round(amount / current_price, 6)

              print(f"üìà Submitting order: {qty:.6f} {alpaca_symbol} @ ~${current_price:,.2f}")

              order = client.submit_order(MarketOrderRequest(
                  symbol=alpaca_symbol,
                  notional=amount,  # Use notional for fractional crypto
                  side=OrderSide.BUY,
                  time_in_force=TimeInForce.GTC  # Good-til-cancelled for crypto
              ))

              print(f"‚úÖ Order submitted: {order.id}")
              print(f"üìã Status: {order.status}")

              result["symbol"] = alpaca_symbol
              result["action"] = "BUY"
              result["notional"] = amount
              result["estimated_qty"] = qty
              result["price"] = current_price
              result["order_id"] = str(order.id)
              result["status"] = str(order.status)
              result["momentum_score"] = best_score

          except Exception as e:
              print(f"‚ùå ERROR: {e}")
              import traceback
              traceback.print_exc()
              result["error"] = str(e)
              result["status"] = "FAILED"

          # Write result
          os.makedirs("data", exist_ok=True)

          # Load existing trades or create new list
          trades_file = f"data/trades_{today}.json"
          trades = []
          if os.path.exists(trades_file):
              try:
                  with open(trades_file) as f:
                      trades = json.load(f)
                      if not isinstance(trades, list):
                          trades = [trades]
              except:
                  trades = []

          trades.append(result)

          with open(trades_file, "w") as f:
              json.dump(trades, f, indent=2)

          print(f"\nüìÅ Written to {trades_file}")
          print(json.dumps(result, indent=2))
          PYTHON

      - name: Commit trade data
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "trade: crypto force-trade executed [skip ci]"
          file_pattern: "data/trades_*.json"
          commit_user_name: "GitHub Actions Bot"
          commit_user_email: "actions@github.com"
