name: Dependency Health Monitor

# Runs daily before trading workflow to catch issues early
on:
  schedule:
    - cron: '0 13 * * *'  # 8 AM ET (before 9:35 AM trading)
  push:
    paths:
      - 'requirements.txt'
      - 'requirements*.txt'
  pull_request:
    paths:
      - 'requirements.txt'
      - 'requirements*.txt'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  check-dependencies:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check for dependency conflicts
        id: check-conflicts
        run: |
          echo "### Dependency Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run pip check with dry-run to find conflicts
          echo "#### Conflict Analysis" >> $GITHUB_STEP_SUMMARY

          pip install --dry-run -r requirements.txt 2>&1 | tee /tmp/pip_output.txt

          if grep -qE "ERROR|conflicting|conflict|ResolutionImpossible" /tmp/pip_output.txt; then
            echo "âŒ **DEPENDENCY CONFLICTS DETECTED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -E "ERROR|conflict|Conflict|ResolutionImpossible" /tmp/pip_output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "CONFLICTS_FOUND=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… No dependency conflicts found" >> $GITHUB_STEP_SUMMARY
            echo "CONFLICTS_FOUND=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for security vulnerabilities
        if: always()
        run: |
          pip install pip-audit
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Security Audit" >> $GITHUB_STEP_SUMMARY

          pip-audit -r requirements.txt --desc 2>&1 | tee /tmp/audit.txt || true

          if grep -qE "found [1-9]" /tmp/audit.txt; then
            echo "âš ï¸ **Security vulnerabilities found** (non-blocking)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/audit.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No known vulnerabilities" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for outdated packages
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Package Freshness" >> $GITHUB_STEP_SUMMARY

          # Check specific critical packages
          pip install pip-tools

          # Check alpaca-trade-api deprecation status
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Critical Package Status:**" >> $GITHUB_STEP_SUMMARY

          # alpaca-trade-api is deprecated
          if grep -q "alpaca-trade-api" requirements.txt; then
            echo "âš ï¸ \`alpaca-trade-api\` is deprecated - migrate to \`alpaca-py\`" >> $GITHUB_STEP_SUMMARY
          fi

          # Check yfinance version for websockets issues
          YFINANCE_VERSION=$(grep "yfinance==" requirements.txt | cut -d'=' -f3)
          if [[ "$YFINANCE_VERSION" > "0.2.58" ]]; then
            echo "âš ï¸ \`yfinance $YFINANCE_VERSION\` has websockets dependency - verify compatibility" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… \`yfinance $YFINANCE_VERSION\` - compatible (no websockets)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create issue on failure
        if: failure() && steps.check-conflicts.outputs.CONFLICTS_FOUND == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸš¨ Dependency Conflict Detected';
            const body = `## Automatic Dependency Health Alert

            The dependency health check has detected conflicts in \`requirements.txt\`.

            **This will cause the Daily Trading workflow to fail.**

            ### Action Required
            1. Review the workflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
            2. Fix dependency conflicts in \`requirements.txt\`
            3. Test locally with \`pip install --dry-run -r requirements.txt\`

            ### Common Fixes
            - **websockets conflict**: Downgrade yfinance to 0.2.58 or migrate to alpaca-py
            - **numpy conflict**: Pin to \`numpy>=1.26.4,<2.0.0\`
            - **langchain-community**: Pin to 0.3.x for numpy<2 compatibility

            ---
            *This issue was created automatically by the Dependency Health Monitor workflow.*
            `;

            // Check for existing open issues with same title
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dependencies,automated'
            });

            const existingIssue = issues.data.find(i => i.title === title);

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['dependencies', 'automated', 'urgent']
              });
              console.log('Created new issue for dependency conflict');
            } else {
              console.log('Issue already exists:', existingIssue.number);
            }

      - name: Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Dependency Health Monitor runs daily at 8 AM ET*" >> $GITHUB_STEP_SUMMARY
          echo "*Triggered by: ${{ github.event_name }}*" >> $GITHUB_STEP_SUMMARY
