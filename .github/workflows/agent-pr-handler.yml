name: Agentic PR Handler

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  agent-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout base repository (safe)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
        # SECURITY: Don't checkout PR code directly - use GitHub API instead
        # This prevents untrusted code from running with write permissions

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install dependencies
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          uv pip sync --system requirements-minimal.txt
          # Fix anthropic SDK compatibility (httpx 0.28+ removed 'proxies' arg)
          uv pip install --system "anthropic>=0.73.0,<1.0.0" "httpx>=0.27.0,<0.28.0"

      - name: Run PR Agent
        continue-on-error: true  # Advisory only - don't block PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Create a temporary script to run the agent
          cat <<EOF > run_agent.py
          import os
          import json
          from src.agents.pr_agent import PRAgent

          def main():
              agent = PRAgent()

              # Mock file list for now (in real usage, fetch via GitHub API)
              files = ["requirements.txt"]

              data = {
                  "title": os.environ.get("PR_TITLE", ""),
                  "body": os.environ.get("PR_BODY", ""),
                  "files": files
              }

              result = agent.analyze(data)
              print(json.dumps(result, indent=2))

              # In a real scenario, we would use PyGithub to post the comment
              # For now, just print to stdout for logs

          if __name__ == "__main__":
              main()
          EOF

          python run_agent.py
