name: ADK Diagnostic

on:
  workflow_dispatch:
    inputs:
      timeout_seconds:
        description: "Health check timeout in seconds"
        required: false
        default: "60"
      verbose_logging:
        description: "Enable verbose logging"
        required: false
        default: "true"
  schedule:
    # Run weekly on Sundays at 2 AM UTC for health checks
    - cron: '0 2 * * 0'

permissions:
  contents: read

jobs:
  diagnose-adk-startup:
    name: ADK Startup Diagnostics
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.4"

      - name: Build ADK orchestrator
        run: |
          cd go/adk_trading
          echo "ðŸ”¨ Building ADK orchestrator..."
          go build -v -o /tmp/trading_orchestrator ./cmd/trading_orchestrator
          echo "âœ… Build successful"

      - name: Check build artifacts
        run: |
          if [ -f /tmp/trading_orchestrator ]; then
            echo "âœ… Binary exists"
            ls -lh /tmp/trading_orchestrator
            file /tmp/trading_orchestrator
          else
            echo "âŒ Binary not found"
            exit 1
          fi

      - name: Start ADK service with diagnostics
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          ADK_PORT: '8080'
          ADK_HEALTH_ADDR: ':8091'
          ADK_DATA_DIR: '${{ github.workspace }}/data'
          ADK_LOG_PATH: '${{ github.workspace }}/logs/adk_orchestrator.jsonl'
        run: |
          echo "ðŸš€ Starting ADK orchestrator service with diagnostics..."
          mkdir -p logs
          
          # Start service in background with verbose output
          cd go/adk_trading
          timeout 120 go run ./cmd/trading_orchestrator \
            --data_dir ../../data \
            --log_path ../../logs/adk_orchestrator.jsonl \
            --app trading_orchestrator \
            web --port 8080 api --webui_address localhost:8080 \
            > ../../logs/adk_service_startup.log 2>&1 &
          
          SERVICE_PID=$!
          echo "SERVICE_PID=$SERVICE_PID" >> $GITHUB_ENV
          echo "Service started with PID: $SERVICE_PID"
          
          # Wait a moment for process to start
          sleep 2
          
          # Check if process is still running
          if ! ps -p $SERVICE_PID > /dev/null 2>&1; then
            echo "âŒ Service process died immediately"
            echo "=== Startup Log ==="
            tail -50 ../../logs/adk_service_startup.log || echo "No log file"
            exit 1
          fi
          
          echo "âœ… Service process is running"

      - name: Health check with timeout
        timeout-minutes: 2
        env:
          TIMEOUT_SECONDS: ${{ github.event.inputs.timeout_seconds || '60' }}
        run: |
          echo "ðŸ¥ Performing health check (timeout: ${TIMEOUT_SECONDS}s)..."
          
          ADK_READY=false
          MAX_ATTEMPTS=$TIMEOUT_SECONDS
          
          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "  Health check attempt $i/$MAX_ATTEMPTS..."
            
            # Check both endpoints
            if curl -f -s http://localhost:8080/api/health > /dev/null 2>&1; then
              echo "âœ… API health endpoint responded"
              ADK_READY=true
              break
            fi
            
            if curl -f -s http://localhost:8091/healthz > /dev/null 2>&1; then
              echo "âœ… Observability health endpoint responded"
              ADK_READY=true
              break
            fi
            
            # Show process status
            if [ -n "$SERVICE_PID" ]; then
              if ps -p $SERVICE_PID > /dev/null 2>&1; then
                echo "    Process still running (PID: $SERVICE_PID)"
              else
                echo "âŒ Process died during startup"
                echo "=== Recent Logs ==="
                tail -100 logs/adk_service_startup.log || echo "No log file"
                exit 1
              fi
            fi
            
            sleep 1
          done
          
          if [ "$ADK_READY" = "true" ]; then
            echo "âœ… ADK service is ready!"
            
            # Get detailed health info
            echo ""
            echo "=== API Health Response ==="
            curl -s http://localhost:8080/api/health | jq . || curl -s http://localhost:8080/api/health
            
            echo ""
            echo "=== Observability Health Response ==="
            curl -s http://localhost:8091/healthz | jq . || curl -s http://localhost:8091/healthz
            
            echo ""
            echo "=== Service Logs (last 50 lines) ==="
            tail -50 logs/adk_service_startup.log || echo "No log file"
          else
            echo "âŒ ADK service did not become ready within ${TIMEOUT_SECONDS} seconds"
            echo ""
            echo "=== Full Startup Log ==="
            cat logs/adk_service_startup.log || echo "No log file"
            echo ""
            echo "=== Process Status ==="
            ps aux | grep trading_orchestrator || echo "No process found"
            echo ""
            echo "=== Network Ports ==="
            netstat -tuln | grep -E ':(8080|8091)' || ss -tuln | grep -E ':(8080|8091)' || echo "No ports listening"
            exit 1
          fi

      - name: Test API endpoints
        if: success()
        run: |
          echo "ðŸ§ª Testing API endpoints..."
          
          # Test health endpoint
          echo "Testing /api/health..."
          curl -f http://localhost:8080/api/health || echo "âš ï¸  Health endpoint failed"
          
          # Test observability endpoint
          echo "Testing /healthz..."
          curl -f http://localhost:8091/healthz || echo "âš ï¸  Observability endpoint failed"

      - name: Cleanup
        if: always()
        run: |
          if [ -n "$SERVICE_PID" ]; then
            echo "ðŸ§¹ Stopping ADK service (PID: $SERVICE_PID)..."
            kill $SERVICE_PID 2>/dev/null || true
            sleep 2
            kill -9 $SERVICE_PID 2>/dev/null || true
          fi
          
          # Kill any remaining processes
          pkill -f trading_orchestrator || true

      - name: Upload diagnostic logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: adk-diagnostic-logs-${{ github.run_id }}
          path: |
            logs/adk_service_startup.log
            logs/adk_orchestrator.jsonl
          retention-days: 7

