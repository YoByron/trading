name: Daily Performance Tracking

on:
  schedule:
    # Run daily at 5:00 PM Eastern (after markets close)
    # AUTOMATIC DST HANDLING: Runs at both times to cover EST/EDT transitions
    # EST (Nov-Mar): UTC-5 -> 5:00 PM ET = 22:00 UTC
    # EDT (Mar-Nov): UTC-4 -> 5:00 PM ET = 21:00 UTC
    - cron: '0 21,22 * * *'   # 5:00 PM Eastern daily (covers both EST and EDT)
  workflow_dispatch:
    inputs:
      force_update:
        description: "Force update even if entry exists for today"
        required: false
        default: "true"

permissions:
  contents: write

# Ensure only one performance update runs at a time
concurrency:
  group: daily-performance-tracking
  cancel-in-progress: false

jobs:
  update-performance-log:
    name: Update Daily Performance Log
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install alpaca-py python-dotenv

      - name: Update performance log with current account data
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          PAPER_TRADING: 'true'
        run: |
          echo "üìä Updating performance log with current Alpaca account data..."
          echo "=================================================="
          python3 scripts/update_performance_log.py
          echo "=================================================="

      - name: Verify performance log was updated
        run: |
          echo "üîç Verifying performance log update..."
          if [ ! -f "data/performance_log.json" ]; then
            echo "‚ùå ERROR: performance_log.json not found after update!"
            exit 1
          fi

          # Check if today's date is in the file
          TODAY=$(date -u +%Y-%m-%d)
          if grep -q "\"date\": \"$TODAY\"" data/performance_log.json; then
            echo "‚úÖ Performance log contains entry for today ($TODAY)"
          else
            echo "‚ö†Ô∏è  WARNING: No entry found for today ($TODAY) in performance log"
            echo "    This might be expected if the script updated an existing entry"
          fi

          # Show the last entry in the log
          echo ""
          echo "üìä Latest performance log entry:"
          tail -20 data/performance_log.json | grep -E '"date"|"equity"|"pl"|"cash"|"timestamp"' | tail -5 || echo "  Could not display entry"

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet data/performance_log.json; then
            echo "üìã No changes to performance log (already up-to-date)"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Performance log has new data to commit"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit performance log updates
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/performance_log.json

          # Create commit message with summary
          TODAY=$(date -u +%Y-%m-%d)
          COMMIT_MSG="chore: update performance log for $TODAY"

          git commit -m "$COMMIT_MSG" || {
            echo "‚ùå Failed to commit changes"
            exit 1
          }

          echo "‚úÖ Changes committed successfully"

      - name: Push changes to repository
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "üì§ Pushing performance log updates to main branch..."
          git push origin main || {
            echo "‚ùå Failed to push changes - attempting to pull and retry..."
            git pull --rebase origin main
            git push origin main || {
              echo "‚ùå Failed to push after retry"
              exit 1
            }
          }
          echo "‚úÖ Performance log successfully pushed to repository"

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "=================================================="
          echo "üìä DAILY PERFORMANCE TRACKING SUMMARY"
          echo "=================================================="
          echo "Workflow: Daily Performance Tracking"
          echo "Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "Status: ${{ job.status }}"
          if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
            echo "Changes: New performance data committed and pushed"
          else
            echo "Changes: No new data (already up-to-date)"
          fi
          echo "=================================================="
