name: Daily Trading Execution

on:
  schedule:
    # Run every weekday at 9:35 AM Eastern
    # AUTOMATIC DST HANDLING: Runs at both times to cover EST/EDT transitions
    # EST (Nov-Mar): UTC-5 -> 9:35 AM ET = 14:35 UTC
    # EDT (Mar-Nov): UTC-4 -> 9:35 AM ET = 13:35 UTC
    # Run: python3 scripts/get_utc_time.py 9 35 1-5
    # NOTE: On market holidays, the script automatically switches to crypto trading mode
    - cron: '35 13,14 * * 1-5'   # 9:35 AM Eastern (covers both EST and EDT)
  workflow_dispatch:
    inputs:
      force_trade:
        description: "Force execution even if trading already ran today"
        required: false
        default: "false"
  workflow_run:
    # Also trigger when YouTube analysis completes (ensures latest watchlist)
    workflows: ["YouTube Video Analysis"]
    types:
      - completed

permissions:
  contents: write
  pages: write

# Prevent multiple concurrent trading runs
concurrency:
  group: daily-trading
  cancel-in-progress: false

jobs:
  execute-trading:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Increased from 20 to 30 as safety net (fixes should prevent timeouts)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Always fetch latest to get any YouTube analysis updates
          ref: main
          fetch-depth: 1
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run tests
        run: |
          echo "üß™ Running test suite..."
          python3 tests/test_evaluation_system.py || exit 1
          echo "‚úÖ All tests passed"

      - name: Set up Go for ADK orchestrator
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
        env:
          ADK_ENABLED: ${{ secrets.ADK_ENABLED || '1' }}

      - name: Install Go dependencies for ADK
        if: env.ADK_ENABLED != '0'
        working-directory: go/adk_trading
        run: |
          echo "üì¶ Installing Go dependencies for ADK orchestrator..."
          go mod download
          go mod verify
          echo "‚úÖ Go dependencies installed"

      - name: Start ADK orchestrator service (background)
        if: env.ADK_ENABLED != '0'
        env:
          ADK_ENABLED: ${{ secrets.ADK_ENABLED || '1' }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          ADK_PORT: '8080'
          ADK_HEALTH_ADDR: ':8091'
          ADK_MODEL: ${{ secrets.ADK_MODEL || 'gemini-2.5-flash' }}
        run: |
          echo "üöÄ TURBO MODE: Starting Go ADK orchestrator service..."
          echo "   Model: ${ADK_MODEL}"
          echo "   Port: ${ADK_PORT}"
          
          cd go/adk_trading
          
          # Build first to catch compilation errors early
          echo "üì¶ Building ADK orchestrator..."
          go build -o /tmp/trading_orchestrator ./cmd/trading_orchestrator || {
            echo "‚ùå Build failed - checking logs..."
            cat ../../logs/adk_service.log 2>/dev/null || echo "No log file"
            echo "‚ö†Ô∏è  Continuing with fallback to Python strategies..."
            exit 0
          }
          
          # Start service in background
          echo "üöÄ Starting ADK service..."
          nohup /tmp/trading_orchestrator \
            --model ${ADK_MODEL} \
            --data_dir ../../data \
            --log_path ../../logs/adk_orchestrator.jsonl \
            --app trading_orchestrator \
            web --port 8080 api --webui_address localhost:8080 > ../../logs/adk_service.log 2>&1 &
          echo $! > /tmp/adk_service.pid
          echo "   Service PID: $(cat /tmp/adk_service.pid)"

          # Wait for service to be ready (max 60 seconds - increased for reliability)
          echo "‚è≥ Waiting for ADK service to start..."
          ADK_READY=false
          for i in {1..60}; do
            if curl -f http://localhost:8080/api/health 2>/dev/null > /dev/null; then
              echo "‚úÖ ADK service is ready! (took ${i}s)"
              ADK_READY=true
              break
            fi
            if [ $((i % 10)) -eq 0 ]; then
              echo "   Still waiting... (${i}/60s)"
              # Show last few lines of log for debugging
              tail -5 ../../logs/adk_service.log 2>/dev/null || true
            fi
            sleep 1
          done

          # Verify service started
          if [ "$ADK_READY" = "false" ]; then
            echo "‚ö†Ô∏è  WARNING: ADK service may not have started properly"
            echo "   Checking logs..."
            tail -30 ../../logs/adk_service.log || echo "   No log file found"
            echo "   Continuing with fallback to Python strategies..."
            echo "   ADK will be disabled for this run"
          else
            echo "‚úÖ ADK service verified and ready for trading"
            echo "   Health check: http://localhost:8080/api/health"
          fi

      - name: Validate watchlist exists
        id: validate_watchlist
        run: |
          echo "üîç Validating tier2_watchlist.json..."

          if [ ! -f "data/tier2_watchlist.json" ]; then
            echo "‚ùå ERROR: tier2_watchlist.json not found!"
            echo "watchlist_valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Validate JSON format
          python -c "
          import json
          import sys
          from datetime import datetime, timedelta

          try:
              with open('data/tier2_watchlist.json', 'r') as f:
                  data = json.load(f)

              # Check structure
              assert 'meta' in data, 'Missing meta section'
              assert 'current_holdings' in data or 'watchlist' in data, 'Missing holdings/watchlist'

              # Check staleness (warn if > 7 days old)
              last_updated = data['meta'].get('last_updated', '')
              if last_updated:
                  from datetime import datetime
                  updated_date = datetime.fromisoformat(last_updated.replace('Z', '+00:00')) if 'T' in last_updated else datetime.strptime(last_updated, '%Y-%m-%d')
                  age_days = (datetime.now() - updated_date.replace(tzinfo=None)).days

                  if age_days > 7:
                      print(f'‚ö†Ô∏è  WARNING: Watchlist is {age_days} days old (last updated: {last_updated})')
                  else:
                      print(f'‚úÖ Watchlist age: {age_days} days (last updated: {last_updated})')

              # Count stocks
              holdings_count = len(data.get('current_holdings', []))
              watchlist_count = len(data.get('watchlist', []))
              total = holdings_count + watchlist_count

              print(f'‚úÖ Valid watchlist JSON')
              print(f'   - Current holdings: {holdings_count}')
              print(f'   - Watchlist stocks: {watchlist_count}')
              print(f'   - Total tracked: {total}')

              # Warn if empty but allow execution
              if total == 0:
                  print('‚ö†Ô∏è  WARNING: Watchlist is empty (no stocks tracked)')
                  print('   Trading will proceed with fallback strategy')

          except Exception as e:
              print(f'‚ùå Invalid watchlist JSON: {e}')
              sys.exit(1)
          "

          echo "watchlist_valid=true" >> $GITHUB_OUTPUT

      - name: Validate system_state.json
        run: |
          echo "üîç Validating system_state.json..."

          if [ ! -f "data/system_state.json" ]; then
            echo "‚ö†Ô∏è  WARNING: system_state.json not found (will be created on first run)"
            exit 0
          fi

          # Validate JSON and check staleness
          python -c "
          import json
          import sys
          from datetime import datetime, timedelta

          try:
              with open('data/system_state.json', 'r') as f:
                  data = json.load(f)

              # Check staleness
              last_updated = data.get('meta', {}).get('last_updated', '')
              if last_updated:
                  updated_date = datetime.fromisoformat(last_updated.replace('Z', '+00:00')) if 'T' in last_updated else datetime.strptime(last_updated, '%Y-%m-%d %H:%M:%S')
                  age_hours = (datetime.now() - updated_date.replace(tzinfo=None)).total_seconds() / 3600

                  if age_hours > 48:
                      print(f'‚ö†Ô∏è  WARNING: system_state.json is {age_hours:.1f} hours old')
                      print(f'   Last updated: {last_updated}')
                  else:
                      print(f'‚úÖ System state current (updated {age_hours:.1f} hours ago)')

              print(f'‚úÖ Valid system_state.json')

          except Exception as e:
              print(f'‚ö†Ô∏è  WARNING: Could not validate system_state.json: {e}')
              print('   Trading will proceed (state will be regenerated)')
          "

      - name: Check if today's trade already executed
        id: check_execution
        env:
          FORCE_TRADE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force_trade || 'false' }}
        run: |
          echo "üîç Checking last execution date..."
          python3 scripts/check_duplicate_execution.py

          if [ "${{ steps.check_execution.outputs.skip }}" = "true" ]; then
            echo "‚ö†Ô∏è  Trading already executed today. Skipping run."
          fi

      - name: Pre-market health check
        id: health_check
        if: steps.check_execution.outputs.skip != 'true'
        timeout-minutes: 1  # Fail fast if health check hangs
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
        run: |
          echo "üè• Running pre-market health check..."
          python3 scripts/pre_market_health_check.py

          if [ $? -ne 0 ]; then
            echo "‚ùå HEALTH CHECK FAILED - Aborting trading execution"
            echo "health_check_passed=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "‚úÖ HEALTH CHECK PASSED - Proceeding with trading"
            echo "health_check_passed=true" >> $GITHUB_OUTPUT
          fi

      - name: Execute daily trading
        if: steps.check_execution.outputs.skip != 'true' && steps.health_check.outputs.health_check_passed == 'true'
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
          # Phase 1: Polygon.io + Finnhub integration
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          DAILY_INVESTMENT: ${{ secrets.DAILY_INVESTMENT || '10.0' }}
          PAPER_TRADING: 'true'
          # TURBO MODE: Enable ADK orchestrator
          ADK_ENABLED: ${{ secrets.ADK_ENABLED || '1' }}
          ADK_BASE_URL: ${{ secrets.ADK_BASE_URL || 'http://127.0.0.1:8080/api' }}
          ADK_APP_NAME: ${{ secrets.ADK_APP_NAME || 'trading_orchestrator' }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          # Enable Langchain agents
          LANGCHAIN_ENABLE_MCP: ${{ secrets.LANGCHAIN_ENABLE_MCP || 'true' }}
          LANGCHAIN_MODEL: ${{ secrets.LANGCHAIN_MODEL || 'claude-3-5-sonnet-20241022' }}
          # Enable all agent integrations (CEO directive Nov 24, 2025: $100/mo budget)
          LLM_COUNCIL_ENABLED: ${{ secrets.LLM_COUNCIL_ENABLED || 'true' }}
          DEEPAGENTS_ENABLED: ${{ secrets.DEEPAGENTS_ENABLED || 'true' }}
        run: |
          python scripts/autonomous_trader.py
      
      - name: Check for state changes
        id: check_state_changes
        if: steps.check_execution.outputs.skip != 'true'
        run: |
          echo "üîç Checking for system_state.json updates..."

          # Check if system_state.json changed during execution
          if git diff --quiet data/system_state.json; then
            echo "state_changed=false" >> $GITHUB_OUTPUT
            echo "üìã No changes to system state"
          else
            echo "state_changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ System state updated after trading"

            # Show summary of changes
            echo "Changes detected:"
            git diff --stat data/system_state.json
          fi

      - name: Commit system state updates
        if: steps.check_execution.outputs.skip != 'true' && steps.check_state_changes.outputs.state_changed == 'true'
        run: |
          echo "üíæ Committing system_state.json updates..."

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # Pull latest changes to avoid conflicts
          git pull --rebase origin main || {
            echo "‚ö†Ô∏è  Merge conflict detected - resolving..."

            # Keep our version (trading execution takes precedence)
            git checkout --ours data/system_state.json
            git add data/system_state.json
            git rebase --continue
          }

          # Stage system_state.json
          git add data/system_state.json

          # Create commit with trading execution details
          git commit -m "$(cat <<'EOF'
          chore: Update system state after trading execution

          Daily trading execution completed and system state updated.

          Execution details:
          - Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          - Workflow: daily-trading.yml
          - Run ID: ${{ github.run_id }}

          Changes:
          - Updated account balances
          - Recorded trade execution results
          - Updated performance metrics

          ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>
          EOF
          )"

          # Push changes
          git push origin main

          echo "‚úÖ System state changes committed and pushed"

      - name: Stop ADK service
        if: always()
        env:
          ADK_ENABLED: ${{ secrets.ADK_ENABLED || '1' }}
        run: |
          if [ "$ADK_ENABLED" != "0" ] && [ -f /tmp/adk_service.pid ]; then
            PID=$(cat /tmp/adk_service.pid)
            if ps -p $PID > /dev/null 2>&1; then
              echo "üõë Stopping ADK service (PID: $PID)..."
              kill $PID || true
              sleep 2
              # Force kill if still running
              if ps -p $PID > /dev/null 2>&1; then
                echo "   Force killing ADK service..."
                kill -9 $PID || true
              fi
              echo "‚úÖ ADK service stopped"
            else
              echo "‚ö†Ô∏è  ADK service PID file exists but process not running"
            fi
          fi

      - name: Update Progress Dashboard Wiki
        if: steps.check_execution.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üìä Generating world-class progress dashboard..."
          python3 scripts/generate_world_class_dashboard.py || python3 scripts/generate_progress_dashboard.py
          
          echo "üìù Updating GitHub Wiki..."
          
          # Clone wiki repository (create if doesn't exist)
          WIKI_DIR="wiki_repo"
          if git clone https://${{ secrets.GITHUB_TOKEN }}@github.com/IgorGanapolsky/trading.wiki.git "$WIKI_DIR" 2>/dev/null; then
            echo "‚úÖ Wiki repository exists, updating..."
          else
            echo "‚ö†Ô∏è  Wiki repository doesn't exist yet - will create on first push"
            mkdir -p "$WIKI_DIR"
            cd "$WIKI_DIR"
            git init
            git config user.name "GitHub Actions Bot"
            git config user.email "actions@github.com"
            git remote add origin https://${{ secrets.GITHUB_TOKEN }}@github.com/IgorGanapolsky/trading.wiki.git
            cd ..
          fi
          
          # Copy generated dashboard and home page to wiki
          cp wiki/Progress-Dashboard.md "$WIKI_DIR/Progress-Dashboard.md"
          if [ -f wiki/Home.md ]; then
            cp wiki/Home.md "$WIKI_DIR/Home.md"
          fi
          
          # Commit and push to wiki
          cd "$WIKI_DIR"
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add -A
          
          if git diff --staged --quiet && [ -n "$(git log --oneline 2>/dev/null)" ]; then
            echo "üìã No changes to dashboard"
          else
            if [ -z "$(git log --oneline 2>/dev/null)" ]; then
              COMMIT_MSG="üéâ Initial wiki setup - Progress Dashboard and Home page"
            else
              COMMIT_MSG="üìä Auto-update progress dashboard - $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            fi
            
            git commit -m "$COMMIT_MSG" || echo "No changes to commit"

            # Push to wiki - detect current branch or use master (wiki default)
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "master")
            echo "üìå Pushing to branch: $CURRENT_BRANCH"

            # Re-authenticate for push (token may have been invalidated)
            git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/IgorGanapolsky/trading.wiki.git"

            if git push -u origin "$CURRENT_BRANCH" 2>&1; then
              echo "‚úÖ Wiki dashboard updated successfully!"
            else
              echo "‚ö†Ô∏è  Wiki push failed - trying force push..."
              if git push -u origin "$CURRENT_BRANCH" --force 2>&1; then
                echo "‚úÖ Wiki dashboard force-pushed successfully!"
              else
                echo "‚ö†Ô∏è  Wiki push failed - wiki repository may need manual initialization"
                echo "   1. Visit: https://github.com/IgorGanapolsky/trading/wiki"
                echo "   2. Click 'Create the first page'"
                echo "   3. Name it 'Home' and save"
              fi
            fi
          fi

      - name: Upload execution logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trading-logs-${{ github.run_id }}
          path: |
            logs/*.log
            logs/adk_service.log
            logs/adk_orchestrator.jsonl
            data/system_state.json
            data/trades_*.json
            wiki/Progress-Dashboard.md
          retention-days: 30

