name: Data Hygiene Check

on:
  schedule:
    # Run daily at 3:00 AM UTC (11 PM EST previous day)
    # Ensures data quality is monitored continuously
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      symbols:
        description: "Comma-separated symbols to check (default: all)"
        required: false
        default: ""
      rotate_data:
        description: "Rotate old historical data"
        required: false
        default: "false"
      cleanup_models:
        description: "Clean up stale models"
        required: false
        default: "false"

permissions:
  contents: read
  issues: write

jobs:
  hygiene-check:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install dependencies
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          uv pip sync --system requirements.txt

      - name: Run full hygiene check
        id: hygiene_check
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        run: |
          echo "ðŸ” Running comprehensive data hygiene check..."

          SYMBOLS="${{ github.event.inputs.symbols }}"
          SYMBOLS_ARG=""
          if [ -n "$SYMBOLS" ]; then
            SYMBOLS_ARG="--symbols $SYMBOLS"
          fi

          python3 scripts/data_hygiene_check.py full-check $SYMBOLS_ARG \
            --output hygiene_report.json || {
              echo "hygiene_issues=true" >> $GITHUB_OUTPUT
              exit 0  # Don't fail workflow, but flag issues
            }

          echo "hygiene_issues=false" >> $GITHUB_OUTPUT

      - name: Rotate old historical data
        if: github.event.inputs.rotate_data == 'true' || github.event.schedule
        run: |
          echo "ðŸ”„ Rotating historical data older than 365 days..."
          python3 scripts/data_hygiene_check.py rotate \
            --max-age-days 365 \
            --dry-run false

      - name: Cleanup stale models
        if: github.event.inputs.cleanup_models == 'true' || github.event.schedule
        run: |
          echo "ðŸ§¹ Cleaning up stale model files..."
          python3 scripts/data_hygiene_check.py cleanup-models \
            --max-age-days 60 \
            --keep-latest \
            --dry-run false

      - name: Upload hygiene report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: data-hygiene-report
          path: hygiene_report.json
          retention-days: 30

      - name: Create issue if hygiene problems detected
        if: steps.hygiene_check.outputs.hygiene_issues == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('hygiene_report.json', 'utf8'));

            const issues = report.recommendations || [];
            const modelStale = report.model_staleness?.stale || false;

            let body = '## Data Hygiene Issues Detected\n\n';
            body += `**Timestamp:** ${report.timestamp}\n\n`;

            if (modelStale) {
              body += `### ðŸ¤– Model Staleness\n`;
              body += `- ${report.model_staleness.reason}\n`;
              body += `- Age: ${report.model_staleness.age_days} days\n\n`;
            }

            if (issues.length > 0) {
              body += `### ðŸ“Š Data Quality Issues\n`;
              issues.forEach((issue, i) => {
                body += `${i + 1}. ${issue}\n`;
              });
            }

            body += '\n### Recommended Actions\n';
            body += '1. Review data quality issues\n';
            body += '2. Retrain model if stale\n';
            body += '3. Collect fresh data if needed\n';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Data Hygiene Alert - ${new Date().toISOString().split('T')[0]}`,
              body: body,
              labels: ['data-quality', 'automated']
            });
