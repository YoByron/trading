name: Instant Trade

on:
  push:
    paths:
      - '.github/INSTANT_TRADE'
    branches: [main]

permissions:
  contents: write

jobs:
  trade:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - run: pip install alpaca-py

      - name: Trade
        env:
          KEY: ${{ secrets.ALPACA_API_KEY }}
          SECRET: ${{ secrets.ALPACA_SECRET_KEY }}
        run: |
          python3 -c "
          import os
          print('Starting...')
          key = os.environ.get('KEY')
          secret = os.environ.get('SECRET')
          print(f'Key: {\"YES\" if key else \"NO\"}')
          print(f'Secret: {\"YES\" if secret else \"NO\"}')
          if not key or not secret:
              print('MISSING SECRETS!')
              exit(1)
          from alpaca.trading.client import TradingClient
          from alpaca.trading.requests import MarketOrderRequest
          from alpaca.trading.enums import OrderSide, TimeInForce
          c = TradingClient(key, secret, paper=True)
          print(f'Cash: \${float(c.get_account().cash):,.2f}')
          o = c.submit_order(MarketOrderRequest(symbol='SPY',qty=1,side=OrderSide.BUY,time_in_force=TimeInForce.DAY))
          print(f'Order: {o.id}')
          import json
          from datetime import datetime, timezone
          import os as os2
          os2.makedirs('data', exist_ok=True)
          today = datetime.now(timezone.utc).strftime('%Y-%m-%d')
          with open(f'data/trades_{today}.json','w') as f:
              json.dump([{'symbol':'SPY','qty':1,'id':str(o.id),'ts':datetime.now(timezone.utc).isoformat()}],f)
          print('DONE!')
          "

      - name: Commit and push trade data
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "trade: instant executed [skip ci]"
          file_pattern: "data/trades_*.json"
          commit_user_name: "GitHub Actions Bot"
          commit_user_email: "actions@github.com"
