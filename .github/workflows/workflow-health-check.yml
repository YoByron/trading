name: Workflow Health Check

on:
  schedule:
    # Run every Monday at 8:00 AM UTC (3:00 AM EST) - before trading starts
    - cron: '0 8 * * 1'
  workflow_dispatch:
    description: "Manual workflow health check"

permissions:
  actions: read
  contents: read
  issues: write

jobs:
  check-workflow-health:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Check workflow status
        id: check_status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: workflows } = await github.rest.actions.listWorkflowsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const criticalWorkflows = [
              'daily-trading.yml',
              'weekend-crypto-trading.yml',
              'youtube-analysis.yml',
            ];
            
            const issues = [];
            const disabledWorkflows = [];
            
            for (const workflow of workflows.workflows) {
              if (criticalWorkflows.includes(workflow.path.replace('.github/workflows/', ''))) {
                const { data: workflowData } = await github.rest.actions.getWorkflow({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: workflow.id,
                });
                
                if (!workflowData.state || workflowData.state === 'disabled') {
                  disabledWorkflows.push({
                    name: workflow.name,
                    path: workflow.path,
                    id: workflow.id,
                  });
                }
              }
            }
            
            core.setOutput('disabled_count', disabledWorkflows.length);
            core.setOutput('disabled_workflows', JSON.stringify(disabledWorkflows));
            
            if (disabledWorkflows.length > 0) {
              // Check for existing issues about disabled workflows
              const { data: existingIssues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
              });
              
              const hasExistingIssue = existingIssues.some(issue => 
                (issue.title.toLowerCase().includes('workflow') || issue.title.toLowerCase().includes('action')) &&
                (issue.title.toLowerCase().includes('disabled') || issue.title.toLowerCase().includes('re-enable'))
              );
              
              if (!hasExistingIssue) {
                // Create issue
                const workflowNames = disabledWorkflows.map(w => w.name).join(', ');
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `ðŸš¨ URGENT: ${disabledWorkflows.length} Critical Workflow(s) Disabled`,
                  body: `## ðŸš¨ Critical Workflow Disabled Alert
                
**Detected**: ${new Date().toISOString()}
**Workflows Affected**: ${workflowNames}

### Disabled Workflows:
${disabledWorkflows.map(w => `- **${w.name}** (\`${w.path}\`)`).join('\n')}

### Quick Fix (2 Minutes):
1. Go to: https://github.com/${{ github.repository }}/actions/workflows/${disabledWorkflows[0].path.replace('.github/workflows/', '')}
2. Click **"Enable workflow"** button (green button)
3. Click **"Run workflow"** to trigger immediate execution

### Why This Happened:
GitHub automatically disables scheduled workflows after 60 days of repository inactivity. This is a GitHub security feature.

### Prevention:
- This health check runs weekly to detect disabled workflows early
- Automated re-enable will be implemented soon

### Impact:
- âš ï¸ Trading execution will NOT run until workflows are re-enabled
- âš ï¸ Scheduled trades will be missed

---
ðŸ¤– **Auto-detected by Workflow Health Check**`,
                  labels: ['bug', 'urgent', 'automation'],
                });
              }
            }
      
      - name: Auto-re-enable workflows (if configured)
        if: steps.check_status.outputs.disabled_count > 0
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const disabledWorkflows = JSON.parse('${{ steps.check_status.outputs.disabled_workflows }}');
            
            // Only auto-enable if AUTO_ENABLE_WORKFLOWS secret is set to 'true'
            const autoEnable = '${{ secrets.AUTO_ENABLE_WORKFLOWS }}' === 'true';
            
            if (autoEnable) {
              console.log('ðŸ”„ Auto-enabling disabled workflows...');
              
              for (const workflow of disabledWorkflows) {
                try {
                  await github.rest.actions.enableWorkflow({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    workflow_id: workflow.id,
                  });
                  console.log(`âœ… Enabled: ${workflow.name}`);
                } catch (error) {
                  console.error(`âŒ Failed to enable ${workflow.name}: ${error.message}`);
                }
              }
            } else {
              console.log('â„¹ï¸  Auto-enable disabled (set AUTO_ENABLE_WORKFLOWS=true to enable)');
              console.log('   Manual re-enable required - issue created');
            }
      
      - name: Report status
        run: |
          echo "## Workflow Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          DISABLED_COUNT="${{ steps.check_status.outputs.disabled_count }}"
          
          if [ "$DISABLED_COUNT" = "0" ]; then
            echo "âœ… **All critical workflows are enabled**" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸš¨ **$DISABLED_COUNT workflow(s) disabled**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the Actions tab for details." >> $GITHUB_STEP_SUMMARY
          fi

