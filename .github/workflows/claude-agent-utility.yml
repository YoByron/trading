# Claude Agent Utility Workflow
# Purpose: Execute tasks that cannot be done in the Claude sandbox
# Triggered via API: curl -X POST with workflow_dispatch
# Also triggers on push to claude/* branches with TRIGGER_TRADE.md changes
#
# Created: Jan 7, 2026
# Updated: Jan 12, 2026 - Added push trigger for paper trades
# Reason: CEO directive - "Don't tell me sandbox can't do it, create CI workflows"

name: Claude Agent Utility

on:
  push:
    branches:
      - 'claude/**'
    paths:
      - 'TRIGGER_TRADE.md'
  workflow_dispatch:
    inputs:
      task:
        description: 'Task to execute'
        required: true
        type: choice
        options:
          - run-tests
          - run-lint
          - verify-rag
          - sync-trades-to-rag
          - system-health-check
          # verify-chromadb removed Jan 8, 2026 (ChromaDB deprecated)
          - dry-run-trading
          - deploy-webhook
          - set-trailing-stops
          - manage-positions
          - verify-alpaca-account
          - execute-paper-trade
          - custom-command
        default: 'run-tests'
      custom_command:
        description: 'Custom Python command (only if task=custom-command)'
        required: false
        type: string
        default: ''
      test_pattern:
        description: 'Test pattern for pytest (e.g., tests/test_*.py)'
        required: false
        type: string
        default: 'tests/'
      verbose:
        description: 'Enable verbose output'
        required: false
        type: boolean
        default: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  execute-task:
    name: Execute ${{ github.event.inputs.task || 'execute-paper-trade' }}
    runs-on: ubuntu-latest

    steps:
      - name: Set task from trigger
        id: task
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "task=execute-paper-trade" >> $GITHUB_OUTPUT
            echo "Triggered by push to claude/* branch - executing paper trade"
          else
            echo "task=${{ github.event.inputs.task }}" >> $GITHUB_OUTPUT
            echo "Triggered by workflow_dispatch - task: ${{ github.event.inputs.task }}"
          fi

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Note: chromadb removed Jan 8, 2026 per CLAUDE.md
          pip install pytest pytest-cov ruff black

      - name: Task - Run Tests
        if: github.event.inputs.task == 'run-tests'
        run: |
          echo "Running pytest with pattern: ${{ github.event.inputs.test_pattern }}"
          python -m pytest ${{ github.event.inputs.test_pattern }} \
            -v \
            --tb=short \
            --color=yes \
            2>&1 | tee test-output.txt

          echo "::notice::Test run complete. Check output above."

      - name: Task - Run Lint
        if: github.event.inputs.task == 'run-lint'
        run: |
          echo "Running ruff check..."
          python -m ruff check src/ scripts/ --fix --show-fixes || true

          echo "Running black check..."
          python -m black src/ scripts/ --check --diff || true

          echo "::notice::Lint check complete."

      - name: Task - Verify RAG
        if: github.event.inputs.task == 'verify-rag'
        run: |
          echo "Verifying RAG systems..."
          python3 -c "
          from src.rag.lessons_learned_rag import LessonsLearnedRAG
          rag = LessonsLearnedRAG()
          print(f'Lessons loaded: {len(rag.lessons)}')
          results = rag.query('trading risk', top_k=3)
          print(f'Query test returned {len(results)} results')
          for r in results:
              print(f'  - {r.get(\"id\", \"unknown\")}: {r.get(\"severity\", \"\")}')
          print('RAG verification: PASSED')
          "

      - name: Task - Sync Trades to RAG
        if: github.event.inputs.task == 'sync-trades-to-rag'
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          echo "Syncing trades to Vertex AI RAG..."
          python3 scripts/sync_trades_to_rag.py || {
            echo "::warning::RAG sync had issues - check logs"
          }
          echo "::notice::Trade sync complete."

      - name: Task - System Health Check
        if: github.event.inputs.task == 'system-health-check'
        run: |
          echo "Running full system health check..."
          python3 scripts/system_health_check.py 2>&1 | tee health-check.txt

          # Check for critical failures
          if grep -q "SOME CHECKS FAILED" health-check.txt; then
            echo "::warning::Some health checks failed - review output"
          else
            echo "::notice::All health checks passed!"
          fi

      # Task - Verify ChromaDB removed Jan 8, 2026 (ChromaDB deprecated per CLAUDE.md)

      - name: Task - Dry Run Trading
        if: github.event.inputs.task == 'dry-run-trading'
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_SECRET }}
          ALPACA_PAPER: "true"
        run: |
          echo "Running trading system dry run..."
          python3 -c "
          import os
          os.environ['ALPACA_SIMULATED'] = 'true'

          # Import core modules
          from src.orchestrator.main import TradingOrchestrator
          print('TradingOrchestrator: importable')

          from src.execution.alpaca_executor import AlpacaExecutor
          print('AlpacaExecutor: importable')

          from src.safety.mandatory_trade_gate import validate_trade_mandatory
          print('MandatoryTradeGate: importable')

          from src.learning.trade_memory import TradeMemory
          print('TradeMemory: importable')

          print('Dry run: ALL CORE MODULES IMPORTABLE')
          "

      - name: Task - Deploy Webhook
        if: github.event.inputs.task == 'deploy-webhook'
        run: |
          echo "Triggering webhook deployment..."
          echo "::notice::Use the dedicated deploy-dialogflow-webhook workflow for full deployment"
          # This is a placeholder - actual deployment uses dedicated workflow
          python3 -c "from src.agents.dialogflow_webhook import app; print(f'Webhook app version: {app.version}')"

      - name: Task - Set Trailing Stops
        if: github.event.inputs.task == 'set-trailing-stops'
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_SECRET }}
          PAPER_TRADING: "true"
        run: |
          echo "=================================================="
          echo "PHIL TOWN RULE #1: DON'T LOSE MONEY"
          echo "Setting trailing stop-loss orders on all positions"
          echo "=================================================="
          python3 scripts/set_trailing_stops.py 2>&1 | tee trailing-stops.txt

          if grep -q "FAILED" trailing-stops.txt; then
            echo "::warning::Some trailing stops could not be set - review output"
          else
            echo "::notice::Trailing stops set successfully!"
          fi

      - name: Task - Manage Positions
        if: github.event.inputs.task == 'manage-positions'
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_SECRET }}
          PAPER_TRADING: "true"
        run: |
          echo "=================================================="
          echo "POSITION MANAGEMENT - Phil Town Rule #1"
          echo "Evaluating all positions against exit conditions"
          echo "=================================================="
          python3 scripts/manage_positions.py 2>&1 | tee position-management.txt

          if grep -q "exits executed" position-management.txt; then
            echo "::notice::Position management complete - check output for actions taken"
          fi

      - name: Task - Verify Alpaca Account
        if: github.event.inputs.task == 'verify-alpaca-account'
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_SECRET }}
        run: |
          echo "=================================================="
          echo "VERIFYING ALPACA PAPER ACCOUNT STATUS"
          echo "=================================================="
          pip install alpaca-py
          python3 -c "
          import os
          from alpaca.trading.client import TradingClient
          from alpaca.trading.requests import GetOrdersRequest
          from alpaca.trading.enums import QueryOrderStatus

          client = TradingClient(
              os.environ['ALPACA_API_KEY'],
              os.environ['ALPACA_SECRET_KEY'],
              paper=True
          )

          account = client.get_account()
          print('=== ALPACA PAPER ACCOUNT ===')
          print(f'Equity: \${float(account.equity):,.2f}')
          print(f'Cash: \${float(account.cash):,.2f}')
          print(f'Buying Power: \${float(account.buying_power):,.2f}')
          print(f'Status: {account.status}')

          positions = client.get_all_positions()
          print(f'\n=== POSITIONS ({len(positions)}) ===')
          for p in positions:
              print(f'  {p.symbol}: {p.qty} @ \${float(p.current_price):.2f} | P/L: \${float(p.unrealized_pl):.2f}')

          if not positions:
              print('  NO POSITIONS')

          orders = client.get_orders(GetOrdersRequest(status=QueryOrderStatus.ALL, limit=10))
          print(f'\n=== RECENT ORDERS ({len(orders)}) ===')
          for o in orders[:5]:
              print(f'  {o.created_at.strftime(\"%Y-%m-%d %H:%M\")} | {o.side} {o.qty} {o.symbol} | {o.status}')

          if not orders:
              print('  NO ORDERS')
          "

      - name: Task - Execute Paper Trade
        if: github.event.inputs.task == 'execute-paper-trade' || github.event_name == 'push'
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_SECRET }}
          PAPER_TRADING: "true"
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "=================================================="
          echo "EXECUTING PAPER TRADE - Phil Town Strategy"
          echo "=================================================="
          echo ""

          # First, verify account
          pip install alpaca-py
          python3 -c "
          import os
          from alpaca.trading.client import TradingClient
          client = TradingClient(
              os.environ['ALPACA_API_KEY'],
              os.environ['ALPACA_SECRET_KEY'],
              paper=True
          )
          account = client.get_account()
          print(f'Pre-trade equity: \${float(account.equity):,.2f}')
          print(f'Buying power: \${float(account.buying_power):,.2f}')
          "

          # Run guaranteed trader for immediate execution
          echo ""
          echo "Running guaranteed_trader.py..."
          python3 scripts/guaranteed_trader.py 2>&1 || {
            echo "::warning::Guaranteed trader had issues"
          }

          # Verify results
          echo ""
          echo "Post-trade verification..."
          python3 -c "
          import os
          from alpaca.trading.client import TradingClient
          from alpaca.trading.requests import GetOrdersRequest
          from alpaca.trading.enums import QueryOrderStatus
          from datetime import datetime, timedelta

          client = TradingClient(
              os.environ['ALPACA_API_KEY'],
              os.environ['ALPACA_SECRET_KEY'],
              paper=True
          )

          account = client.get_account()
          print(f'Post-trade equity: \${float(account.equity):,.2f}')

          # Check for recent orders
          orders = client.get_orders(GetOrdersRequest(
              status=QueryOrderStatus.ALL,
              limit=5,
              after=datetime.now() - timedelta(hours=1)
          ))
          print(f'\nOrders in last hour: {len(orders)}')
          for o in orders:
              print(f'  {o.side} {o.qty} {o.symbol} | {o.status}')
          "

      - name: Task - Custom Command
        if: github.event.inputs.task == 'custom-command' && github.event.inputs.custom_command != ''
        run: |
          echo "Executing custom command..."
          echo "Command: ${{ github.event.inputs.custom_command }}"
          python3 -c "${{ github.event.inputs.custom_command }}"

      - name: Summary
        run: |
          echo "## Task Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Task**: ${{ github.event.inputs.task }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Task completed. Check logs above for details." >> $GITHUB_STEP_SUMMARY
