name: Off-Market Backtesting

on:
  schedule:
    - cron: '0 23 * * 1-5'  # 6 PM ET weekdays
    - cron: '0 13 * * 6'    # 8 AM ET Saturday
    - cron: '0 13 * * 0'    # 8 AM ET Sunday
  workflow_dispatch:
    inputs:
      days:
        description: 'Days to backtest'
        required: false
        default: '30'
        type: string
      strategy:
        description: 'Strategy to backtest'
        required: false
        default: 'iron_condor'
        type: choice
        options:
          - iron_condor
          - bull_put_spread
          - both
      parameter_sweep:
        description: 'Run parameter optimization'
        required: false
        default: false
        type: boolean
      max_combinations:
        description: 'Max parameter combinations'
        required: false
        default: '25'
        type: string

permissions:
  contents: write
  pull-requests: write

env:
  ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_30K_API_KEY }}
  ALPACA_SECRET_KEY: ${{ secrets.ALPACA_PAPER_TRADING_30K_API_SECRET }}
  GOOGLE_CLOUD_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
  PAPER_TRADING: 'true'

jobs:
  verify-market-closed:
    runs-on: ubuntu-latest
    outputs:
      market_closed: ${{ steps.check.outputs.closed }}
    steps:
      - name: Check market hours
        id: check
        run: |
          current_hour=$(TZ="America/New_York" date +%H)
          current_day=$(TZ="America/New_York" date +%u)
          if [ "$current_day" -gt 5 ]; then
            echo "closed=true" >> $GITHUB_OUTPUT
          elif [ "$current_hour" -lt 9 ] || [ "$current_hour" -ge 17 ]; then
            echo "closed=true" >> $GITHUB_OUTPUT
          else
            echo "closed=false" >> $GITHUB_OUTPUT
          fi

  run-backtest:
    needs: verify-market-closed
    if: needs.verify-market-closed.outputs.market_closed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 120
    outputs:
      has_results: ${{ steps.backtest.outputs.has_results }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install alpaca-py pandas numpy scipy matplotlib google-cloud-aiplatform
          
      - name: Create directories
        run: |
          mkdir -p data/backtests/parameter_sweeps
          mkdir -p data/rag_staging
          
      - name: Determine parameters
        id: params
        run: |
          DAYS="${{ github.event.inputs.days || '30' }}"
          SWEEP="${{ github.event.inputs.parameter_sweep || 'false' }}"
          MAX_COMBOS="${{ github.event.inputs.max_combinations || '25' }}"
          DAY_OF_WEEK=$(date +%u)
          if [ "$DAY_OF_WEEK" -gt 5 ] && [ "$DAYS" = "30" ]; then
            DAYS="60"
          fi
          echo "days=$DAYS" >> $GITHUB_OUTPUT
          echo "sweep=$SWEEP" >> $GITHUB_OUTPUT
          echo "max_combos=$MAX_COMBOS" >> $GITHUB_OUTPUT
          
      - name: Run backtest
        id: backtest
        run: |
          STRATEGY="${{ github.event.inputs.strategy || 'iron_condor' }}"
          DAYS="${{ steps.params.outputs.days }}"

          if [ "${{ steps.params.outputs.sweep }}" = "true" ]; then
            python scripts/backtest/parameter_sweep.py \
              --days $DAYS \
              --max-combos ${{ steps.params.outputs.max_combos }} \
              --output data/backtests/parameter_sweeps
          elif [ "$STRATEGY" = "iron_condor" ] || [ "$STRATEGY" = "both" ]; then
            echo "ðŸ¦… Running Iron Condor backtest..."
            python scripts/backtest/iron_condor_backtester.py \
              --days $DAYS \
              --output data/backtests
          fi

          if [ "$STRATEGY" = "bull_put_spread" ] || [ "$STRATEGY" = "both" ]; then
            echo "ðŸ‚ Running Bull Put Spread backtest..."
            python scripts/backtest/bull_put_spread_backtester.py \
              --days $DAYS \
              --output data/backtests
          fi

          if ls data/backtests/*.json 1>/dev/null 2>&1; then
            echo "has_results=true" >> $GITHUB_OUTPUT
          else
            echo "has_results=false" >> $GITHUB_OUTPUT
          fi
            
      - name: Ingest to RAG
        if: success()
        continue-on-error: true
        run: |
          python scripts/backtest/ingest_backtest_to_rag.py \
            --lessons-dir data/backtests \
            --output data/rag_staging
            
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backtest-results-${{ github.run_id }}
          path: |
            data/backtests/*.json
            data/backtests/*.csv
            data/backtests/parameter_sweeps/*
            data/rag_staging/*.md
          retention-days: 30

  commit-results:
    needs: run-backtest
    if: needs.run-backtest.outputs.has_results == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: backtest-results-${{ github.run_id }}
          path: downloaded_results
          
      - name: Create branch and PR
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          BRANCH_NAME="auto/backtest-$(date +%Y%m%d-%H%M%S)"
          TIMESTAMP=$(date +%Y-%m-%d)
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout -b "$BRANCH_NAME"
          
          # Copy results
          cp -r downloaded_results/backtests/* data/backtests/ 2>/dev/null || true
          cp -r downloaded_results/rag_staging/* data/rag_staging/ 2>/dev/null || true
          
          # Update latest summary
          LATEST=$(ls -t data/backtests/backtest_summary_*.json 2>/dev/null | head -1)
          if [ -n "$LATEST" ]; then
            cp "$LATEST" data/backtests/latest_summary.json
          fi
          
          git add data/backtests/ data/rag_staging/
          
          if ! git diff --staged --quiet; then
            git commit -m "chore(backtest): Add results from $TIMESTAMP"
            git push origin "$BRANCH_NAME"
            
            # Create and auto-merge PR
            PR_URL=$(gh pr create \
              --title "chore(backtest): Add results from $TIMESTAMP" \
              --body "Automated backtest results from off-market run #${{ github.run_id }}" \
              --head "$BRANCH_NAME" \
              --base main)
            
            PR_NUM=$(echo "$PR_URL" | grep -oE '[0-9]+$')
            
            # Auto-merge with admin privileges
            gh pr merge "$PR_NUM" --squash --admin --delete-branch || echo "Manual merge may be required"
          fi
