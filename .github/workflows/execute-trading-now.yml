name: Execute Trading NOW

# This workflow runs trading immediately when pushed
# Created because workflow_dispatch API is blocked from sandbox

on:
  push:
    paths:
      - '.github/EXECUTE_NOW'
    branches: [main]

jobs:
  execute-trading:
    name: Execute Trading Immediately
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || pip install alpaca-py pandas numpy python-dotenv
      
      - name: Execute Trading
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          ALPACA_BASE_URL: ${{ secrets.ALPACA_BASE_URL }}
          TRADING_MODE: paper
        run: |
          echo "=== EXECUTING TRADING NOW ==="
          echo "Time: $(date -u)"
          echo ""
          
          # Run the trading orchestrator
          python3 -c "
          import sys
          sys.path.insert(0, '.')
          
          try:
              from src.orchestrator.main import TradingOrchestrator
              
              print('Initializing TradingOrchestrator...')
              orchestrator = TradingOrchestrator()
              
              print('Running trading cycle...')
              result = orchestrator.run()
              
              print(f'Result: {result}')
          except Exception as e:
              print(f'Error: {e}')
              import traceback
              traceback.print_exc()
          "
