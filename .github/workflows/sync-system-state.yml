name: Sync System State

on:
  schedule:
    - cron: '0 14-21 * * 1-5'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install alpaca-py
      - name: Sync
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_SECRET }}
        run: |
          python3 << 'EOF'
          import json, os
          from datetime import datetime, timedelta
          from pathlib import Path
          from alpaca.trading.client import TradingClient
          from alpaca.trading.requests import GetOrdersRequest
          from alpaca.trading.enums import QueryOrderStatus
          
          client = TradingClient(os.environ['ALPACA_API_KEY'], os.environ['ALPACA_SECRET_KEY'], paper=True)
          account = client.get_account()
          
          orders = client.get_orders(filter=GetOrdersRequest(status=QueryOrderStatus.CLOSED, limit=100))
          trades = [{"id": str(o.id), "symbol": o.symbol, "side": str(o.side), "qty": str(o.filled_qty), "price": str(o.filled_avg_price), "filled_at": str(o.filled_at)} for o in orders if o.filled_at]
          
          positions = client.get_all_positions()
          pos_list = [{"symbol": p.symbol, "qty": str(p.qty), "market_value": str(p.market_value), "unrealized_pl": str(p.unrealized_pl)} for p in positions]
          
          state = {"last_updated": datetime.now().isoformat()+"Z", "portfolio": {"equity": str(account.equity), "cash": str(account.cash)}, "paper_account": {"positions_count": len(pos_list), "positions": pos_list}, "trade_history": trades, "trades_loaded": len(trades)}
          
          Path("data").mkdir(exist_ok=True)
          with open("data/system_state.json", "w") as f: json.dump(state, f, indent=2)
          print(f"âœ… equity=${account.equity}, trades={len(trades)}, positions={len(pos_list)}")
          EOF
      - run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add data/system_state.json
          git diff --staged --quiet || git commit -m "ðŸ”„ sync [skip ci]"
          git push
