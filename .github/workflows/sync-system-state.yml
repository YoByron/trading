# .github/workflows/sync-system-state.yml
# FIX: trades_loaded = 0 and calendar awareness failures
# Add this workflow to your repo

name: Sync System State

on:
  schedule:
    # Run every hour during market hours (9 AM - 4 PM ET, Mon-Fri)
    - cron: '0 14-21 * * 1-5'  # UTC = ET + 5
  workflow_dispatch:  # Manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install alpaca-py requests
          
      - name: Validate Trading Day
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_SECRET }}
        run: |
          python3 << 'EOF'
          import os
          from datetime import datetime
          from alpaca.trading.client import TradingClient
          
          client = TradingClient(
              os.environ['ALPACA_API_KEY'],
              os.environ['ALPACA_SECRET_KEY'],
              paper=True
          )
          
          today = datetime.now().strftime("%Y-%m-%d")
          calendar = client.get_calendar(start=today, end=today)
          
          if not calendar:
              print(f"âš ï¸ {today} is NOT a trading day - skipping sync")
              exit(0)  # Exit gracefully, not an error
              
          print(f"âœ… {today} is a valid trading day")
          EOF
          
      - name: Sync Trades from Alpaca
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_SECRET }}
        run: |
          python3 << 'EOF'
          import json
          import os
          from datetime import datetime, timedelta
          from pathlib import Path
          from alpaca.trading.client import TradingClient
          from alpaca.trading.requests import GetOrdersRequest
          from alpaca.trading.enums import QueryOrderStatus
          
          # Get client
          client = TradingClient(
              os.environ['ALPACA_API_KEY'],
              os.environ['ALPACA_SECRET_KEY'],
              paper=True
          )
          
          # Fetch account
          account = client.get_account()
          
          # Fetch recent filled orders
          request = GetOrdersRequest(
              status=QueryOrderStatus.CLOSED,
              after=datetime.now() - timedelta(days=30),
              limit=100
          )
          orders = client.get_orders(filter=request)
          
          trades = []
          for order in orders:
              if order.filled_at:
                  trades.append({
                      "id": str(order.id),
                      "symbol": order.symbol,
                      "side": order.side.value,
                      "qty": float(order.filled_qty) if order.filled_qty else 0,
                      "filled_avg_price": float(order.filled_avg_price) if order.filled_avg_price else 0,
                      "filled_at": order.filled_at.isoformat(),
                      "status": order.status.value
                  })
          
          # Fetch positions
          positions = client.get_all_positions()
          pos_list = []
          for pos in positions:
              pos_list.append({
                  "symbol": pos.symbol,
                  "qty": float(pos.qty),
                  "market_value": float(pos.market_value),
                  "unrealized_pl": float(pos.unrealized_pl),
                  "current_price": float(pos.current_price)
              })
          
          # Build state
          state = {
              "last_updated": datetime.now().isoformat() + "Z",
              "portfolio": {
                  "equity": float(account.equity),
                  "cash": float(account.cash),
                  "buying_power": float(account.buying_power)
              },
              "paper_account": {
                  "positions_count": len(pos_list),
                  "positions": pos_list
              },
              "trade_history": trades,
              "trades_loaded": len(trades),
              "automation_active": True,
              "last_trade_date": trades[0]["filled_at"][:10] if trades else None
          }
          
          # Write state
          Path("data").mkdir(exist_ok=True)
          with open("data/system_state.json", "w") as f:
              json.dump(state, f, indent=2)
          
          print(f"âœ… Synced: equity=${account.equity}, trades={len(trades)}, positions={len(pos_list)}")
          EOF
          
      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/system_state.json
          git diff --staged --quiet || git commit -m "ðŸ”„ Auto-sync system state [skip ci]"
          git push
