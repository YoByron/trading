name: Sync System State

on:
  schedule:
    - cron: '0 14-21 * * 1-5'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: pip install alpaca-py requests
          
      - name: Sync Trades from Alpaca
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_SECRET }}
        run: |
          python3 << 'EOF'
          import json
          import os
          from datetime import datetime, timedelta
          from pathlib import Path
          from alpaca.trading.client import TradingClient
          from alpaca.trading.requests import GetOrdersRequest
          from alpaca.trading.enums import QueryOrderStatus
          
          client = TradingClient(
              os.environ['ALPACA_API_KEY'],
              os.environ['ALPACA_SECRET_KEY'],
              paper=True
          )
          
          clock = client.get_clock()
          print(f"Market open: {clock.is_open}")
          
          account = client.get_account()
          print(f"Account equity: ${account.equity}")
          
          # Fetch recent filled orders with error handling
          try:
              request = GetOrdersRequest(
                  status=QueryOrderStatus.CLOSED,
                  after=datetime.now() - timedelta(days=30),
                  limit=100
              )
              orders = client.get_orders(filter=request)
          except Exception as e:
              print(f"Warning: Could not fetch orders: {e}")
              orders = []
          
          trades = []
          for order in orders:
              try:
                  if order.filled_at:
                      trades.append({
                          "id": str(order.id),
                          "symbol": order.symbol,
                          "side": order.side.value if order.side else "unknown",
                          "qty": float(order.filled_qty) if order.filled_qty else 0,
                          "filled_avg_price": float(order.filled_avg_price) if order.filled_avg_price else 0,
                          "filled_at": order.filled_at.isoformat(),
                          "status": order.status.value if order.status else "unknown"
                      })
              except Exception as e:
                  print(f"Warning: Skipping order {order.id}: {e}")
          
          # Fetch positions
          try:
              positions = client.get_all_positions()
          except Exception as e:
              print(f"Warning: Could not fetch positions: {e}")
              positions = []
              
          pos_list = []
          for pos in positions:
              try:
                  pos_list.append({
                      "symbol": pos.symbol,
                      "qty": float(pos.qty),
                      "market_value": float(pos.market_value),
                      "unrealized_pl": float(pos.unrealized_pl),
                      "current_price": float(pos.current_price)
                  })
              except Exception as e:
                  print(f"Warning: Skipping position: {e}")
          
          state = {
              "last_updated": datetime.now().isoformat() + "Z",
              "portfolio": {
                  "equity": float(account.equity),
                  "cash": float(account.cash),
                  "buying_power": float(account.buying_power)
              },
              "paper_account": {
                  "positions_count": len(pos_list),
                  "positions": pos_list
              },
              "trade_history": trades,
              "trades_loaded": len(trades),
              "automation_active": True,
              "last_trade_date": trades[0]["filled_at"][:10] if trades else None
          }
          
          Path("data").mkdir(exist_ok=True)
          with open("data/system_state.json", "w") as f:
              json.dump(state, f, indent=2)
          
          print(f"âœ… Synced: equity=${account.equity}, trades={len(trades)}, positions={len(pos_list)}")
          EOF
          
      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/system_state.json
          git diff --staged --quiet || git commit -m "ðŸ”„ Auto-sync system state [skip ci]"
          git push
