name: Disable Generative Fallback

on:
  workflow_dispatch:

env:
  PROJECT_ID: igor-trading-2025-v2

jobs:
  disable:
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Check and Disable Generative Features
        run: |
          TOKEN=$(gcloud auth print-access-token)
          API_BASE="https://dialogflow.googleapis.com/v3"
          AGENT="projects/igor-trading-2025-v2/locations/global/agents/98373354-4197-4cb1-a7a0-1966ea6d27a7"
          FLOW="${AGENT}/flows/00000000-0000-0000-0000-000000000000"

          echo "=== FULL AGENT CONFIG ==="
          curl -s -X GET "${API_BASE}/${AGENT}" \
            -H "Authorization: Bearer $TOKEN" | jq '.'

          echo ""
          echo "=== FLOW CONFIG ==="
          curl -s -X GET "${API_BASE}/${FLOW}" \
            -H "Authorization: Bearer $TOKEN" | jq '.'

          echo ""
          echo "=== DISABLING GENERATIVE SETTINGS ==="

          # Disable generative fallback on agent
          curl -s -X PATCH \
            "${API_BASE}/${AGENT}?updateMask=genAppBuilderSettings" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "genAppBuilderSettings": null
            }'

          # Clear any generators on the agent
          echo ""
          echo "=== LISTING GENERATORS ==="
          GENERATORS=$(curl -s -X GET \
            "${API_BASE}/${AGENT}/generators" \
            -H "Authorization: Bearer $TOKEN")
          echo "$GENERATORS"

          # Delete any generators found
          echo "$GENERATORS" | jq -r '.generators[]?.name // empty' | while read gen; do
            if [ -n "$gen" ]; then
              echo "Deleting generator: $gen"
              curl -s -X DELETE "${API_BASE}/${gen}" \
                -H "Authorization: Bearer $TOKEN"
            fi
          done

          echo ""
          echo "=== DONE ==="
