name: Fix Dialogflow - Delete Hardcoded Intent

on:
  workflow_dispatch:

env:
  PROJECT_ID: igor-trading-2025-v2

jobs:
  fix:
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Remove AI Cortex Route Then Delete Intent
        run: |
          TOKEN=$(gcloud auth print-access-token)
          API_BASE="https://dialogflow.googleapis.com/v3"
          AGENT="projects/igor-trading-2025-v2/locations/global/agents/98373354-4197-4cb1-a7a0-1966ea6d27a7"
          FLOW="${AGENT}/flows/00000000-0000-0000-0000-000000000000"

          # The hardcoded AI Cortex intent
          AI_CORTEX_INTENT="${AGENT}/intents/84024fd4-2cdd-4f81-9744-484db6068048"

          echo "=== STEP 1: GET CURRENT FLOW CONFIG ==="
          FLOW_CONFIG=$(curl -s -X GET "${API_BASE}/${FLOW}" \
            -H "Authorization: Bearer $TOKEN")

          echo "Current transition routes:"
          echo "$FLOW_CONFIG" | jq '.transitionRoutes | length'

          echo ""
          echo "=== STEP 2: REMOVE AI CORTEX ROUTE FROM FLOW ==="

          # Filter out the route that references the AI Cortex intent
          NEW_ROUTES=$(echo "$FLOW_CONFIG" | jq '[.transitionRoutes[] | select(.intent != "'"$AI_CORTEX_INTENT"'")]')

          echo "Routes after filtering: $(echo "$NEW_ROUTES" | jq 'length')"

          # Update flow with filtered routes
          UPDATE_RESULT=$(curl -s -X PATCH \
            "${API_BASE}/${FLOW}?updateMask=transitionRoutes" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"transitionRoutes\": $NEW_ROUTES}")

          if echo "$UPDATE_RESULT" | jq -e '.error' > /dev/null 2>&1; then
            echo "⚠️ Flow update error:"
            echo "$UPDATE_RESULT" | jq '.error'
          else
            echo "✅ AI Cortex route removed from flow"
          fi

          # Wait a moment for the change to propagate
          sleep 2

          echo ""
          echo "=== STEP 3: DELETE AI CORTEX INTENT ==="
          echo "Deleting: $AI_CORTEX_INTENT"

          DELETE_RESULT=$(curl -s -X DELETE \
            "${API_BASE}/${AI_CORTEX_INTENT}" \
            -H "Authorization: Bearer $TOKEN")

          if [ -z "$DELETE_RESULT" ] || [ "$DELETE_RESULT" == "{}" ]; then
            echo "✅ Intent deleted successfully!"
          elif echo "$DELETE_RESULT" | jq -e '.error' > /dev/null 2>&1; then
            echo "⚠️ Delete error:"
            echo "$DELETE_RESULT" | jq '.error'
          else
            echo "Delete response: $DELETE_RESULT"
          fi

          echo ""
          echo "=== STEP 4: VERIFY WEBHOOK IS PRIMARY HANDLER ==="

          # Check webhook
          WEBHOOKS=$(curl -s -X GET "${API_BASE}/${AGENT}/webhooks" \
            -H "Authorization: Bearer $TOKEN")
          WEBHOOK_ID=$(echo "$WEBHOOKS" | jq -r '.webhooks[] | select(.displayName == "Trading RAG Webhook") | .name' | head -1)

          if [ -n "$WEBHOOK_ID" ]; then
            echo "✅ Webhook found: $WEBHOOK_ID"
          else
            echo "❌ No webhook found - creating one"
            # Create webhook if missing
            curl -s -X POST \
              "${API_BASE}/${AGENT}/webhooks" \
              -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              -d '{
                "displayName": "Trading RAG Webhook",
                "genericWebService": {
                  "uri": "https://trading-dialogflow-webhook-cqlewkvzdq-uc.a.run.app/webhook"
                },
                "timeout": "30s"
              }'
            WEBHOOKS=$(curl -s -X GET "${API_BASE}/${AGENT}/webhooks" -H "Authorization: Bearer $TOKEN")
            WEBHOOK_ID=$(echo "$WEBHOOKS" | jq -r '.webhooks[] | select(.displayName == "Trading RAG Webhook") | .name' | head -1)
          fi

          echo ""
          echo "=== STEP 5: UPDATE FLOW EVENT HANDLERS ==="

          # Ensure sys.no-match-default calls the webhook
          EVENT_UPDATE=$(curl -s -X PATCH \
            "${API_BASE}/${FLOW}?updateMask=eventHandlers" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"eventHandlers\": [
                {
                  \"event\": \"sys.no-match-default\",
                  \"triggerFulfillment\": {
                    \"webhook\": \"${WEBHOOK_ID}\",
                    \"tag\": \"rag-query\"
                  }
                }
              ]
            }")

          if echo "$EVENT_UPDATE" | jq -e '.error' > /dev/null 2>&1; then
            echo "⚠️ Event handler update error:"
            echo "$EVENT_UPDATE" | jq '.error'
          else
            echo "✅ Event handlers configured for webhook"
          fi

          echo ""
          echo "=== FINAL STATE ==="
          FINAL_FLOW=$(curl -s -X GET "${API_BASE}/${FLOW}" -H "Authorization: Bearer $TOKEN")
          echo "Transition routes: $(echo "$FINAL_FLOW" | jq '.transitionRoutes | length')"
          echo "Event handlers:"
          echo "$FINAL_FLOW" | jq '.eventHandlers'

          echo ""
          echo "============================================"
          echo "✅ DIALOGFLOW FIX COMPLETE"
          echo "============================================"
          echo "- Removed AI Cortex route from flow"
          echo "- Deleted hardcoded AI Cortex intent"
          echo "- Configured webhook for no-match events"
          echo "============================================"
