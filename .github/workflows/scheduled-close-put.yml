name: Scheduled Close SOFI Positions

# CTO AUTONOMOUS DECISION (Jan 14, 2026):
# CLOSE ALL SOFI POSITIONS - Earnings Jan 30, IV 55%, 12.2% expected move
# Phil Town Rule #1: Don't lose money through earnings volatility
# PDT blocked us today - this will execute tomorrow at market open

on:
  schedule:
    # Run at 9:35 AM ET (14:35 UTC) on Jan 14, 2026 - market open
    - cron: '35 14 14 1 *'
  workflow_dispatch:  # Manual trigger for testing

permissions:
  contents: write

jobs:
  close-sofi:
    name: Close ALL SOFI - Avoid Earnings Risk
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install alpaca-py

      - name: Close Put Position
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_SECRET }}
        run: |
          python3 << 'EOF'
          import os
          from datetime import datetime
          from alpaca.trading.client import TradingClient
          from alpaca.trading.requests import MarketOrderRequest
          from alpaca.trading.enums import OrderSide, TimeInForce

          api_key = os.environ['ALPACA_API_KEY']
          secret_key = os.environ['ALPACA_SECRET_KEY']

          print("=" * 60)
          print("SCHEDULED PUT CLOSURE - RULE #1 PROTECTION")
          print(f"Timestamp: {datetime.now().isoformat()}")
          print("=" * 60)

          client = TradingClient(api_key, secret_key, paper=True)

          # Get account and positions
          account = client.get_account()
          positions = client.get_all_positions()

          print(f"\nAccount Equity: ${float(account.equity):,.2f}")

          # CTO DECISION: Close ALL SOFI positions before Jan 30 earnings
          # 12.2% expected move, IV 55% - too risky to hold through

          print("\nðŸ“Š SOFI POSITIONS TO CLOSE:")
          sofi_positions = [p for p in positions if 'SOFI' in p.symbol]

          if not sofi_positions:
              print("No SOFI positions found - already closed")
              exit(0)

          for pos in sofi_positions:
              print(f"  {pos.symbol}: {pos.qty} shares/contracts, P/L: ${float(pos.unrealized_pl):,.2f}")

          total_pl = sum(float(p.unrealized_pl) for p in sofi_positions)
          print(f"\nTotal SOFI P/L: ${total_pl:,.2f}")

          # Close ALL positions - don't wait for profit, avoid earnings risk
          print("\nðŸš¨ CLOSING ALL SOFI - Earnings Jan 30 (16 days)")
          print("Expected move: 12.2% - too risky per Phil Town Rule #1")

          for pos in sofi_positions:
              qty = abs(float(pos.qty))
              is_short = float(pos.qty) < 0
              side = OrderSide.BUY if is_short else OrderSide.SELL

              print(f"\nClosing {pos.symbol}...")

              # Handle fractional shares for stock
              if len(pos.symbol) <= 6:  # Stock symbol
                  order_request = MarketOrderRequest(
                      symbol=pos.symbol,
                      qty=qty,
                      side=side,
                      time_in_force=TimeInForce.DAY
                  )
              else:  # Option symbol
                  order_request = MarketOrderRequest(
                      symbol=pos.symbol,
                      qty=int(qty),
                      side=side,
                      time_in_force=TimeInForce.DAY
                  )

              order = client.submit_order(order_request)
              print(f"  âœ… Order ID: {order.id}, Status: {order.status}")

          print("\n" + "=" * 60)
          print("RULE #1 PROTECTION: All SOFI positions closed before earnings!")
          print("=" * 60)
          EOF

      - name: Disable This Workflow
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "Put position closed - this scheduled workflow completed its purpose"
          # The workflow will only run once due to the specific date in cron
