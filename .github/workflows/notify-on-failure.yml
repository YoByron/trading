name: Notify on Trading Failure

on:
  workflow_run:
    workflows: ["Daily Trading Execution"]
    types:
      - completed

permissions:
  issues: write
  contents: read

jobs:
  notify-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Create GitHub Issue on Failure
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const run = context.payload.workflow_run;
            const runUrl = run.html_url;
            const runNumber = run.run_number;
            const runDate = new Date(run.created_at).toLocaleString('en-US', {
              timeZone: 'America/New_York'
            });

            const issueTitle = 'üö® Daily Trading Execution Failed - Run #' + runNumber;
            const workflowRunLink = '[' + '#' + runNumber + '](' + runUrl + ')';
            const issueBody = [
              '## Trading Execution Failure Alert',
              '',
              'Workflow Run: ' + workflowRunLink,
              'Date/Time: ' + runDate + ' EST',
              'Status: ' + run.conclusion,
              '',
              '### Action Required',
              '1. Check the workflow logs: ' + runUrl,
              '2. Verify GitHub Secrets are configured',
              '3. Check Alpaca API status',
              '4. Run manually if needed: `python scripts/autonomous_trader.py`',
              '',
              '### Fallback',
              'LaunchAgent on Mac should execute as backup at 9:35 AM EST.',
              '',
              '---',
              '*This issue was automatically created by the trading system.*'
            ].join('\n');

            // Check if issue already exists for this run
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'trading-failure'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes(`Run #${runNumber}`)
            );

            if (!existingIssue) {
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody + '\n\nü§ñ **Autonomous Resolution**: This issue will be automatically diagnosed and resolved by AI agents within 1 hour.',
                labels: ['trading-failure', 'automated', 'auto-resolve']
              });

              core.info(`Created issue #${newIssue.data.number} for failed run #${runNumber}`);

              // Trigger autonomous resolution workflow immediately
              try {
                await github.rest.actions.createWorkflowDispatch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: 'autonomous-issue-resolution.yml',
                  ref: 'main',
                  inputs: {
                    label: 'trading-failure',
                    max_issues: '5'
                  }
                });
                core.info('‚úÖ Triggered autonomous issue resolution workflow');
              } catch (error) {
                core.warning(`‚ö†Ô∏è  Could not trigger resolution workflow: ${error.message}`);
                core.info('   Resolution will run on next scheduled run (hourly)');
              }
            } else {
              core.info(`Issue already exists for run #${runNumber}`);
            }
