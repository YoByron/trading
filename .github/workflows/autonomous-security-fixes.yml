name: Autonomous Security Fixes

on:
  schedule:
    # Run daily at 2 AM UTC (9 PM ET previous day) to fix security issues before trading
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run mode (don't make changes)"
        required: false
        default: "false"
        type: boolean
      severity:
        description: "Minimum severity to fix"
        required: false
        default: "medium"
        type: choice
        options:
          - low
          - medium
          - high
          - critical

permissions:
  contents: write
  pull-requests: write
  security-events: read

jobs:
  security-fix:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run autonomous security fix agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ¤– Starting Autonomous Security Fix Agent..."

          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
          SEVERITY="${{ github.event.inputs.severity || 'medium' }}"

          if [ "$DRY_RUN" = "true" ]; then
            python3 scripts/autonomous_security_fix_agent.py \
              --dry-run \
              --severity "$SEVERITY" \
              --repo "${{ github.repository }}"
          else
            python3 scripts/autonomous_security_fix_agent.py \
              --auto-commit \
              --severity "$SEVERITY" \
              --repo "${{ github.repository }}"
          fi

      - name: Create PR if changes made
        if: github.event.inputs.dry_run != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if there are uncommitted changes
          if [ -n "$(git status --porcelain)" ]; then
            echo "ðŸ“ Creating PR for security fixes..."

            BRANCH="autonomous/security-fixes-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$BRANCH"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add requirements.txt requirements-*.txt
            git commit -m "chore(security): Autonomous security fixes" -m "Automatically fixed security vulnerabilities via Autonomous Security Fix Agent." -m "This PR was created automatically by the Autonomous Security Fixes workflow." -m "All changes have been tested for dependency resolution."

            git push origin "$BRANCH"

            PR_BODY="## ðŸ¤– Autonomous Security Fixes

This PR was automatically created by the Autonomous Security Fix Agent to fix security vulnerabilities.

### Changes
- Updated vulnerable dependencies to safe versions
- All changes tested for dependency resolution

### Testing
- âœ… Dependency resolution verified
- âœ… CI will run full test suite

### Next Steps
- Review the changes
- Merge if tests pass"

            gh pr create \
              --title "chore(security): Autonomous security fixes" \
              --body "$PR_BODY" \
              --label "dependencies,security,automated" \
              --base main
          else
            echo "âœ… No changes needed - all security issues already fixed"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ¤– Autonomous Security Fix Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Security vulnerabilities have been automatically assessed and fixed where possible." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Agent**: Autonomous Security Fix Agent" >> $GITHUB_STEP_SUMMARY
          echo "**Mode**: ${{ github.event.inputs.dry_run == 'true' && 'Dry Run' || 'Live' }}" >> $GITHUB_STEP_SUMMARY
