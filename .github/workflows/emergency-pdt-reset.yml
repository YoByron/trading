name: EMERGENCY - Reset PDT and Close Position

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  emergency-close:
    name: Emergency PDT Reset and Close
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install alpaca-py requests

      - name: Emergency Close Position
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_SECRET }}
        run: |
          python3 << 'EOF'
          import os
          import requests
          from datetime import datetime
          from alpaca.trading.client import TradingClient

          print("=" * 60)
          print(f"EMERGENCY PDT RESET - {datetime.now()}")
          print("=" * 60)

          api_key = os.environ['ALPACA_API_KEY']
          api_secret = os.environ['ALPACA_SECRET_KEY']
          base_url = "https://paper-api.alpaca.markets"

          headers = {
              "APCA-API-KEY-ID": api_key,
              "APCA-API-SECRET-KEY": api_secret,
          }

          # Step 1: Try to disable PDT check via config
          print("\n1️⃣ Attempting to disable PDT check...")
          try:
              resp = requests.patch(
                  f"{base_url}/v2/account/configurations",
                  headers=headers,
                  json={"pdt_check": "no", "no_shorting": False}
              )
              print(f"   Config response: {resp.status_code} - {resp.text[:200] if resp.text else 'OK'}")
          except Exception as e:
              print(f"   Config failed: {e}")

          # Step 2: Get account status
          client = TradingClient(api_key, api_secret, paper=True)
          account = client.get_account()
          print(f"\n2️⃣ Account Status:")
          print(f"   Equity: ${float(account.equity):,.2f}")
          print(f"   PDT Flag: {account.pattern_day_trader}")
          print(f"   Day Trade Count: {account.daytrade_count}")
          print(f"   Trading Blocked: {account.trading_blocked}")

          # Step 3: Get target position
          target = "SPY260220P00658000"
          positions = client.get_all_positions()
          target_pos = None
          for p in positions:
              if p.symbol == target:
                  target_pos = p
                  print(f"\n3️⃣ Target Position:")
                  print(f"   Symbol: {p.symbol}")
                  print(f"   Qty: {p.qty}")
                  print(f"   P/L: ${float(p.unrealized_pl):+,.2f}")
                  break

          if not target_pos:
              print(f"\n✅ Position {target} not found - already closed!")
              exit(0)

          # Step 4: Try multiple close methods
          print("\n4️⃣ Attempting to close position...")

          # Method A: Direct close_position
          print("\n   Method A: close_position()...")
          try:
              result = client.close_position(target)
              print(f"   ✅ SUCCESS! Order: {result}")
              exit(0)
          except Exception as e:
              print(f"   ❌ Failed: {str(e)[:100]}")

          # Method B: Cancel all orders first, then close
          print("\n   Method B: Cancel orders then close...")
          try:
              client.cancel_orders()
              print("   Cancelled pending orders")
              result = client.close_position(target)
              print(f"   ✅ SUCCESS! Order: {result}")
              exit(0)
          except Exception as e:
              print(f"   ❌ Failed: {str(e)[:100]}")

          # Method C: Close ALL positions at once
          print("\n   Method C: Close ALL positions...")
          try:
              result = client.close_all_positions(cancel_orders=True)
              print(f"   ✅ Closed all: {result}")
              exit(0)
          except Exception as e:
              print(f"   ❌ Failed: {str(e)[:100]}")

          # Method D: Raw API call
          print("\n   Method D: Raw API DELETE...")
          try:
              resp = requests.delete(
                  f"{base_url}/v2/positions/{target}",
                  headers=headers
              )
              print(f"   Response: {resp.status_code} - {resp.text[:200] if resp.text else 'OK'}")
              if resp.status_code in [200, 204]:
                  print("   ✅ SUCCESS via raw API!")
                  exit(0)
          except Exception as e:
              print(f"   ❌ Failed: {e}")

          print("\n" + "=" * 60)
          print("❌ ALL METHODS FAILED")
          print("=" * 60)
          print("\nMANUAL ACTION REQUIRED:")
          print("1. Go to https://app.alpaca.markets/paper/dashboard")
          print("2. Click 'Reset Account'")
          print("3. Set balance to $30,000+")
          print("=" * 60)
          exit(1)
          EOF

      - name: Sync State
        if: success()
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GH_PAT }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/sync-system-state.yml/dispatches" \
            -d '{"ref": "main"}'
