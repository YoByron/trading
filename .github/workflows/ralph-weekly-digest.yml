name: Ralph Weekly Digest

# Weekly summary of all Ralph mode activities
# Tracks: fixes applied, tests healed, code improved
# PUBLISHES: Blog post to GitHub Pages + Dev.to

on:
  schedule:
    # Run every Sunday at 8 AM UTC
    - cron: '0 8 * * 0'
  workflow_dispatch:

env:
  DEVTO_API_KEY: ${{ secrets.DEVTO_API_KEY }}

permissions:
  contents: write

jobs:
  generate-digest:
    runs-on: ubuntu-latest
    outputs:
      digest_file: ${{ steps.generate.outputs.digest_file }}
      has_activity: ${{ steps.generate.outputs.has_activity }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 100  # Get enough history

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Generate weekly digest
        id: generate
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          TODAY=$(date +%Y-%m-%d)
          WEEK_START=$(date -d 'last sunday' +%Y-%m-%d 2>/dev/null || date -v-sun +%Y-%m-%d)
          DIGEST_FILE="docs/_posts/${TODAY}-ralph-weekly-digest.md"

          # Count various metrics
          RALPH_COMMITS=$(git log --since="7 days ago" --oneline --grep="ralph\|self-heal\|auto-fix" | wc -l)
          FIX_COMMITS=$(git log --since="7 days ago" --oneline --grep="fix" | wc -l)
          FEAT_COMMITS=$(git log --since="7 days ago" --oneline --grep="feat" | wc -l)
          TOTAL_COMMITS=$(git log --since="7 days ago" --oneline | wc -l)
          TEST_COUNT=$(grep -r "def test_" tests/ 2>/dev/null | wc -l)
          PY_FILES=$(find src/ scripts/ -name "*.py" 2>/dev/null | wc -l)

          # Get workflow run counts
          WORKFLOW_RUNS=$(gh api repos/${{ github.repository }}/actions/runs --jq '.workflow_runs | length' 2>/dev/null || echo "N/A")

          # Check if there's any activity worth reporting
          if [ "$TOTAL_COMMITS" -gt 0 ]; then
            echo "has_activity=true" >> $GITHUB_OUTPUT
          else
            echo "has_activity=false" >> $GITHUB_OUTPUT
          fi

          # Create blog post using Python to avoid YAML heredoc issues
          mkdir -p docs/_posts
          export FIXES=$(git log --since="7 days ago" --oneline --grep="fix\|heal\|auto" | head -15 || echo "None this week")
          export FEATS=$(git log --since="7 days ago" --oneline --grep="feat" | head -10 || echo "None this week")
          export TODAY WEEK_START DIGEST_FILE TOTAL_COMMITS RALPH_COMMITS FIX_COMMITS FEAT_COMMITS TEST_COUNT PY_FILES
          python3 -c "
          import os
          DASH3 = '---'
          content = f'''{DASH3}
          layout: post
          title: \"Ralph Weekly Digest: Week of {os.environ['WEEK_START']}\"
          date: {os.environ['TODAY']}
          categories: [ralph, weekly-digest, ai-trading]
          tags: [ai, trading, automation, self-healing, claude]
          {DASH3}

          # Ralph Weekly Digest

          **Week of {os.environ['WEEK_START']} to {os.environ['TODAY']}**

          This week, Ralph - our AI CTO - has been working around the clock to improve the AI Trading System.

          {DASH3}

          ## Activity Summary

          | Metric | Count |
          |--------|-------|
          | Total commits | {os.environ['TOTAL_COMMITS']} |
          | Ralph/self-heal commits | {os.environ['RALPH_COMMITS']} |
          | Bug fixes | {os.environ['FIX_COMMITS']} |
          | New features | {os.environ['FEAT_COMMITS']} |
          | Tests in codebase | {os.environ['TEST_COUNT']} |
          | Python files | {os.environ['PY_FILES']} |

          ## Fixes Applied This Week

          {os.environ['FIXES']}

          ## New Features

          {os.environ['FEATS']}

          {DASH3}

          *Auto-generated by Ralph Mode.*

          **Links:**
          - [GitHub Repository](https://github.com/IgorGanapolsky/trading)
          - [AI Trading Blog](https://igorganapolsky.github.io/trading/)
          '''
          # Remove leading whitespace from each line
          import textwrap
          content = textwrap.dedent(content)
          with open(os.environ['DIGEST_FILE'], 'w') as f:
              f.write(content)
          "

          echo "digest_file=$DIGEST_FILE" >> $GITHUB_OUTPUT
          echo "Generated: $DIGEST_FILE"

      - name: Publish to Dev.to
        if: steps.generate.outputs.has_activity == 'true' && env.DEVTO_API_KEY != ''
        continue-on-error: true
        run: |
          python3 -c "
          import requests, os
          from datetime import datetime
          api_key = os.environ.get('DEVTO_API_KEY')
          if not api_key: print('No Dev.to API key'); exit(0)
          today = datetime.now().strftime('%Y-%m-%d')
          digest_path = os.environ.get('DIGEST_FILE', f'docs/_posts/{today}-ralph-weekly-digest.md')
          body = ''
          if os.path.exists(digest_path):
              with open(digest_path) as f: body = f.read().split('---', 2)[-1].strip()
          else: body = 'Weekly update from Ralph'
          article = {'article': {'title': f'Ralph Weekly Digest: AI Trading System Update ({today})', 'published': True, 'body_markdown': body, 'tags': ['ai', 'trading', 'automation', 'python'], 'series': 'AI Trading Journey'}}
          try:
              resp = requests.post('https://dev.to/api/articles', headers={'api-key': api_key, 'Content-Type': 'application/json'}, json=article)
              print(f'Published to Dev.to: {resp.json().get(\"url\")}' if resp.status_code in [200, 201] else f'Dev.to publish failed: {resp.status_code}')
          except Exception as e: print(f'Dev.to error: {e}')
          "

      - name: Commit digest blog post
        if: steps.generate.outputs.has_activity == 'true'
        run: |
          git config user.name "ralph-bot[bot]"
          git config user.email "ralph-bot[bot]@users.noreply.github.com"

          git add docs/_posts/ || true

          if ! git diff --staged --quiet; then
            git commit -m "docs(blog): Ralph weekly digest for $(date +%Y-%m-%d)"
            git push origin main || true
            echo "::notice::Weekly digest published to blog"
          fi

      - name: Post digest to summary
        run: |
          echo "## Ralph Weekly Digest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "${{ steps.generate.outputs.digest_file }}" ]; then
            cat "${{ steps.generate.outputs.digest_file }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Update prd.json iteration count
        run: |
          python3 -c "
          import json
          from datetime import datetime
          try:
              with open('.claude/prd.json', 'r') as f: data = json.load(f)
              current = data['metadata'].get('total_iterations', 0)
              data['metadata']['total_iterations'] = current + 1
              data['metadata']['notes'] = 'Weekly digest - Ralph Mode active'
              data['metadata']['last_digest'] = datetime.utcnow().isoformat() + 'Z'
              with open('.claude/prd.json', 'w') as f: json.dump(data, f, indent=2)
              print(f'Updated iterations: {current} -> {current + 1}')
          except Exception as e: print(f'Could not update prd.json: {e}')
          "
