name: Unified RAG Ingestion

permissions:
  contents: read

on:
  schedule:
    # Run daily at 6:00 AM ET (11:00 UTC) - before market analysis
    - cron: '0 11 * * 1-5'
  workflow_dispatch:  # Allow manual triggers

env:
  PYTHON_VERSION: '3.11'

jobs:
  ingest-all-sources:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Install lightweight RAG dependencies (FastEmbed + LanceDB)
          pip install fastembed lancedb pyarrow tqdm
          # Install optional dependencies for full ingestion
          pip install praw feedparser youtube-transcript-api yt-dlp
          # Whisper is optional (heavy dependency)
          pip install openai-whisper || echo "Whisper installation skipped (optional)"

      - name: Run Unified RAG Ingestion
        env:
          # Reddit API
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          # Alpaca API (for market data)
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          # OpenRouter for LLM analysis
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          # Other data sources
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
        run: |
          echo "Starting Unified RAG Ingestion..."
          python scripts/unified_rag_ingestion.py

      - name: Migrate to LanceDB (if not already migrated)
        run: |
          echo "Running LanceDB migration..."
          if [ ! -d "data/rag/lance_db" ] || [ -z "$(ls -A data/rag/lance_db 2>/dev/null)" ]; then
            python scripts/migrate_to_lancedb.py --source all || echo "Migration completed with warnings"
          else
            echo "LanceDB already populated, skipping migration"
          fi

      - name: Upload ingestion status
        uses: actions/upload-artifact@v4
        with:
          name: ingestion-status-${{ github.run_number }}
          path: data/ingestion_status.json
          retention-days: 7

      - name: Commit updated data
        run: |
          git config --local user.email "claude@anthropic.com"
          git config --local user.name "Claude (CTO)"

          # Add new data files
          git add data/sentiment/*.json || true
          git add data/youtube_cache/*.txt || true
          git add data/youtube_cache/*.json || true
          git add data/rag/*.json || true
          git add data/ingestion_status.json || true

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: Daily RAG ingestion $(date +%Y-%m-%d)

            - Reddit sentiment collected
            - YouTube transcripts updated
            - Old data purged (90-day retention)

            Generated by: Unified RAG Ingestion Workflow"
            git push
          fi
