name: Emergency Simple Trade (Proof of Life)

# BYPASS ALL GATES - Just prove the system can execute a trade
# CEO Directive (Jan 13, 2026): After 74 days of zero trades, we need proof

on:
  workflow_dispatch:
    inputs:
      symbol:
        description: "Symbol to trade"
        required: true
        default: "SOFI"
      quantity:
        description: "Shares to buy"
        required: true
        default: "1"

permissions:
  contents: write

jobs:
  simple-trade:
    name: Execute Simple Trade
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install minimal dependencies
        run: |
          pip install alpaca-py

      - name: Execute Trade
        id: trade
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_PAPER_TRADING_5K_API_SECRET }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          from datetime import datetime
          from alpaca.trading.client import TradingClient
          from alpaca.trading.requests import MarketOrderRequest
          from alpaca.trading.enums import OrderSide, TimeInForce

          api_key = os.environ['ALPACA_API_KEY']
          secret_key = os.environ['ALPACA_SECRET_KEY']
          symbol = "${{ github.event.inputs.symbol }}"
          qty = int("${{ github.event.inputs.quantity }}")

          print(f"ðŸš€ EMERGENCY TRADE - Proof of Life")
          print(f"   Symbol: {symbol}")
          print(f"   Quantity: {qty} shares")
          print(f"   Timestamp: {datetime.now().isoformat()}")
          print("=" * 50)

          client = TradingClient(api_key, secret_key, paper=True)

          # Get account
          account = client.get_account()
          print(f"\nðŸ“Š Account Status:")
          print(f"   Equity: ${float(account.equity):,.2f}")
          print(f"   Cash: ${float(account.cash):,.2f}")
          print(f"   Buying Power: ${float(account.buying_power):,.2f}")

          # Check if market is open
          clock = client.get_clock()
          print(f"\nâ° Market Status:")
          print(f"   Is Open: {clock.is_open}")

          if not clock.is_open:
              print("\nâš ï¸ Market is CLOSED - submitting order anyway (will queue)")

          # Submit order
          print(f"\nðŸ“ Submitting order...")
          order_request = MarketOrderRequest(
              symbol=symbol,
              qty=qty,
              side=OrderSide.BUY,
              time_in_force=TimeInForce.DAY
          )

          order = client.submit_order(order_request)

          print(f"\nâœ… ORDER SUBMITTED!")
          print(f"   Order ID: {order.id}")
          print(f"   Status: {order.status}")
          print(f"   Symbol: {order.symbol}")
          print(f"   Qty: {order.qty}")
          print(f"   Side: {order.side}")
          print(f"   Type: {order.type}")
          print(f"   Created: {order.created_at}")

          # Output for GitHub Actions
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"order_id={order.id}\n")
              f.write(f"status={order.status}\n")
              f.write(f"symbol={order.symbol}\n")

          print("\n" + "=" * 50)
          print("ðŸŽ‰ PROOF OF LIFE: System CAN execute trades!")
          print("=" * 50)
          PYTHON_SCRIPT

      - name: Record Trade Result
        if: success()
        run: |
          echo "Trade executed successfully!"
          echo "Order ID: ${{ steps.trade.outputs.order_id }}"
          echo "Status: ${{ steps.trade.outputs.status }}"

          # Create trade record
          mkdir -p data
          cat << EOF > data/trades_$(date +%Y-%m-%d).json
          [
            {
              "type": "emergency_proof_of_life",
              "symbol": "${{ github.event.inputs.symbol }}",
              "quantity": ${{ github.event.inputs.quantity }},
              "order_id": "${{ steps.trade.outputs.order_id }}",
              "status": "${{ steps.trade.outputs.status }}",
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }
          ]
          EOF

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add data/
          git commit -m "ðŸ“ˆ PROOF OF LIFE: First trade executed!" || echo "No changes to commit"
          git push || echo "Push skipped (may need token)"

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "ðŸ“Š EMERGENCY TRADE SUMMARY"
          echo "=========================================="
          echo "Symbol: ${{ github.event.inputs.symbol }}"
          echo "Quantity: ${{ github.event.inputs.quantity }}"
          echo "Order ID: ${{ steps.trade.outputs.order_id }}"
          echo "Status: ${{ steps.trade.outputs.status }}"
          echo "=========================================="
