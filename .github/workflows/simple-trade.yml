name: Simple Trade

on:
  push:
    paths:
      - '.github/SIMPLE_TRADE'
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  trade:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install alpaca-py
        run: pip install alpaca-py

      - name: Execute Trade
        env:
          APCA_API_KEY_ID: ${{ secrets.ALPACA_API_KEY }}
          APCA_API_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        run: |
          python3 << 'PY'
          import os, json
          from datetime import datetime, timezone

          print("="*50)
          print("SIMPLE TRADE")
          print("="*50)

          key = os.environ.get("APCA_API_KEY_ID")
          secret = os.environ.get("APCA_API_SECRET_KEY")

          if not key or not secret:
              print("ERROR: Missing ALPACA_API_KEY or ALPACA_SECRET_KEY secrets")
              exit(1)

          from alpaca.trading.client import TradingClient
          from alpaca.trading.requests import MarketOrderRequest
          from alpaca.trading.enums import OrderSide, TimeInForce

          client = TradingClient(key, secret, paper=True)
          account = client.get_account()
          print(f"Cash: ${float(account.cash):,.2f}")

          order = client.submit_order(MarketOrderRequest(
              symbol="SPY", qty=1, side=OrderSide.BUY, time_in_force=TimeInForce.DAY
          ))
          print(f"Order: {order.id} - {order.status}")

          today = datetime.now(timezone.utc).strftime("%Y-%m-%d")
          os.makedirs("data", exist_ok=True)
          with open(f"data/trades_{today}.json", "w") as f:
              json.dump([{"symbol":"SPY","action":"BUY","qty":1,"status":str(order.status),"id":str(order.id),"ts":datetime.now(timezone.utc).isoformat()}], f)
          print("SUCCESS!")
          PY

      - name: Commit and push trade data
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "trade: simple-trade executed [skip ci]"
          file_pattern: "data/trades_*.json"
          commit_user_name: "GitHub Actions Bot"
          commit_user_email: "actions@github.com"
