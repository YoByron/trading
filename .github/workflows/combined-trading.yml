name: Combined Trading (Equities + Options)

on:
  schedule:
    # Run twice daily on weekdays:
    # 1. 10:00 AM ET - Options premium selling (high IV capture)
    # 2. 3:55 PM ET - Equities MOC execution (trend confirmation)
    # AUTOMATIC DST HANDLING: Runs at both UTC times
    - cron: '0 14,15 * * 1-5'   # 10:00 AM Eastern (options)
    - cron: '55 19,20 * * 1-5'  # 3:55 PM Eastern (equities)
  workflow_dispatch:
    inputs:
      strategy:
        description: "Which strategy to run"
        required: true
        default: "both"
        type: choice
        options:
          - both
          - equities_only
          - options_only
      dry_run:
        description: "Dry run mode (no actual trades)"
        required: false
        default: "false"

permissions:
  contents: write

concurrency:
  group: combined-trading
  cancel-in-progress: false

jobs:
  determine-strategy:
    runs-on: ubuntu-22.04
    timeout-minutes: 2
    outputs:
      run_options: ${{ steps.determine.outputs.run_options }}
      run_equities: ${{ steps.determine.outputs.run_equities }}
      current_hour_et: ${{ steps.determine.outputs.current_hour_et }}
    steps:
      - name: Determine which strategies to run
        id: determine
        run: |
          # Get current hour in Eastern Time
          CURRENT_HOUR_ET=$(TZ='America/New_York' date +%H)
          echo "current_hour_et=$CURRENT_HOUR_ET" >> $GITHUB_OUTPUT
          echo "Current hour (ET): $CURRENT_HOUR_ET"

          # Manual dispatch overrides
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            STRATEGY="${{ github.event.inputs.strategy }}"
            case "$STRATEGY" in
              "both")
                echo "run_options=true" >> $GITHUB_OUTPUT
                echo "run_equities=true" >> $GITHUB_OUTPUT
                ;;
              "options_only")
                echo "run_options=true" >> $GITHUB_OUTPUT
                echo "run_equities=false" >> $GITHUB_OUTPUT
                ;;
              "equities_only")
                echo "run_options=false" >> $GITHUB_OUTPUT
                echo "run_equities=true" >> $GITHUB_OUTPUT
                ;;
            esac
            echo "Strategy: $STRATEGY (manual dispatch)"
          else
            # Scheduled run: determine by time
            if [ "$CURRENT_HOUR_ET" -ge 9 ] && [ "$CURRENT_HOUR_ET" -lt 12 ]; then
              # Morning: Options trading window
              echo "run_options=true" >> $GITHUB_OUTPUT
              echo "run_equities=false" >> $GITHUB_OUTPUT
              echo "Strategy: OPTIONS (10 AM ET window)"
            elif [ "$CURRENT_HOUR_ET" -ge 15 ] && [ "$CURRENT_HOUR_ET" -lt 17 ]; then
              # Afternoon: Equities MOC window
              echo "run_options=false" >> $GITHUB_OUTPUT
              echo "run_equities=true" >> $GITHUB_OUTPUT
              echo "Strategy: EQUITIES (3:55 PM ET window)"
            else
              # Off-hours: Skip
              echo "run_options=false" >> $GITHUB_OUTPUT
              echo "run_equities=false" >> $GITHUB_OUTPUT
              echo "Strategy: NONE (outside trading hours)"
            fi
          fi

  validate-environment:
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    needs: determine-strategy
    if: needs.determine-strategy.outputs.run_options == 'true' || needs.determine-strategy.outputs.run_equities == 'true'
    outputs:
      secrets_valid: ${{ steps.validate.outputs.secrets_valid }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install minimal dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install alpaca-py yfinance pandas numpy

      - name: Validate secrets
        id: validate
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        run: |
          if [ -z "$ALPACA_API_KEY" ] || [ -z "$ALPACA_SECRET_KEY" ]; then
            echo "secrets_valid=false" >> $GITHUB_OUTPUT
            echo "::error::Missing Alpaca credentials"
            exit 1
          fi
          echo "secrets_valid=true" >> $GITHUB_OUTPUT
          echo "Secrets validated"

  execute-options:
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    needs: [determine-strategy, validate-environment]
    if: needs.determine-strategy.outputs.run_options == 'true' && needs.validate-environment.outputs.secrets_valid == 'true'
    env:
      PYTHONPATH: ${{ github.workspace }}
    outputs:
      options_executed: ${{ steps.execute.outputs.executed }}
      options_signal: ${{ steps.execute.outputs.signal }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install alpaca-py yfinance pandas numpy

      - name: Execute Options Strategy
        id: execute
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          PAPER_TRADING: 'true'
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          # LangSmith observability (optional but recommended)
          LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
          LANGCHAIN_TRACING_V2: 'true'
          LANGCHAIN_PROJECT: 'trading-system'
        run: |
          echo "========================================"
          echo "OPTIONS TRADING - $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "========================================"
          echo ""
          echo "Strategy: IV-based signal generation with trend filter"
          echo "Dry Run: $DRY_RUN"
          echo ""

          # Run options signal generator
          python3 -c "
          import sys
          sys.path.insert(0, '.')

          from src.strategies.options_iv_signal import OptionsIVSignalGenerator, get_options_signal_generator
          from src.strategies.options_executor import OptionsExecutor, get_options_executor
          import yfinance as yf
          import json

          # Get current market data for SPY
          spy = yf.Ticker('SPY')
          hist = spy.history(period='1mo')

          if hist.empty:
              print('Could not fetch SPY data')
              sys.exit(1)

          current_price = hist['Close'].iloc[-1]
          print(f'SPY Current Price: \${current_price:.2f}')

          # Simulate IV metrics (in production, get from options chain)
          # For now, use placeholder values that would trigger a signal
          iv_current = 0.18  # 18% IV
          iv_52w_high = 0.35
          iv_52w_low = 0.12

          # Calculate ADX and DI from price history
          high = hist['High']
          low = hist['Low']
          close = hist['Close']

          # Simple ADX approximation
          tr = (high - low).rolling(14).mean()
          atr = tr.iloc[-1]
          price_range = (high.max() - low.min()) / current_price
          adx = min(50, max(10, price_range * 200))  # Rough approximation

          # Trend direction
          sma_fast = close.rolling(10).mean().iloc[-1]
          sma_slow = close.rolling(20).mean().iloc[-1]
          plus_di = 30 if sma_fast > sma_slow else 15
          minus_di = 15 if sma_fast > sma_slow else 30

          # RSI
          delta = close.diff()
          gain = (delta.where(delta > 0, 0)).rolling(14).mean()
          loss = (-delta.where(delta < 0, 0)).rolling(14).mean()
          rs = gain.iloc[-1] / loss.iloc[-1] if loss.iloc[-1] != 0 else 100
          rsi = 100 - (100 / (1 + rs))

          print(f'Market Indicators:')
          print(f'  IV: {iv_current:.1%} (Rank: {((iv_current - iv_52w_low) / (iv_52w_high - iv_52w_low)) * 100:.0f}%)')
          print(f'  ADX: {adx:.1f}')
          print(f'  +DI: {plus_di:.1f}, -DI: {minus_di:.1f}')
          print(f'  RSI: {rsi:.1f}')
          print()

          # Generate signal
          signal_gen = get_options_signal_generator()
          signal = signal_gen.generate_signal(
              symbol='SPY',
              current_iv=iv_current,
              iv_52w_high=iv_52w_high,
              iv_52w_low=iv_52w_low,
              adx=adx,
              plus_di=plus_di,
              minus_di=minus_di,
              rsi=rsi
          )

          print(f'Signal Generated:')
          print(f'  Actionable: {signal.is_actionable}')
          print(f'  Strategy: {signal.strategy}')
          print(f'  IV Rank: {signal.iv_rank:.0f}%')
          print(f'  Trend: {signal.trend_direction}')
          print(f'  Call Width: {signal.call_spread_width_pct:.1f}%')
          print(f'  Put Width: {signal.put_spread_width_pct:.1f}%')
          print(f'  Reason: {signal.reason}')
          print()

          if signal.is_actionable:
              # Generate order
              executor = get_options_executor()
              order = executor.generate_iron_condor_order(
                  symbol='SPY',
                  current_price=current_price,
                  call_spread_width_pct=signal.call_spread_width_pct,
                  put_spread_width_pct=signal.put_spread_width_pct,
                  expiration_days=45
              )

              print('Order Details:')
              print(json.dumps(order, indent=2, default=str))

              # Save order for reference
              with open('data/options_signal_latest.json', 'w') as f:
                  json.dump({
                      'signal': {
                          'symbol': signal.symbol,
                          'strategy': signal.strategy,
                          'iv_rank': signal.iv_rank,
                          'trend': signal.trend_direction,
                          'actionable': signal.is_actionable,
                          'reason': signal.reason
                      },
                      'order': order
                  }, f, indent=2, default=str)

              print()
              print('Signal saved to data/options_signal_latest.json')
          else:
              print(f'No trade: {signal.reason}')
          "

          echo "executed=true" >> $GITHUB_OUTPUT
          echo "Options strategy execution complete"

      - name: Upload Options Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: options-log-${{ github.run_id }}
          path: |
            data/options_signal_latest.json
            logs/options_*.log
          retention-days: 30

  execute-equities:
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    needs: [determine-strategy, validate-environment]
    if: needs.determine-strategy.outputs.run_equities == 'true' && needs.validate-environment.outputs.secrets_valid == 'true'
    env:
      PYTHONPATH: ${{ github.workspace }}
    outputs:
      equities_executed: ${{ steps.execute.outputs.executed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        env:
          PIP_EXTRA_INDEX_URL: https://download.pytorch.org/whl/cpu
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install --no-build-isolation multitasking || python3 -m pip install multitasking==0.0.11
          python3 -m pip install --no-cache-dir -r requirements-minimal.txt

      - name: Execute Equities Strategy
        id: execute
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          DAILY_INVESTMENT: ${{ secrets.DAILY_INVESTMENT || '10.0' }}
          PAPER_TRADING: 'true'
          # Tightened thresholds (Dec 10, 2025)
          MOMENTUM_ADX_MIN: '20.0'
          MOMENTUM_MACD_THRESHOLD: '0.0'
          MOMENTUM_RSI_OVERBOUGHT: '65.0'
          MOMENTUM_VOLUME_MIN: '1.0'
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          echo "========================================"
          echo "EQUITIES TRADING - $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "========================================"
          echo ""
          echo "Thresholds (Dec 10, 2025 - tightened):"
          echo "  ADX_MIN: $MOMENTUM_ADX_MIN (filter ranging markets)"
          echo "  MACD_THRESHOLD: $MOMENTUM_MACD_THRESHOLD (require confirmed bullish)"
          echo "  RSI_OVERBOUGHT: $MOMENTUM_RSI_OVERBOUGHT (avoid extremes)"
          echo "  VOLUME_MIN: $MOMENTUM_VOLUME_MIN (require average+ volume)"
          echo ""

          if [ "$DRY_RUN" = "true" ]; then
            echo "DRY RUN MODE - No actual trades will be placed"
            echo ""
          fi

          # Run the trading script
          python3 scripts/autonomous_trader.py

          echo "executed=true" >> $GITHUB_OUTPUT
          echo "Equities strategy execution complete"

      - name: Upload Equities Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: equities-log-${{ github.run_id }}
          path: |
            logs/*.log
            data/system_state.json
            data/trades_*.json
          retention-days: 30

  generate-combined-report:
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    needs: [determine-strategy, execute-options, execute-equities]
    if: always() && (needs.execute-options.result == 'success' || needs.execute-equities.result == 'success')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install alpaca-py

      - name: Generate Combined Report
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        run: |
          echo "========================================"
          echo "COMBINED TRADING REPORT"
          echo "Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "========================================"
          echo ""

          python3 -c "
          import os
          from alpaca.trading.client import TradingClient

          api_key = os.environ.get('ALPACA_API_KEY')
          secret_key = os.environ.get('ALPACA_SECRET_KEY')

          if not api_key or not secret_key:
              print('Alpaca credentials not available for report')
              exit(0)

          client = TradingClient(api_key, secret_key, paper=True)
          account = client.get_account()
          positions = client.get_all_positions()

          print('PORTFOLIO STATUS')
          print('=' * 40)
          print(f'Equity: \${float(account.equity):,.2f}')
          print(f'Cash: \${float(account.cash):,.2f}')
          print(f'Buying Power: \${float(account.buying_power):,.2f}')
          print(f'Day P/L: \${float(account.equity) - float(account.last_equity):+,.2f}')
          print()

          print('POSITIONS')
          print('=' * 40)
          if positions:
              for pos in positions:
                  unrealized_pl = float(pos.unrealized_pl)
                  print(f'{pos.symbol}: {pos.qty} shares @ \${float(pos.avg_entry_price):.2f} (P/L: \${unrealized_pl:+,.2f})')
          else:
              print('No open positions')
          print()

          print('STRATEGY EXECUTION')
          print('=' * 40)
          print(f'Options: ${{ needs.execute-options.result }}')
          print(f'Equities: ${{ needs.execute-equities.result }}')
          "

          echo ""
          echo "Report generation complete"

      - name: Upload Combined Report
        uses: actions/upload-artifact@v4
        with:
          name: combined-report-${{ github.run_id }}
          path: |
            data/options_signal_latest.json
            data/system_state.json
          retention-days: 30
