name: Pre-Merge Verification Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

# THIS IS WHAT IMPROVES RELIABILITY (not quantum computing)
# Blocks ANY PR that would break trading operations

jobs:
  verification-gate:
    name: üîí Verify No Breaking Changes
    runs-on: ubuntu-22.04
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt

      - name: üîí RUN VERIFICATION GATE
        run: |
          python3 scripts/pre_merge_verification_gate.py

      - name: ‚ùå Block on failure
        if: failure()
        run: |
          echo "::error::üö´ This PR would break trading operations!"
          echo "::error::Fix errors before merging to main."
          exit 1

  syntax-check:
    name: üîç Python Syntax
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Check syntax
        run: |
          find src scripts -name "*.py" -type f | while read file; do
            python3 -m py_compile "$file" || exit 1
          done
          echo "‚úÖ All Python files have valid syntax"

  langsmith-check:
    name: üîç LangSmith Integration
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install python-dotenv langsmith openai

      - name: Verify LangSmith wrapper imports
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |  # pragma: allowlist secret
          echo "üîç Verifying LangSmith wrapper imports correctly..."
          python3 -c "
          import os
          # Set test env vars to simulate production (not real secrets)
          os.environ['LANGCHAIN_API_KEY'] = 'test-key'  # pragma: allowlist secret
          os.environ['LANGCHAIN_PROJECT'] = 'test-project'

          # Force reload the module with env vars set
          import importlib
          import src.utils.langsmith_wrapper as wrapper
          importlib.reload(wrapper)

          from src.utils.langsmith_wrapper import (
              LANGSMITH_ENABLED,
              is_langsmith_enabled,
              get_observability_status,
              get_traced_openai_client,
          )

          # Verify wrapper accepts both LANGCHAIN_* and LANGSMITH_* env vars
          assert LANGSMITH_ENABLED == True, 'LANGSMITH_ENABLED should be True when LANGCHAIN_API_KEY is set'
          assert is_langsmith_enabled() == True, 'is_langsmith_enabled() should return True'

          status = get_observability_status()
          assert status['langsmith']['enabled'] == True, 'Status should show LangSmith enabled'

          print('‚úÖ LangSmith wrapper properly configured')
          print(f'   - LANGSMITH_ENABLED: {LANGSMITH_ENABLED}')
          print(f'   - Project: {status[\"langsmith\"][\"project\"]}')
          "

      - name: Verify env var fallback (LANGSMITH_* names)
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |  # pragma: allowlist secret
          echo "üîç Verifying LANGSMITH_* env var names work..."
          python3 -c "
          import os
          import sys

          # Clear any existing keys
          os.environ.pop('LANGCHAIN_API_KEY', None)
          os.environ.pop('LANGCHAIN_PROJECT', None)

          # Set LANGSMITH_* variants (alternative naming, not real secrets)
          os.environ['LANGSMITH_API_KEY'] = 'test-key-alt'  # pragma: allowlist secret
          os.environ['LANGSMITH_PROJECT'] = 'test-project-alt'

          # Force reimport
          if 'src.utils.langsmith_wrapper' in sys.modules:
              del sys.modules['src.utils.langsmith_wrapper']

          from src.utils.langsmith_wrapper import LANGSMITH_ENABLED, is_langsmith_enabled

          assert LANGSMITH_ENABLED == True, 'LANGSMITH_ENABLED should be True with LANGSMITH_API_KEY'
          assert is_langsmith_enabled() == True, 'is_langsmith_enabled() should work with LANGSMITH_API_KEY'

          print('‚úÖ LANGSMITH_* env var names work correctly')
          "
