name: Dependency Guardian

on:
  schedule:
    # Every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      create_issue:
        description: 'Create GitHub issue if conflicts found'
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  dependency-health-check:
    name: Comprehensive Dependency Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Upgrade pip and install tooling
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install pip-tools pipdeptree pip-audit

      - name: Run Dependency Guardian Agent
        id: guardian
        run: |
          echo "ğŸš€ Running Dependency Guardian Agent..."
          python3 scripts/dependency_guardian_agent.py || echo "guardian_status=issues_found" >> $GITHUB_OUTPUT

      - name: Upload dependency report as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report-${{ github.run_number }}
          path: |
            reports/dependency_guardian_*.md
          retention-days: 30

      - name: Create GitHub issue if conflicts detected
        if: |
          always() &&
          steps.guardian.outputs.guardian_status == 'issues_found' &&
          (github.event_name == 'schedule' ||
           (github.event_name == 'workflow_dispatch' && github.event.inputs.create_issue == 'true'))
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸš¨ Creating GitHub issue for dependency issues..."

          # Check if similar issue already exists
          EXISTING_ISSUE=$(gh issue list \
            --label "dependencies,automated" \
            --state open \
            --search "Dependency Health Alert" \
            --json number \
            --jq '.[0].number' || echo "")

          REPORT_FILE=$(ls -t reports/dependency_guardian_*.md | head -1)

          if [ -n "$EXISTING_ISSUE" ]; then
            echo "ğŸ“ Updating existing issue #$EXISTING_ISSUE"
            gh issue comment "$EXISTING_ISSUE" --body-file "$REPORT_FILE"
          else
            echo "ğŸ†• Creating new issue"
            gh issue create \
              --title "ğŸš¨ Dependency Health Alert - $(date -u +"%Y-%m-%d")" \
              --label "dependencies,automated,priority-high" \
              --assignee "@me" \
              --body-file "$REPORT_FILE"
          fi
