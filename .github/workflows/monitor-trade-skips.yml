name: Monitor Trade Skips

# Monitors for consecutive days of skipped trades and creates alerts
# Runs daily at 11:00 AM ET to review the previous 3 days of trading activity
# Created: Dec 15, 2025

on:
  schedule:
    # Daily at 11:00 AM ET (16:00 UTC in winter, 15:00 UTC in summer)
    # Using 16:00 UTC to be safe during EST
    - cron: '0 16 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  check-skips:
    name: Check Consecutive Trade Skips
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to access trade files

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check for consecutive skips
        id: skip_check
        run: |
          echo "=== CONSECUTIVE TRADE SKIP MONITOR ==="
          echo "Time: $(date -u)"
          echo "Checking last 3 days of trade data..."
          echo ""

          # Make script executable
          chmod +x scripts/check_consecutive_skips.py

          # Run the check script
          if python3 scripts/check_consecutive_skips.py; then
            echo "alert_needed=false" >> $GITHUB_OUTPUT
          else
            echo "alert_needed=true" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Create GitHub Issue Alert
        if: steps.skip_check.outputs.alert_needed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üö® Creating GitHub issue for consecutive trade skips..."

          # Read the issue body generated by the script
          if [ -f /tmp/skip_alert_body.txt ]; then
            ISSUE_BODY=$(cat /tmp/skip_alert_body.txt)

            # Create issue using gh CLI
            gh issue create \
              --title "üö® Trading Alert: Consecutive Trade Skips Detected" \
              --body "$ISSUE_BODY" \
              --label "trading-alert" \
              --label "needs-attention" \
              --label "automated"

            echo "‚úÖ Issue created successfully"
          else
            echo "‚ùå Error: Issue body file not found"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "=== SKIP MONITOR SUMMARY ==="
          echo ""
          if [ "${{ steps.skip_check.outputs.alert_needed }}" == "true" ]; then
            echo "üö® Alert: Consecutive skips detected - Issue created"
          else
            echo "‚úÖ No consecutive skips detected - System trading normally"
          fi
          echo ""
          echo "Monitor run completed at $(date -u)"

      - name: Upload skip analysis
        if: steps.skip_check.outputs.alert_needed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: skip-analysis-${{ github.run_number }}
          path: /tmp/skip_alert_body.txt
          retention-days: 30
