name: Pre-Commit Workflow Validation

on:
  pull_request:
    paths:
      - '.github/workflows/**'
      - 'scripts/test-workflows-local.sh'
      - '.actrc'

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate workflow files
        run: |
          echo "üîç Validating workflow syntax..."

          # Workflows with complex embedded JS templates that confuse YAML parser
          SKIP_FILES=("notify-on-failure.yml" "workflow-health-check.yml" "agent-pr-handler.yml")

          # Check for YAML syntax errors
          for workflow in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$workflow" ] && [[ ! "$workflow" == *.disabled ]]; then
              # Extract filename from path
              filename=$(basename "$workflow")

              # Skip files with embedded JS templates
              skip=false
              for skip_file in "${SKIP_FILES[@]}"; do
                if [ "$filename" == "$skip_file" ]; then
                  echo "‚è≠Ô∏è  Skipping $filename (contains embedded JS templates)"
                  skip=true
                  break
                fi
              done

              if [ "$skip" == "false" ]; then
                echo "Checking: $workflow"
                python3 -c "
          import yaml
          import sys
          try:
              with open('$workflow', 'r') as f:
                  yaml.safe_load(f)
              print('  ‚úÖ Valid YAML')
          except yaml.YAMLError as e:
              print(f'  ‚ùå YAML Error: {e}')
              sys.exit(1)
          " || exit 1
              fi
            fi
          done

          echo "‚úÖ All workflows have valid syntax"
