name: Deploy Dialogflow Webhook

on:
  push:
    branches:
      - main
    paths:
      - 'src/agents/dialogflow_webhook.py'
      - 'src/rag/**'
      - 'rag_knowledge/lessons_learned/**'
      - 'Dockerfile.webhook'
      - 'cloudbuild-webhook.yaml'
      - '.github/workflows/deploy-dialogflow-webhook.yml'
  workflow_dispatch:  # Manual trigger

env:
  PROJECT_ID: igor-trading-2025-v2
  REGION: us-central1
  SERVICE_NAME: trading-dialogflow-webhook

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Prepare Dockerfile
        run: |
          cp Dockerfile.webhook Dockerfile
          echo "=== Dockerfile contents ==="
          cat Dockerfile
          echo ""
          echo "=== Files to be uploaded ==="
          find . -type f ! -path './.git/*' | head -50

      - name: Build and Deploy with Cloud Build (no-cache)
        run: |
          # Use Cloud Build with explicit --no-cache to prevent stale images
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "Building with SHA: $SHORT_SHA"

          gcloud builds submit \
            --config=cloudbuild-webhook.yaml \
            --substitutions=SHORT_SHA=$SHORT_SHA \
            --project=${{ env.PROJECT_ID }} \
            . 2>&1 || {
              echo "=== Build failed, fetching Cloud Build logs ==="
              BUILD_ID=$(gcloud builds list --limit=1 --format='value(id)' --project=${{ env.PROJECT_ID }})
              if [ -n "$BUILD_ID" ]; then
                gcloud builds log $BUILD_ID --project=${{ env.PROJECT_ID }} || true
              fi
              exit 1
            }

      - name: Get service URL
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region ${{ env.REGION }} --format='value(status.url)')
          echo "üöÄ Webhook deployed to: $URL"
          echo "üìù Configure this URL in Dialogflow CX: $URL/webhook"
