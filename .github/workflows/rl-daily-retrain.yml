name: RL Daily Retraining (Feedback Loop)

on:
  schedule:
    # Run daily at 4:05 PM ET (after market close at 4:00 PM ET)
    # EST (Nov-Mar): UTC-5 -> 4:05 PM ET = 21:05 UTC
    # EDT (Mar-Nov): UTC-4 -> 4:05 PM ET = 20:05 UTC
    - cron: '5 20,21 * * 1-5'  # Weekdays only, covers both EST and EDT
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (don't update weights)"
        required: false
        default: "false"
  workflow_run:
    # Also trigger after daily trading completes
    workflows: ["Daily Trading Execution"]
    types:
      - completed

permissions:
  contents: write  # Need write to commit updated weights

# Only run one retraining at a time
concurrency:
  group: rl-daily-retrain
  cancel-in-progress: false

jobs:
  retrain-rl-weights:
    name: RL Feedback Loop Retraining
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install --no-cache-dir -r requirements-minimal.txt

      - name: Verify audit trail exists
        id: verify_audit
        run: |
          echo "ðŸ” Checking for audit trail..."

          if [ ! -f "data/audit_trail/hybrid_funnel_runs.jsonl" ]; then
            echo "âš ï¸  Audit trail not found - no trades to learn from yet"
            echo "This is normal on first run or if no trading has occurred."
            echo "has_audit=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Count events in audit trail
          EVENT_COUNT=$(wc -l < data/audit_trail/hybrid_funnel_runs.jsonl)
          echo "âœ… Found audit trail with $EVENT_COUNT events"
          echo "has_audit=true" >> $GITHUB_OUTPUT
          echo "event_count=$EVENT_COUNT" >> $GITHUB_OUTPUT

      - name: Run RL retraining
        if: steps.verify_audit.outputs.has_audit == 'true'
        env:
          DRY_RUN: ${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }}
        run: |
          echo "ðŸŽ“ ========================================"
          echo "ðŸŽ“ RL DAILY RETRAINING - Closing the feedback loop"
          echo "ðŸŽ“ ========================================"
          echo ""
          echo "ðŸ“Š Events in audit trail: ${{ steps.verify_audit.outputs.event_count }}"
          echo "ðŸ“… Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""

          # Run retraining
          if python3 scripts/rl_daily_retrain.py $DRY_RUN; then
            echo "training_status=success" >> $GITHUB_ENV
            echo "âœ… RL retraining completed successfully"
          else
            echo "training_status=failed" >> $GITHUB_ENV
            echo "âš ï¸  RL retraining completed with warnings (exit code $?)"
          fi

      - name: Check for weight updates
        id: check_weights
        if: steps.verify_audit.outputs.has_audit == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          echo "ðŸ” Checking for updated RL weights..."

          # Check if weights file changed
          if git diff --quiet models/ml/rl_filter_weights.json; then
            echo "weights_updated=false" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ No changes to RL weights (insufficient samples or no improvement)"
          else
            echo "weights_updated=true" >> $GITHUB_OUTPUT
            echo "âœ… RL weights updated!"

            # Show summary of changes
            echo "Changes detected:"
            git diff --stat models/ml/rl_filter_weights.json

            # Preview weight changes
            echo ""
            echo "Weight changes:"
            git diff models/ml/rl_filter_weights.json | head -50
          fi

      - name: Commit updated weights
        if: steps.check_weights.outputs.weights_updated == 'true'
        run: |
          echo "ðŸ’¾ Committing updated RL weights..."

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # Pull latest to avoid conflicts
          git pull --rebase origin main || {
            echo "âš ï¸  Merge conflict detected - resolving..."
            git checkout --ours models/ml/rl_filter_weights.json
            git add models/ml/rl_filter_weights.json
            git rebase --continue
          }

          # Stage updated weights
          git add models/ml/rl_filter_weights.json
          git add models/ml/rl_filter_policy.zip 2>/dev/null || true

          # Create commit
          git commit -m "$(cat <<'EOF'
          chore(ml): Update RL weights from daily feedback loop

          RL agent learned from trade outcomes and updated weights.

          Retraining details:
          - Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          - Events processed: ${{ steps.verify_audit.outputs.event_count }}
          - Workflow: rl-daily-retrain.yml
          - Run ID: ${{ github.run_id }}

          Changes:
          - Updated RL filter weights based on trade performance
          - System will use new weights on next trading session
          - Feedback loop ensures continuous improvement

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>
          EOF
          )"

          # Push changes
          git push origin main

          echo "âœ… Updated weights committed and pushed"

      - name: Generate retraining summary
        if: always() && steps.verify_audit.outputs.has_audit == 'true'
        run: |
          echo "## ðŸŽ“ RL Daily Retraining Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ env.training_status || 'not_run' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Telemetry" >> $GITHUB_STEP_SUMMARY
          echo "- Events in audit trail: ${{ steps.verify_audit.outputs.event_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- Weights updated: ${{ steps.check_weights.outputs.weights_updated || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_weights.outputs.weights_updated }}" = "true" ]; then
            echo "### âœ… Weights Updated" >> $GITHUB_STEP_SUMMARY
            echo "The RL agent learned from recent trades and updated its decision weights." >> $GITHUB_STEP_SUMMARY
            echo "New weights will be used in the next trading session." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ“‹ No Weight Changes" >> $GITHUB_STEP_SUMMARY
            echo "Either insufficient samples for retraining or no improvement detected." >> $GITHUB_STEP_SUMMARY
            echo "System will continue using existing weights." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload retraining logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rl-retraining-logs-${{ github.run_id }}
          path: |
            logs/*.log
            data/audit_trail/hybrid_funnel_runs.jsonl
            models/ml/rl_filter_weights.json
            models/ml/rl_filter_policy.zip
          retention-days: 30
