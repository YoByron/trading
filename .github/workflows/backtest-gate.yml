name: Backtest Quality Gate

on:
  pull_request:
    branches: [main]
    paths:
      - 'src/strategies/**'
      - 'src/ml/**'
      - 'src/agents/**'
      - 'src/backtesting/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  backtest-validation:
    name: Strategy Backtest Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install dependencies
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          uv pip sync --system requirements.txt

      - name: Run Backtest Gate
        id: backtest
        env:
          PYTHONPATH: ${{ github.workspace }}
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        run: |
          python scripts/ci_backtest_gate.py \
            --min-profit 0 \
            --max-drawdown 10 \
            --min-win-rate 50 \
            --output results.json

          # Check if backtest passed
          if [ $? -eq 0 ]; then
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backtest-results
          path: results.json

      - name: Post PR Comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let results;
            try {
              results = JSON.parse(fs.readFileSync('results.json', 'utf8'));
            } catch (e) {
              results = { error: 'Could not load results' };
            }

            const passed = '${{ steps.backtest.outputs.status }}' === 'passed';
            const emoji = passed ? '✅' : '❌';

            const body = `## ${emoji} Backtest Quality Gate

            ${passed ? '**All checks passed!**' : '**Some checks failed.**'}

            | Metric | Value | Threshold | Status |
            |--------|-------|-----------|--------|
            | Net Profit | ${results.net_profit || 'N/A'} | > $0 | ${(results.net_profit || 0) > 0 ? '✅' : '❌'} |
            | Max Drawdown | ${results.max_drawdown || 'N/A'}% | < 10% | ${(results.max_drawdown || 100) < 10 ? '✅' : '❌'} |
            | Win Rate | ${results.win_rate || 'N/A'}% | > 50% | ${(results.win_rate || 0) > 50 ? '✅' : '❌'} |
            | Sharpe Ratio | ${results.sharpe_ratio || 'N/A'} | > 0.5 | ${(results.sharpe_ratio || 0) > 0.5 ? '✅' : '❌'} |

            ${!passed ? '\n⚠️ **To merge with failing backtest:** Add `ACCEPT_BACKTEST_DEGRADATION` to PR description.' : ''}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Check for Degradation Acceptance
        if: steps.backtest.outputs.status == 'failed'
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          if [[ "$PR_BODY" == *"ACCEPT_BACKTEST_DEGRADATION"* ]]; then
            echo "⚠️ Backtest degradation explicitly accepted in PR description."
            exit 0
          else
            echo "::error::Backtest failed! Add 'ACCEPT_BACKTEST_DEGRADATION' to PR description if intentional."
            exit 1
          fi

  pessimistic-backtest:
    name: Pessimistic Backtest (Stress Test)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    # Only run on PRs that modify strategy or ML code
    if: |
      contains(github.event.pull_request.labels.*.name, 'needs-stress-test') ||
      contains(github.event.pull_request.files.*.path, 'src/strategies/core_strategy')

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install dependencies
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          uv pip sync --system requirements.txt

      - name: Run Pessimistic Backtest
        env:
          PYTHONPATH: ${{ github.workspace }}
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        run: |
          python scripts/ci_backtest_gate.py \
            --pessimistic \
            --min-profit -500 \
            --max-drawdown 15 \
            --output pessimistic_results.json

          echo "Pessimistic backtest complete. See results for stress test validation."

      - name: Upload Pessimistic Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pessimistic-backtest-results
          path: pessimistic_results.json
