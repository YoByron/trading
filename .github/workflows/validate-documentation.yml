name: Validate Documentation

on:
  push:
    branches: [main]
    paths:
      - '**/*.md'
      - 'docs/**'
      - '.claude/**/*.md'
      - 'rag_knowledge/**/*.md'
  pull_request:
    branches: [main]
    paths:
      - '**/*.md'
      - 'docs/**'
      - '.claude/**/*.md'
      - 'rag_knowledge/**/*.md'
  workflow_dispatch:

jobs:
  validate-markdown:
    name: Markdown Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint
        run: npm install -g markdownlint-cli

      - name: Lint Markdown files
        run: |
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║           MARKDOWN DOCUMENTATION VALIDATION                ║"
          echo "╚════════════════════════════════════════════════════════════╝"

          # Create config that's not too strict
          cat > .markdownlint.json << 'EOF'
          {
            "default": true,
            "MD013": false,
            "MD033": false,
            "MD041": false,
            "MD024": false,
            "MD036": false
          }
          EOF

          # Count markdown files
          MD_COUNT=$(find . -name "*.md" -not -path "./.git/*" | wc -l)
          echo "Found $MD_COUNT markdown files to validate"
          echo ""

          # Lint with warnings only (don't fail on style issues)
          markdownlint '**/*.md' --ignore node_modules --ignore .git || echo "::warning::Some markdown lint issues found (non-blocking)"

      - name: Check for broken internal links
        run: |
          echo "Checking for broken internal links..."

          BROKEN_LINKS=0

          # Find all markdown links to local files
          for md_file in $(find . -name "*.md" -not -path "./.git/*" -not -path "./node_modules/*"); do
            # Extract local file references (not http/https)
            links=$(grep -oE '\[([^\]]+)\]\(([^)]+)\)' "$md_file" 2>/dev/null | grep -v 'http' | grep -oE '\(([^)]+)\)' | tr -d '()' || true)

            for link in $links; do
              # Skip anchors and mailto
              if [[ "$link" == \#* ]] || [[ "$link" == mailto:* ]]; then
                continue
              fi

              # Resolve relative path
              base_dir=$(dirname "$md_file")
              full_path="$base_dir/$link"

              # Check if file exists
              if [[ ! -f "$full_path" ]] && [[ ! -d "$full_path" ]]; then
                # Try from repo root
                if [[ ! -f "$link" ]] && [[ ! -d "$link" ]]; then
                  echo "::warning::Broken link in $md_file: $link"
                  BROKEN_LINKS=$((BROKEN_LINKS + 1))
                fi
              fi
            done
          done

          echo ""
          if [ "$BROKEN_LINKS" -gt 0 ]; then
            echo "⚠️  Found $BROKEN_LINKS potentially broken links"
          else
            echo "✅ No broken internal links found"
          fi

      - name: Validate code blocks in markdown
        run: |
          echo "Checking code blocks for syntax indicators..."

          # Find code blocks without language specification
          UNSPECIFIED=$(grep -rn '```$' --include="*.md" . 2>/dev/null | grep -v ".git" | wc -l || echo "0")

          if [ "$UNSPECIFIED" -gt 10 ]; then
            echo "::warning::Found $UNSPECIFIED code blocks without language specification"
          else
            echo "✅ Code blocks look good ($UNSPECIFIED without language spec)"
          fi

      - name: Check documentation freshness
        run: |
          echo "Checking for stale documentation..."

          # Find markdown files not modified in 60 days
          STALE=$(find docs/ -name "*.md" -mtime +60 2>/dev/null | wc -l || echo "0")

          if [ "$STALE" -gt 5 ]; then
            echo "::warning::Found $STALE documentation files older than 60 days in docs/"
          else
            echo "✅ Documentation freshness OK"
          fi

      - name: Validate CLAUDE.md exists and is valid
        run: |
          echo "Validating CLAUDE.md..."

          if [ ! -f ".claude/CLAUDE.md" ]; then
            echo "::error::Missing .claude/CLAUDE.md - required for Claude Code"
            exit 1
          fi

          # Check CLAUDE.md has required sections
          CLAUDE_SIZE=$(wc -c < .claude/CLAUDE.md)
          if [ "$CLAUDE_SIZE" -lt 1000 ]; then
            echo "::warning::CLAUDE.md seems too small ($CLAUDE_SIZE bytes)"
          fi

          echo "✅ CLAUDE.md exists ($CLAUDE_SIZE bytes)"

      - name: Summary
        run: |
          echo ""
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║              DOCUMENTATION VALIDATION COMPLETE             ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          echo ""
          echo "All critical documentation checks passed!"
