name: Verify Trade Execution

# CEO Directive (Jan 10, 2026): Monitor to catch if trades fail to execute
# This runs AFTER daily-trading to verify trades actually happened

on:
  # Run after daily-trading workflow completes
  workflow_run:
    workflows: ["Daily Trading Execution"]
    types:
      - completed

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      date:
        description: "Date to verify (YYYY-MM-DD)"
        required: false
        default: ""

permissions:
  contents: read
  issues: write

jobs:
  verify-execution:
    name: Verify Trades Executed
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install alpaca-py

      - name: Get verification date
        id: get_date
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            echo "date=${{ github.event.inputs.date }}" >> $GITHUB_OUTPUT
          else
            echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          fi

      - name: Verify trade execution
        id: verify
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_PAPER_TRADING_30K_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_PAPER_TRADING_30K_API_SECRET }}
          PAPER_TRADING: "true"
        run: |
          echo "üîç Verifying trades for ${{ steps.get_date.outputs.date }}..."

          if python3 scripts/verify_trade_execution.py --date "${{ steps.get_date.outputs.date }}"; then
            echo "verification_passed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Trade verification PASSED"
          else
            echo "verification_passed=false" >> $GITHUB_OUTPUT
            echo "‚ùå Trade verification FAILED"
          fi

      - name: Check if this is a weekday
        id: check_weekday
        run: |
          DAY_OF_WEEK=$(date +%u)
          if [ "$DAY_OF_WEEK" -ge 1 ] && [ "$DAY_OF_WEEK" -le 5 ]; then
            echo "is_weekday=true" >> $GITHUB_OUTPUT
          else
            echo "is_weekday=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Weekend - trade verification skipped (expected)"
          fi

      - name: Create issue on failure (weekdays only, with deduplication)
        if: steps.verify.outputs.verification_passed == 'false' && steps.check_weekday.outputs.is_weekday == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const date = '${{ steps.get_date.outputs.date }}';
            const title = `üö® Trade Execution Failed - ${date}`;

            // Check if issue already exists for today (deduplication)
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'trading,urgent',
              per_page: 100
            });

            const todayIssue = existingIssues.data.find(issue =>
              issue.title.includes(date) && issue.title.includes('Trade Execution Failed')
            );

            if (todayIssue) {
              console.log(`üìù Issue #${todayIssue.number} already exists for ${date} - skipping duplicate creation`);

              // Add a comment to existing issue instead
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: todayIssue.number,
                body: `üîÑ **Verification re-run at ${new Date().toISOString()}**\n\nWorkflow run: ${{ github.run_id }}\nStill no trades detected.`
              });
              return;
            }

            const body = [
              '## Trade Verification Failed',
              '',
              `**Date**: ${date}`,
              `**Workflow Run**: ${{ github.run_id }}`,
              '',
              '### What Happened',
              'The daily-trading workflow completed but verification detected that trades may not have executed.',
              '',
              '### Possible Causes',
              '1. Phil Town script analyzed but didn\'t place orders',
              '2. Insufficient buying power for CSPs (need $500 minimum, check current balance)',
              '3. Market conditions didn\'t meet entry criteria',
              '4. API errors during order submission',
              '',
              '### Required Actions',
              `- [ ] Check [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`,
              '- [ ] Verify Alpaca account has orders',
              '- [ ] Review `scripts/rule_one_trader.py` output',
              `- [ ] Check \`data/trades_${date}.json\` exists`,
              '',
              '---',
              '*Auto-generated by verify-trade-execution.yml*'
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'trading', 'urgent']
            });

            console.log('üìß Issue created for failed trade verification');

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "üìä TRADE VERIFICATION SUMMARY"
          echo "=========================================="
          echo "Date: ${{ steps.get_date.outputs.date }}"
          echo "Weekday: ${{ steps.check_weekday.outputs.is_weekday }}"
          echo "Verification: ${{ steps.verify.outputs.verification_passed == 'true' && '‚úÖ PASSED' || '‚ùå FAILED' }}"

          if [ "${{ steps.verify.outputs.verification_passed }}" == "false" ] && [ "${{ steps.check_weekday.outputs.is_weekday }}" == "true" ]; then
            echo ""
            echo "üö® ALERT: Trade execution verification FAILED on a weekday!"
            echo "   An issue has been created for investigation."
          fi
          echo "=========================================="
