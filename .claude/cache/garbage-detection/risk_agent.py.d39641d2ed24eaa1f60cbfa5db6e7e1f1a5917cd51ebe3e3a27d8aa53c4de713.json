{
  "dead_imports": [],
  "commented_blocks": [],
  "empty_functions": [],
  "unused_variables": [
    {
      "line": 17,
      "variable": "logger"
    }
  ],
  "all_functions": [
    {
      "name": "__init__",
      "line": 31,
      "code": "def __init__(self, max_portfolio_risk: float=0.02, max_position_size: float=0.05):\n    super().__init__(name='RiskAgent', role='Portfolio risk management and position sizing')\n    self.max_portfolio_risk = max_portfolio_risk\n    self.max_position_size = max_position_size"
    },
    {
      "name": "analyze",
      "line": 40,
      "code": "def analyze(self, data: Dict[str, Any]) -> Dict[str, Any]:\n    \"\"\"\n        Assess risk and calculate position sizing.\n\n        Args:\n            data: Portfolio state, proposed trade, market conditions\n\n        Returns:\n            Risk analysis with position size recommendation\n        \"\"\"\n    portfolio_value = data.get('portfolio_value', 100000)\n    proposed_action = data.get('proposed_action', 'HOLD')\n    symbol = data.get('symbol', 'UNKNOWN')\n    confidence = data.get('confidence', 0.5)\n    volatility = data.get('volatility', 0.2)\n    win_rate = data.get('historical_win_rate', 0.6)\n    position_size = self._calculate_position_size(portfolio_value, confidence, volatility, win_rate)\n    stop_loss_pct = self._calculate_stop_loss(volatility)\n    memory_context = self.get_memory_context(limit=3)\n    prompt = f'You are a Risk Agent evaluating a proposed {proposed_action} trade on {symbol}.\\n\\nPORTFOLIO STATE:\\n- Total Value: ${portfolio_value:,.2f}\\n- Max Risk Per Trade: {self.max_portfolio_risk:.2%}\\n- Max Position Size: {self.max_position_size:.2%}\\n\\nPROPOSED TRADE:\\n- Action: {proposed_action}\\n- Confidence: {confidence:.2f}\\n- Symbol Volatility: {volatility:.2%}\\n- Historical Win Rate: {win_rate:.2%}\\n\\nCALCULATED RISK PARAMETERS:\\n- Recommended Position Size: ${position_size:,.2f} ({position_size / portfolio_value:.2%} of portfolio)\\n- Recommended Stop-Loss: {stop_loss_pct:.2%}\\n- Max Loss: ${position_size * stop_loss_pct:,.2f}\\n\\n{memory_context}\\n\\nTASK: Provide risk assessment:\\n1. Risk Score (1-10, where 10 is highest risk)\\n2. Position Size Approval (APPROVE / REDUCE / REJECT)\\n3. Final Position Size (in $)\\n4. Stop-Loss Level (%)\\n5. Key Risk Factors\\n6. Overall Recommendation: APPROVE / REJECT\\n\\nFormat:\\nRISK_SCORE: [1-10]\\nPOSITION_APPROVAL: [APPROVE/REDUCE/REJECT]\\nPOSITION_SIZE: [dollars]\\nSTOP_LOSS: [percentage]\\nRISKS: [key risks]\\nRECOMMENDATION: [APPROVE/REJECT]'\n    response = self.reason_with_llm(prompt)\n    analysis = self._parse_risk_response(response['reasoning'])\n    analysis['calculated_position_size'] = position_size\n    analysis['calculated_stop_loss'] = stop_loss_pct\n    analysis['full_reasoning'] = response['reasoning']\n    self.log_decision(analysis)\n    return analysis"
    },
    {
      "name": "_calculate_position_size",
      "line": 118,
      "code": "def _calculate_position_size(self, portfolio_value: float, confidence: float, volatility: float, win_rate: float) -> float:\n    \"\"\"\n        Calculate position size using Kelly Criterion with safety adjustments.\n\n        Args:\n            portfolio_value: Total portfolio value\n            confidence: Trade confidence (0-1)\n            volatility: Symbol volatility\n            win_rate: Historical win rate\n\n        Returns:\n            Position size in dollars\n        \"\"\"\n    win_prob = min(confidence * win_rate, 0.8)\n    loss_prob = 1 - win_prob\n    win_loss_ratio = 1.5\n    kelly_fraction = (win_prob * win_loss_ratio - loss_prob) / win_loss_ratio\n    safe_fraction = max(kelly_fraction * 0.5, 0.01)\n    safe_fraction = min(safe_fraction, self.max_position_size)\n    volatility_adjustment = 1.0 / (1.0 + volatility * 2)\n    adjusted_fraction = safe_fraction * volatility_adjustment\n    position_size = portfolio_value * adjusted_fraction\n    position_size = max(position_size, 10.0)\n    position_size = min(position_size, portfolio_value * self.max_position_size)\n    return position_size"
    },
    {
      "name": "_calculate_stop_loss",
      "line": 162,
      "code": "def _calculate_stop_loss(self, volatility: float) -> float:\n    \"\"\"\n        Calculate stop-loss percentage based on volatility.\n\n        Args:\n            volatility: Symbol volatility\n\n        Returns:\n            Stop-loss percentage (e.g., 0.05 = 5%)\n        \"\"\"\n    stop_loss = volatility * 2\n    stop_loss = max(stop_loss, 0.02)\n    stop_loss = min(stop_loss, 0.1)\n    return stop_loss"
    },
    {
      "name": "_parse_risk_response",
      "line": 181,
      "code": "def _parse_risk_response(self, reasoning: str) -> Dict[str, Any]:\n    \"\"\"Parse LLM response into structured risk assessment.\"\"\"\n    lines = reasoning.split('\\n')\n    analysis = {'risk_score': 5, 'position_approval': 'APPROVE', 'position_size': 0, 'stop_loss': 0.05, 'risks': '', 'action': 'APPROVE'}\n    for line in lines:\n        line = line.strip()\n        if line.startswith('RISK_SCORE:'):\n            try:\n                analysis['risk_score'] = int(line.split(':')[1].strip())\n            except:\n                pass\n        elif line.startswith('POSITION_APPROVAL:'):\n            approval = line.split(':')[1].strip().upper()\n            if approval in ['APPROVE', 'REDUCE', 'REJECT']:\n                analysis['position_approval'] = approval\n        elif line.startswith('POSITION_SIZE:'):\n            try:\n                size_str = line.split(':')[1].strip().replace('$', '').replace(',', '')\n                analysis['position_size'] = float(size_str)\n            except:\n                pass\n        elif line.startswith('STOP_LOSS:'):\n            try:\n                sl_str = line.split(':')[1].strip().replace('%', '')\n                analysis['stop_loss'] = float(sl_str) / 100\n            except:\n                pass\n        elif line.startswith('RISKS:'):\n            analysis['risks'] = line.split(':', 1)[1].strip()\n        elif line.startswith('RECOMMENDATION:'):\n            rec = line.split(':')[1].strip().upper()\n            if rec in ['APPROVE', 'REJECT']:\n                analysis['action'] = rec\n    return analysis"
    }
  ]
}
