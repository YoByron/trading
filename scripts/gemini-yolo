#!/bin/bash
#
# gemini-yolo: A command-line interface to chat with Gemini 3 Pro via OpenRouter.
#

set -euo pipefail

# Function to show usage
usage() {
  echo "Usage: gemini-yolo \"<your prompt>\""
  echo "Example: ./scripts/gemini-yolo \"What are the top 3 AI trends in finance for 2025?\""
  exit 1
}

# Check for prompt
if [ -z "${1-}" ]; then
  usage
fi

PROMPT="$1"

# Find the .env file in the project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
ENV_FILE="$PROJECT_ROOT/.env"

if [ ! -f "$ENV_FILE" ]; then
  echo "Error: .env file not found at $PROJECT_ROOT"
  echo "Please create it from .env.example and add your OPENROUTER_API_KEY."
  exit 1
fi

# Source the .env file to get the API key
# Use a subshell to avoid polluting the current environment
OPENROUTER_API_KEY=$(grep OPENROUTER_API_KEY "$ENV_FILE" | cut -d '=' -f2)

if [ -z "$OPENROUTER_API_KEY" ]; then
  echo "Error: OPENROUTER_API_KEY not found in $ENV_FILE"
  exit 1
fi

# Use Gemini 3 Pro Preview - latest model with improved reasoning and multimodal capabilities
MODEL="google/gemini-3-pro-preview"

echo "ðŸ¤– Sending prompt to Gemini 3 Pro via OpenRouter..."
echo "----------------------------------------------------"

# Construct the JSON payload
JSON_PAYLOAD=$(cat <<EOF
{
  "model": "$MODEL",
  "messages": [
    { "role": "user", "content": "$PROMPT" }
  ]
}
EOF
)

# Make the API call using curl
RESPONSE=$(curl -s -X POST "https://openrouter.ai/api/v1/chat/completions" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $OPENROUTER_API_KEY" \
  -d "$JSON_PAYLOAD")

# Check for errors in the response
if echo "$RESPONSE" | grep -q '"error"'; then
  echo "Error from OpenRouter API:"
  echo "$RESPONSE" | python3 -m json.tool
  exit 1
fi

# Extract and print the content
# Using python to parse JSON is more robust than jq/grep which might not be installed
ASSISTANT_RESPONSE=$(echo "$RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['choices'][0]['message']['content'])")

echo -e "\nðŸ’Ž Gemini's Response:"
echo "----------------------------------------------------"
echo "$ASSISTANT_RESPONSE"
