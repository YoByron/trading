# Heartbeat Alert System - Quick Start

## What It Does

Monitors the trading scheduler's heartbeat and alerts when it becomes unresponsive.

- ✅ Checks if `data/scheduler_heartbeat.json` is fresh (< 2 hours old)
- ✅ Only alerts during market hours (Mon-Fri 9:30 AM - 4:00 PM ET)
- ✅ Sends alerts via email, Slack, Discord, SMS (configurable)
- ✅ Creates GitHub issues for visibility
- ✅ Auto-closes issues when resolved

## Quick Usage

```bash
# Basic check
python3 scripts/heartbeat_alert.py

# Dry run (no alerts sent)
python3 scripts/heartbeat_alert.py --dry-run

# Force check outside market hours
python3 scripts/heartbeat_alert.py --force

# Custom threshold (90 minutes instead of default 120)
python3 scripts/heartbeat_alert.py --threshold 90
```

## GitHub Actions

The system runs automatically:
- **When**: Every hour during market hours
- **Where**: `.github/workflows/heartbeat-alert.yml`
- **Alerts**: Creates GitHub issues on failures

Manual trigger:
```bash
gh workflow run heartbeat-alert.yml
```

## Alert Configuration

Set these GitHub Secrets to enable alerts:

| Channel | Required Secrets |
|---------|------------------|
| Slack | `SLACK_WEBHOOK_URL` |
| Discord | `DISCORD_WEBHOOK_URL` |
| Email | `SMTP_HOST`, `SMTP_USER`, `SMTP_PASS`, `ALERT_EMAIL_TO` |
| SMS | `TWILIO_ACCOUNT_SID`, `TWILIO_AUTH_TOKEN`, `TWILIO_FROM_NUMBER`, `TWILIO_TO_NUMBER` |

## Troubleshooting

### "Heartbeat file not found"

```bash
# Trigger scheduler to create file
gh workflow run scheduler-heartbeat.yml

# Verify file exists
cat data/scheduler_heartbeat.json
```

### "Heartbeat is STALE"

```bash
# Check recent runs
gh run list --workflow=scheduler-heartbeat.yml --limit 10

# Manually trigger
gh workflow run scheduler-heartbeat.yml

# View logs
gh run view --log
```

### No alerts received

```bash
# Check environment variables
env | grep -E 'SLACK|DISCORD|SMTP|TWILIO'

# Test alert system
python3 -c "from src.safety.emergency_alerts import get_alerts; get_alerts().send_alert('Test', 'Testing', 'high')"
```

## Files

- **Script**: `scripts/heartbeat_alert.py` - Python script
- **Workflow**: `.github/workflows/heartbeat-alert.yml` - GitHub Actions
- **Heartbeat**: `data/scheduler_heartbeat.json` - Generated by scheduler
- **Alert Log**: `data/heartbeat_alerts.json` - Alert history
- **Docs**: `docs/heartbeat-alerting.md` - Full documentation

## Exit Codes

- `0` = Healthy or skipped (outside market hours)
- `1` = Critical (stale or missing heartbeat)

## See Also

- **Full Documentation**: `docs/heartbeat-alerting.md`
- **Emergency Alerts**: `src/safety/emergency_alerts.py`
- **Market Hours**: `src/utils/market_hours.py`
- **Health Monitor**: `scripts/health_monitor.py`
