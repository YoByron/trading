# Dockerfile for Dialogflow Webhook
# Minimal dependencies for fast deployment (~2 min vs ~10 min)
FROM python:3.11-slim

# Cache bust to force fresh build on deploy
ARG CACHE_BUST=1

WORKDIR /app

# Install ONLY what webhook actually needs (no chromadb/sentence-transformers)
# This reduces build time from ~10 min to ~2 min
# ChromaDB was REMOVED per CLAUDE.md directive (Jan 7, 2026)
RUN pip install --no-cache-dir \
    fastapi==0.128.0 \
    uvicorn==0.40.0 \
    requests==2.32.5

# Create required package structure
RUN mkdir -p src/agents src/rag rag_knowledge/lessons_learned data

# Create __init__.py files for Python packages
RUN touch src/__init__.py src/agents/__init__.py src/rag/__init__.py

# Copy only required source files
COPY src/agents/dialogflow_webhook.py src/agents/
COPY src/rag/ src/rag/
COPY rag_knowledge/lessons_learned/ rag_knowledge/lessons_learned/

# Copy system state for portfolio data (fallback to GitHub raw if stale)
COPY data/system_state.json data/

# Expose port
EXPOSE 8080

# Run webhook
CMD ["python", "-m", "uvicorn", "src.agents.dialogflow_webhook:app", "--host", "0.0.0.0", "--port", "8080"]
