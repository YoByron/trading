LESSON LEARNED: Sharpe Ratio Calculation Vulnerability
DATE: 2025-12-11
SEVERITY: HIGH
CATEGORY: BACKTESTING, METRICS

Description:
A critical bug was found in the `BenchmarkComparator._calculate_sharpe` method where a division by zero occurred when the standard deviation of returns was exactly zero. This happens when an asset or strategy has constant returns (or no variance) over the period.

Impact:
Backtests failed or produced runtime errors when comparing against low-volatility benchmarks or in specific theoretical edge cases.

Solution:
Always check if `std_return == 0` before dividing.
- If mean return > 0 and std == 0, the Sharpe ratio is theoretically infinite. Return a large capped value (e.g., 100.0).
- If mean return < 0 and std == 0, return a large negative value (e.g., -100.0).
- If mean return == 0 and std == 0, return 0.0.

Tests:
Added unit tests in `tests/test_benchmark_comparison.py` to specifically cover:
- Zero variance with positive return
- Zero variance with negative return
- Zero variance with zero return

Prevention:
When implementing financial metrics (Sharpe, Sortino, etc.), always handle the denominator=0 case explicitly. Do not assume variance > 0 even for market data.
