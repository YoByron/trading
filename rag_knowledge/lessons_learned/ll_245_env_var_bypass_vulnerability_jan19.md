# LL-245: Environment Variable Bypass Vulnerability

**Date**: 2026-01-19
**Category**: Security, Adversarial Audit
**Severity**: CRITICAL

## Summary

Adversarial audit discovered that position limits could be bypassed via environment variables, violating Phil Town Rule #1.

## Vulnerability

In `src/safety/mandatory_trade_gate.py`:
```python
# VULNERABLE CODE (FIXED)
MAX_POSITION_PCT = float(os.getenv("MAX_POSITION_PCT", "0.05"))
```

This allowed:
- Setting `MAX_POSITION_PCT=1.0` to allow 100% position sizes
- Setting `MAX_DAILY_LOSS_PCT=1.0` to disable loss limits
- Complete bypass of CLAUDE.md 5% rule

## Impact

An attacker (or misconfigured CI) could:
1. Bypass 5% position limit → Risk 100% of account on single trade
2. Bypass daily loss limit → No stop on losing days
3. Violate Phil Town Rule #1 programmatically

## Fix Applied

```python
# SECURE CODE
from src.constants.trading_thresholds import PositionSizing
MAX_POSITION_PCT = PositionSizing.MAX_POSITION_PCT  # HARDCODED 5%
```

- Removed env var override
- Import from central constants module
- Fallback is HARDCODED, not env var

## Prevention

1. **Never allow env vars to override safety limits**
2. **Centralize constants in single module**
3. **Adversarial audits should check env var surfaces**

## Related

- LL-244: Adversarial audit findings
- CLAUDE.md: 5% position limit rule
- Phil Town Rule #1: Don't lose money

## Tags

`security`, `critical`, `env-var-bypass`, `position-limit`, `rule-1`
