# Trading System Operations Runbook

**Last Updated:** 2025-12-03
**Maintained By:** Trading System Ops Team

## Table of Contents
- [System Overview](#system-overview)
- [Environments](#environments)
- [Daily Operations](#daily-operations)
- [Emergency Procedures](#emergency-procedures)
- [Monitoring & Alerts](#monitoring--alerts)
- [Common Issues](#common-issues)
- [Deployment](#deployment)
- [Rollback Procedures](#rollback-procedures)

---

## System Overview

### Architecture
```
GitHub Actions (Scheduler)
    ↓
scripts/autonomous_trader.py
    ↓
TradingOrchestrator (Hybrid Funnel)
    ├── Gate 1: MomentumAgent
    ├── Gate 2: RLFilter
    ├── Gate 3: LangChainSentimentAgent
    └── Gate 4: RiskManager
        ↓
    AlpacaExecutor
        ↓
    Alpaca Broker (Paper/Live)
```

### Key Components
- **Entry Point**: `scripts/autonomous_trader.py`
- **Orchestrator**: `src/orchestrator/main.py`
- **Risk Management**: `src/core/risk_manager.py`
- **Data Pipeline**: `src/utils/market_data.py`
- **Telemetry**: `data/audit_trail/hybrid_funnel_runs.jsonl`

---

## Environments

### 1. Research Mode
**Purpose**: Notebook experiments, data exploration, strategy development

**Characteristics**:
- No trading execution
- Can break things freely
- Used in `notebooks/` directory
- No production data dependencies

**How to Use**:
```bash
cd notebooks
jupyter notebook
```

---

### 2. Paper Trading Mode (Current)
**Purpose**: 90-day R&D validation before live trading

**Characteristics**:
- Trades with simulated money ($100k starting capital)
- Real market data from Alpaca
- All strategies and risk controls active
- Runs on schedule via GitHub Actions
- Logs all trades to audit trail

**Configuration**:
```bash
# .env file
ALPACA_API_KEY=your_paper_key
ALPACA_SECRET_KEY=your_paper_secret
PAPER_TRADING=true
DAILY_INVESTMENT=10.0
```

**How to Run**:
```bash
# Manual execution
export PAPER_TRADING=true
export ALPACA_SIMULATED=1  # Use local simulator for testing
PYTHONPATH=src python3 scripts/autonomous_trader.py

# Check paper trading status
python3 scripts/check_positions.py
```

**Scheduled Execution**:
- **GitHub Actions**: Weekdays 9:35 AM EST
- Workflow file: `.github/workflows/daily-trading.yml`
- View logs: GitHub → Actions → Daily Trading

**Success Criteria** (before advancing to live):
- [ ] 90+ days of paper trading
- [ ] Overall return >5%
- [ ] Max drawdown <10%
- [ ] Win rate >60%
- [ ] Sharpe ratio >1.5
- [ ] No critical errors or bugs
- [ ] Promotion gate passes: `python3 scripts/enforce_promotion_gate.py`

---

### 3. Live Trading Mode
**Purpose**: Real money trading after paper trading validation

**Characteristics**:
- Real money at risk
- Strict risk controls enforced
- PDT protection active (requires $25k+ equity)
- Manual approval gate before deployment
- Kill-switch available

**⚠️ CURRENT STATUS**: **NOT ACTIVE** - Currently in paper trading R&D phase

**Configuration** (when live):
```bash
# .env file
ALPACA_API_KEY=your_live_key
ALPACA_SECRET_KEY=your_live_secret
PAPER_TRADING=false  # ⚠️ DANGER: Real money!
DAILY_INVESTMENT=10.0  # Real dollars per day
```

**Pre-Live Checklist**:
- [ ] Paper trading success criteria met
- [ ] All tests passing: `python3 -m pytest tests/`
- [ ] Promotion gate passes: `python3 scripts/enforce_promotion_gate.py`
- [ ] Risk limits configured and tested
- [ ] PDT restrictions understood (need $25k+ for unlimited day trading)
- [ ] Kill-switch tested: `./stop-trading-system.sh`
- [ ] Backup capital reserved (don't trade money you can't lose)
- [ ] CEO approval obtained

**How to Deploy to Live** (NOT YET):
```bash
# 1. Verify paper trading success
python3 scripts/enforce_promotion_gate.py

# 2. Update environment to live keys
# Edit .env file manually (NEVER commit live keys to git)

# 3. Set PAPER_TRADING=false
export PAPER_TRADING=false

# 4. Test with small position
export DAILY_INVESTMENT=1.0  # Start with $1/day
PYTHONPATH=src python3 scripts/autonomous_trader.py

# 5. Monitor closely for first week
# Check positions every hour
python3 scripts/check_positions.py

# 6. Gradually scale up if successful
export DAILY_INVESTMENT=2.0  # Fibonacci scaling: 1, 2, 3, 5, 8...
```

---

## Daily Operations

### Morning Checklist (Weekdays 9:00 AM EST)
1. **Check System Health**
   ```bash
   python3 scripts/check_positions.py
   python3 scripts/generate_telemetry_report.py
   ```

2. **Review Overnight Performance**
   ```bash
   tail -100 data/audit_trail/hybrid_funnel_runs.jsonl
   ```

3. **Verify GitHub Actions Status**
   - Go to GitHub → Actions
   - Confirm "Daily Trading" workflow ran successfully
   - Check for any error notifications

4. **Check Risk Limits**
   - Verify no circuit breakers triggered
   - Confirm daily loss within limits
   - Check consecutive loss count

### Post-Trading Checklist (Weekdays 10:00 AM EST)
1. **Generate Daily Report**
   ```bash
   # Auto-generated by system
   ls -lrt reports/daily_report_*.txt | tail -1
   ```

2. **Review Trades**
   - Check `data/audit_trail/hybrid_funnel_runs.jsonl`
   - Verify all trades within risk limits
   - Confirm gate logic worked correctly

3. **Update Metrics**
   - Sharpe ratio trending
   - Win rate progress
   - Drawdown status
   - Progress toward $100/day target

### Weekly Checklist (Fridays)
1. **Backtest Current Strategy**
   ```bash
   python3 scripts/run_backtest_matrix.py --config config/backtest_scenarios.yaml
   ```

2. **Review Strategy Registry**
   ```bash
   PYTHONPATH=src python3 src/strategies/strategy_registry.py report
   ```

3. **Check for Stale Branches**
   ```bash
   git branch -r | grep -v main
   ```

4. **Review Open PRs**
   ```bash
   gh pr list --state open
   ```

5. **Update Target Model Progress**
   ```bash
   PYTHONPATH=src python3 src/analytics/target_model.py
   ```

---

## Emergency Procedures

### Kill-Switch: Stop All Trading Immediately
```bash
# Stop trading system
./stop-trading-system.sh

# Or manually:
export TRADING_HALT=true

# Disable GitHub Actions workflow
gh workflow disable daily-trading.yml

# Close all positions (if needed)
python3 scripts/close_all_positions.py  # ⚠️ Use with caution
```

### Circuit Breaker Triggered
**Symptom**: Trading halted due to daily loss limit or drawdown

**Response**:
1. **Do NOT override circuit breaker** - It's protecting capital
2. Review what went wrong:
   ```bash
   tail -200 data/audit_trail/hybrid_funnel_runs.jsonl | grep -i "reject"
   python3 scripts/generate_telemetry_report.py
   ```
3. Check for:
   - Data quality issues
   - Gate malfunction
   - Market anomaly (flash crash, news event)
4. Fix root cause before resuming trading
5. Reset daily counters: Risk manager auto-resets at midnight

### PDT Violation Warning
**Symptom**: Daytrade count ≥ 3 and equity < $25,000

**Response**:
1. **STOP IMMEDIATELY** - PDT violation will lock account for 90 days
2. Either:
   - Reduce trading frequency to <3 day trades per 5 days
   - Increase account equity to $25,000+
3. Update config:
   ```bash
   export DAILY_INVESTMENT=0.0  # Pause trading
   ```

### Missing Data / API Failure
**Symptom**: No trades executed, "No data available" errors

**Response**:
1. Check Alpaca API status: https://status.alpaca.markets/
2. Verify API keys are valid:
   ```bash
   python3 scripts/check_alpaca_connection.py
   ```
3. Check data cache:
   ```bash
   ls -lh data/cache/
   ```
4. Fallback to yfinance if Alpaca down (automatic in most cases)

### Bad Strategy Deployed
**Symptom**: Unexpectedly poor performance, large losses

**Response**:
1. **Pause trading immediately**:
   ```bash
   ./stop-trading-system.sh
   ```
2. Rollback to last known good version (see [Rollback Procedures](#rollback-procedures))
3. Review what changed:
   ```bash
   git log --oneline -20
   git diff HEAD~5 HEAD -- src/strategies/
   ```
4. Run backtests on current code:
   ```bash
   python3 scripts/run_backtest_matrix.py
   ```
5. Fix issues before resuming

---

## Monitoring & Alerts

### Key Metrics to Watch
1. **Daily P&L** - Target: Positive, moving toward $100/day
2. **Win Rate** - Target: >60%
3. **Sharpe Ratio** - Target: >1.5
4. **Max Drawdown** - Alert if >5%, Critical if >10%
5. **Consecutive Losses** - Alert if ≥3

### Alert Triggers
- **CRITICAL**: Circuit breaker triggered, trading halted
- **WARNING**: Approaching risk limits (e.g., 2 consecutive losses)
- **INFO**: Weak signals, unusual market conditions

### Where Alerts Appear
1. Console output (if running manually)
2. GitHub Actions logs
3. Risk manager alerts in telemetry
4. Email alerts (TODO: set up email notifications)

### Setting Up Monitoring
```bash
# Check telemetry dashboard
python3 dashboard/telemetry_app.py

# Generate telemetry report
python3 scripts/generate_telemetry_report.py --output-json telemetry.json

# Monitor workflow runs
gh run list --workflow=daily-trading.yml
```

---

## Common Issues

### Issue: GitHub Actions Workflow Disabled
**Symptom**: No trades executing, workflow not running

**Solution**:
```bash
gh workflow enable daily-trading.yml
```

**Prevention**: Never manually disable workflows without documenting why

---

### Issue: Paper Trading Account Out of Sync
**Symptom**: Position count mismatch, incorrect equity

**Solution**:
```bash
# Reset paper trading account (Alpaca provides this)
# Or start fresh by changing to new paper key
```

---

### Issue: Strategy Registry Out of Date
**Symptom**: Duplicate work, unclear what strategies exist

**Solution**:
```bash
PYTHONPATH=src python3 src/strategies/strategy_registry.py report
# Update registry manually if needed
```

---

## Deployment

### Deploying New Strategy
1. **Develop in branch**:
   ```bash
   git checkout -b feature/new-strategy
   ```

2. **Register strategy**:
   ```python
   from src.strategies.strategy_registry import StrategyRegistry, StrategyRecord
   registry = StrategyRegistry()
   # ... register new strategy
   ```

3. **Backtest thoroughly**:
   ```bash
   python3 scripts/run_backtest_matrix.py --use-hybrid-gates
   ```

4. **Create PR**:
   ```bash
   gh pr create --title "feat: New strategy" --body "..."
   ```

5. **CI must pass**:
   - All tests pass
   - Backtest metrics acceptable
   - Promotion gate passes (if going to live)

6. **Merge and deploy**:
   ```bash
   gh pr merge --squash
   git checkout main
   git pull
   ```

7. **Monitor closely** for first week

---

### Updating Risk Parameters
1. Edit `src/core/risk_manager.py` or environment variables
2. Test in paper trading first
3. Create PR with justification
4. Deploy during low-volatility period (avoid market open/close)

---

## Rollback Procedures

### Emergency Rollback
```bash
# 1. Stop current trading
./stop-trading-system.sh

# 2. Identify last known good commit
git log --oneline -20

# 3. Rollback
git checkout <good_commit_hash>

# 4. Test
python3 -m pytest tests/

# 5. Resume trading
export PAPER_TRADING=true
PYTHONPATH=src python3 scripts/autonomous_trader.py
```

### Rollback Strategy Changes
```bash
# If specific strategy causing issues
git checkout HEAD~1 -- src/strategies/problematic_strategy.py
git commit -m "rollback: Revert problematic strategy"
git push
```

---

## Contacts & Escalation

**CEO (Decision Authority)**: Igor Ganapolsky
**CTO (System Owner)**: Claude AI Agent
**Broker Support**: Alpaca - support@alpaca.markets

### Escalation Path
1. **Minor issues**: Fix and document in git commit
2. **Trading halted**: Investigate, fix root cause, resume when safe
3. **Data loss/corruption**: Restore from backup, escalate to CEO
4. **Critical bug in live trading**: Kill-switch → Rollback → CEO approval to resume

---

## Appendix

### Useful Commands Reference
```bash
# Check system status
python3 scripts/check_positions.py
python3 scripts/generate_telemetry_report.py

# Run backtests
python3 scripts/run_backtest_matrix.py

# Strategy registry
PYTHONPATH=src python3 src/strategies/strategy_registry.py report

# Target model (progress to $100/day)
PYTHONPATH=src python3 src/analytics/target_model.py

# Check git status
git status
gh pr list
gh workflow list

# Stop trading
./stop-trading-system.sh

# View logs
tail -f data/audit_trail/hybrid_funnel_runs.jsonl
```

### Environment Variables Reference
```bash
# Alpaca API
ALPACA_API_KEY=<key>
ALPACA_SECRET_KEY=<secret>
PAPER_TRADING=true|false

# Trading parameters
DAILY_INVESTMENT=10.0
ALPACA_SIMULATED=1  # Use simulator instead of real API

# Risk controls
MOMENTUM_MIN_SCORE=0.0
RL_CONFIDENCE_THRESHOLD=0.6
RISK_USE_ATR_SCALING=true

# Operational
TRADING_HALT=true  # Emergency stop
```

---

**Document Version**: 1.0
**Next Review Date**: 2025-12-10
